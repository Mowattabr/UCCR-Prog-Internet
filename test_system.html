<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Login & Profile - Galaxia Magna Academy</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #1a1a1f 0%, #2d2d35 100%);
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #23232b;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.3);
    }
    .btn-primary {
      background: #f18b32;
      border-color: #f18b32;
      font-weight: bold;
    }
    .btn-primary:hover {
      background: #e07a21;
      border-color: #e07a21;
    }
    pre {
      background: #1a1a1f;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      white-space: pre-wrap;
      font-size: 12px;
    }
    .test-section {
      background: #2d2d35;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid #f18b32;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="text-center mb-4">
      <h1 style="color: #f18b32;">üß™ Test Complete System</h1>
      <p class="text-muted">Testing Login ‚Üí Session ‚Üí Profile ‚Üí Edit flow</p>
    </div>

    <div class="test-section">
      <h4 style="color: #f18b32;">Step 1: Quick Login with Allan Admin</h4>
      <div class="mb-3">
        <input type="text" id="test-email" class="form-control" value="allan.villalobos.calderon@gmail.com" placeholder="Email">
      </div>
      <div class="mb-3">
        <input type="password" id="test-password" class="form-control" placeholder="Password">
      </div>
      <button class="btn btn-primary" onclick="testLogin()">üîê Test Login</button>
      <div id="login-result" style="margin-top: 10px;"></div>
    </div>

    <div class="test-section">
      <h4 style="color: #f18b32;">Step 2: Check Session Data</h4>
      <button class="btn btn-info" onclick="checkSession()">üì± Check Current Session</button>
      <pre id="session-display">No session data</pre>
    </div>

    <div class="test-section">
      <h4 style="color: #f18b32;">Step 3: Quick Actions</h4>
      <button class="btn btn-success me-2" onclick="window.open('profile.html', '_blank')">üë§ Open Profile</button>
      <button class="btn btn-warning me-2" onclick="clearSession()">üóëÔ∏è Clear Session</button>
      <button class="btn btn-secondary" onclick="window.open('index.html', '_blank')">üè† Go to Login Page</button>
    </div>

  </div>

  <script>
    async function testLogin() {
      const email = document.getElementById('test-email').value;
      const password = document.getElementById('test-password').value;
      
      if (!email || !password) {
        document.getElementById('login-result').innerHTML = '<div class="alert alert-danger">Please enter email and password</div>';
        return;
      }
      
      document.getElementById('login-result').innerHTML = '<div class="alert alert-info">Testing login...</div>';
      
      try {
        const searchUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?or=(email.eq.${encodeURIComponent(email)},codigo_usuario.eq.${encodeURIComponent(email)})`;
        
        const response = await fetch(searchUrl, {
          method: 'GET',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const users = await response.json();
          
          if (users && users.length > 0) {
            const user = users[0];
            
            if (user.password && user.password === password) {
              // Save complete session like the fixed login
              const sessionData = {
                username: user.username,
                email: user.email,
                rol: user.rol,
                codigo: user.codigo_usuario,
                telefono: user.telefono,
                genero: user.genero,
                intereses: user.intereses,
                fecha_nacimiento: user.fecha_nacimiento,
                fecha_inscripcion: user.fecha_inscripcion,
                fromDatabase: true,
                databaseId: user.id || null
              };
              
              localStorage.setItem('currentUser', JSON.stringify(sessionData));
              
              document.getElementById('login-result').innerHTML = '<div class="alert alert-success">‚úÖ Login successful! Complete data saved to session.</div>';
              
              // Auto-check session
              setTimeout(checkSession, 500);
              
            } else {
              document.getElementById('login-result').innerHTML = '<div class="alert alert-danger">‚ùå Wrong password</div>';
            }
          } else {
            document.getElementById('login-result').innerHTML = '<div class="alert alert-danger">‚ùå User not found</div>';
          }
        } else {
          document.getElementById('login-result').innerHTML = '<div class="alert alert-danger">‚ùå Database connection error</div>';
        }
        
      } catch (error) {
        document.getElementById('login-result').innerHTML = '<div class="alert alert-danger">‚ùå Error: ' + error.message + '</div>';
      }
    }
    
    function checkSession() {
      const sessionData = localStorage.getItem('currentUser');
      const display = document.getElementById('session-display');
      
      if (sessionData) {
        try {
          const parsed = JSON.parse(sessionData);
          display.textContent = JSON.stringify(parsed, null, 2);
        } catch (e) {
          display.textContent = 'Error parsing session: ' + sessionData;
        }
      } else {
        display.textContent = 'No session data found';
      }
    }
    
    function clearSession() {
      localStorage.removeItem('currentUser');
      document.getElementById('session-display').textContent = 'Session cleared';
      document.getElementById('login-result').innerHTML = '<div class="alert alert-info">Session cleared</div>';
    }
    
    // Auto-check session on load
    document.addEventListener('DOMContentLoaded', checkSession);
  </script>
</body>
</html>
