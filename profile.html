<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Perfil - Galaxia Magna Academy</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>

  <!-- HEADER -->
  <header>
    <img src="images/GAM_transparent.png" alt="Galaxia Magna Academy Logo" style="width: 80px; height: 80px; object-fit: contain;">
    <div class="header-text">
      <h1>Mi Perfil</h1>
      <h2 style="font-size: 1.5em;">Galaxia Magna Academy</h2>
    </div>
    <img src="images/GAM_transparent.png" alt="GMA Logo" style="width: 80px; height: 80px; object-fit: contain;">
  </header>

  <main>
    <!-- Navigation -->
    <nav class="profile-nav">
      <ul>
        <li><a href="index.html">‚Üê Volver al Inicio</a></li>
        <li><a href="registro.html">Formulario de Registro</a></li>
      </ul>
    </nav>

    <!-- Message Area -->
    <div id="message-area" style="display: none; max-width: 800px; margin: 20px auto; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold;"></div>

    <!-- User Profile Section -->
    <section style="max-width: 800px; margin: 40px auto; padding: 40px 20px; background: #23232b; border-radius: 12px; box-shadow: 0 4px 24px #0008; color: #fff;">
      
      <!-- Profile Header -->
      <div style="text-align: center; margin-bottom: 30px;">
        <div id="avatar-container" style="margin-bottom: 20px;">
          <img id="user-avatar" src="images/Male.png" alt="Avatar" style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid #f18b32; object-fit: cover;">
        </div>
        <h2 id="user-display-name" style="color: #f18b32; margin-bottom: 10px;">Cargando...</h2>
        <p id="user-role" style="color: #c9c9c9; margin-bottom: 0;">Rol: Cargando...</p>
        <p id="user-code" style="color: #c9c9c9; font-size: 0.9em;">C√≥digo: Cargando...</p>
      </div>

      <!-- Profile Information -->
      <div class="profile-info">
        
        <!-- Name Field -->
        <div class="profile-field" style="margin-bottom: 25px; padding: 20px; background: #2d2d35; border-radius: 8px; position: relative;">
          <label style="color: #f18b32; font-weight: bold; display: block; margin-bottom: 8px;">
            <i class="fas fa-user" style="margin-right: 8px;"></i>Nombre Completo
          </label>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <span id="name-display" style="color: #fff; font-size: 1.1em;">Cargando...</span>
            <i class="fas fa-pen edit-icon" onclick="editField('name')" style="color: #f18b32; cursor: pointer; font-size: 1.2em;" title="Editar nombre"></i>
          </div>
          <input type="text" id="name-edit" style="display: none; width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #4a4a55; border-radius: 4px; background: #1a1a1f; color: #fff;">
          <div style="display: none; margin-top: 10px;" id="name-buttons">
            <button onclick="saveField('name')" style="background: #22c55e; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">Guardar</button>
            <button onclick="cancelEdit('name')" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Cancelar</button>
          </div>
        </div>

        <!-- Email Field -->
        <div class="profile-field" style="margin-bottom: 25px; padding: 20px; background: #2d2d35; border-radius: 8px; position: relative;">
          <label style="color: #f18b32; font-weight: bold; display: block; margin-bottom: 8px;">
            <i class="fas fa-envelope" style="margin-right: 8px;"></i>Email
          </label>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <span id="email-display" style="color: #fff; font-size: 1.1em;">Cargando...</span>
            <i class="fas fa-pen edit-icon" onclick="editField('email')" style="color: #f18b32; cursor: pointer; font-size: 1.2em;" title="Editar email"></i>
          </div>
          <input type="email" id="email-edit" style="display: none; width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #4a4a55; border-radius: 4px; background: #1a1a1f; color: #fff;">
          <div style="display: none; margin-top: 10px;" id="email-buttons">
            <button onclick="saveField('email')" style="background: #22c55e; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">Guardar</button>
            <button onclick="cancelEdit('email')" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Cancelar</button>
          </div>
        </div>

        <!-- Phone Field -->
        <div class="profile-field" style="margin-bottom: 25px; padding: 20px; background: #2d2d35; border-radius: 8px; position: relative;">
          <label style="color: #f18b32; font-weight: bold; display: block; margin-bottom: 8px;">
            <i class="fas fa-phone" style="margin-right: 8px;"></i>Tel√©fono
          </label>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <span id="telefono-display" style="color: #fff; font-size: 1.1em;">Cargando...</span>
            <i class="fas fa-pen edit-icon" onclick="editField('telefono')" style="color: #f18b32; cursor: pointer; font-size: 1.2em;" title="Editar tel√©fono"></i>
          </div>
          <input type="tel" id="telefono-edit" style="display: none; width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #4a4a55; border-radius: 4px; background: #1a1a1f; color: #fff;">
          <div style="display: none; margin-top: 10px;" id="telefono-buttons">
            <button onclick="saveField('telefono')" style="background: #22c55e; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">Guardar</button>
            <button onclick="cancelEdit('telefono')" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Cancelar</button>
          </div>
        </div>

        <!-- Gender Field -->
        <div class="profile-field" style="margin-bottom: 25px; padding: 20px; background: #2d2d35; border-radius: 8px; position: relative;">
          <label style="color: #f18b32; font-weight: bold; display: block; margin-bottom: 8px;">
            <i class="fas fa-venus-mars" style="margin-right: 8px;"></i>G√©nero
          </label>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <span id="genero-display" style="color: #fff; font-size: 1.1em;">Cargando...</span>
            <i class="fas fa-pen edit-icon" onclick="editField('genero')" style="color: #f18b32; cursor: pointer; font-size: 1.2em;" title="Editar g√©nero"></i>
          </div>
          <select id="genero-edit" style="display: none; width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #4a4a55; border-radius: 4px; background: #1a1a1f; color: #fff;">
            <option value="m">Masculino</option>
            <option value="f">Femenino</option>
            <option value="o">Otro</option>
            <option value="n">Prefiero no decir</option>
          </select>
          <div style="display: none; margin-top: 10px;" id="genero-buttons">
            <button onclick="saveField('genero')" style="background: #22c55e; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">Guardar</button>
            <button onclick="cancelEdit('genero')" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Cancelar</button>
          </div>
        </div>

        <!-- Interests Field -->
        <div class="profile-field" style="margin-bottom: 25px; padding: 20px; background: #2d2d35; border-radius: 8px; position: relative;">
          <label style="color: #f18b32; font-weight: bold; display: block; margin-bottom: 8px;">
            <i class="fas fa-heart" style="margin-right: 8px;"></i>Club
          </label>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <span id="intereses-display" style="color: #fff; font-size: 1.1em;">Cargando...</span>
            <i class="fas fa-pen edit-icon" onclick="editField('intereses')" style="color: #f18b32; cursor: pointer; font-size: 1.2em;" title="Editar club"></i>
          </div>
          <div id="intereses-edit" style="display: none; margin-top: 15px;">
            <select id="intereses-input" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em;">
              <option value="ajedrez">Club de Ajedrez</option>
              <option value="arte">Club de Arte</option>
              <option value="deportes">Club de Deportes</option>
              <option value="idiomas">Club de Idiomas</option>
              <option value="matematica">Club de Matem√°tica</option>
              <option value="musica">Club de M√∫sica</option>
              <option value="programacion">Club de Programaci√≥n</option>
              <option value="starwars">Club Star Wars</option>
              <option value="otro">Otro club</option>
              <option value="ninguno">No estoy interesado</option>
            </select>
          </div>
          <div style="display: none; margin-top: 10px;" id="intereses-buttons">
            <button onclick="saveField('intereses')" style="background: #22c55e; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">Guardar</button>
            <button onclick="cancelEdit('intereses')" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Cancelar</button>
          </div>
        </div>

        <!-- Read-only fields -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
          
          <!-- Birth Date -->
          <div style="padding: 15px; background: #1a1a1f; border-radius: 8px; border-left: 4px solid #f18b32;">
            <label style="color: #f18b32; font-weight: bold; display: block; margin-bottom: 5px;">
              <i class="fas fa-calendar" style="margin-right: 8px;"></i>Fecha de Nacimiento
            </label>
            <span id="fecha-nacimiento-display" style="color: #c9c9c9;">Cargando...</span>
          </div>

          <!-- Registration Date -->
          <div style="padding: 15px; background: #1a1a1f; border-radius: 8px; border-left: 4px solid #f18b32;">
            <label style="color: #f18b32; font-weight: bold; display: block; margin-bottom: 5px;">
              <i class="fas fa-clock" style="margin-right: 8px;"></i>Fecha de Inscripci√≥n
            </label>
            <span id="fecha-inscripcion-display" style="color: #c9c9c9;">Cargando...</span>
          </div>

          <!-- Credits Obtained -->
          <div style="padding: 15px; background: #1a1a1f; border-radius: 8px; border-left: 4px solid #f18b32;">
            <label style="color: #f18b32; font-weight: bold; display: block; margin-bottom: 5px;">
              <i class="fas fa-medal" style="margin-right: 8px;"></i>Cr√©ditos Obtenidos
            </label>
            <span id="creditos-obtenidos-display" style="color: #c9c9c9;">Cargando...</span>
          </div>
          
        </div>

      </div>

      <!-- Admin Panel (only visible for administrators) -->
      <div id="admin-panel" style="display: none; margin-top: 30px; padding: 30px; background: #1a1a1f; border-radius: 12px; border: 2px solid #ef4444;">
        <h3 style="color: #ef4444; margin-bottom: 20px; text-align: center;">
          <i class="fas fa-shield-alt" style="margin-right: 8px;"></i>Panel de Administrador
        </h3>
        <p style="color: #c9c9c9; text-align: center; margin-bottom: 25px;">
          Acceso completo a la gesti√≥n del sistema acad√©mico
        </p>
        
        <div class="row">
          <div class="col-md-6">
            <div style="background: #23232b; border-radius: 8px; padding: 20px; margin-bottom: 15px; border: 1px solid #4a4a55; text-align: center;">
              <i class="fas fa-book" style="color: #22c55e; font-size: 2.5em; margin-bottom: 15px;"></i>
              <h4 style="color: #22c55e; margin-bottom: 10px;">Gesti√≥n de Cursos</h4>
              <p style="color: #c9c9c9; margin-bottom: 15px; font-size: 0.9em;">
                Administrar el cat√°logo completo de cursos acad√©micos
              </p>
              <a href="admin_cursos.html" style="background: #22c55e; color: white; text-decoration: none; padding: 10px 20px; border-radius: 6px; display: inline-block; font-weight: bold;">
                <i class="fas fa-cogs"></i> Administrar Cursos
              </a>
            </div>
          </div>
          
          <div class="col-md-6">
            <div style="background: #23232b; border-radius: 8px; padding: 20px; margin-bottom: 15px; border: 1px solid #4a4a55; text-align: center;">
              <i class="fas fa-users" style="color: #3b82f6; font-size: 2.5em; margin-bottom: 15px;"></i>
              <h4 style="color: #3b82f6; margin-bottom: 10px;">Gesti√≥n de Usuarios</h4>
              <p style="color: #c9c9c9; margin-bottom: 15px; font-size: 0.9em;">
                Administrar estudiantes, profesores y administradores
              </p>
              <a href="admin_lista_usuarios.html" style="background: #3b82f6; color: white; text-decoration: none; padding: 10px 20px; border-radius: 6px; display: inline-block; font-weight: bold;">
                <i class="fas fa-users-cog"></i> Administrar Usuarios
              </a>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-12">
            <div style="background: #23232b; border-radius: 8px; padding: 20px; border: 1px solid #4a4a55; text-align: center;">
              <i class="fas fa-user-plus" style="color: #f59e0b; font-size: 2em; margin-bottom: 10px;"></i>
              <h5 style="color: #f59e0b; margin-bottom: 10px;">Registro de Nuevos Usuarios</h5>
              <p style="color: #c9c9c9; margin-bottom: 15px; font-size: 0.9em;">
                Crear nuevos usuarios en el sistema (estudiantes, profesores, administradores)
              </p>
              <a href="registro.html" style="background: #f59e0b; color: white; text-decoration: none; padding: 8px 16px; border-radius: 6px; display: inline-block; font-weight: bold;">
                <i class="fas fa-plus"></i> Registrar Usuario
              </a>
            </div>
          </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #4a4a55;">
          <p style="color: #6b7280; font-size: 0.9em; margin: 0;">
            <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
            Solo los administradores pueden acceder a estas funciones
          </p>
        </div>
      </div>

    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let currentUserData = null;
    let originalValues = {};

    // Comprehensive debug function for browser console
    window.debugProfileIssue = async function() {
      console.log('üîç === COMPREHENSIVE PROFILE DEBUG ===');
      
      // Step 1: Check current user data
      console.log('\nüìä STEP 1: Current User Data');
      console.log('User data exists:', !!currentUserData);
      if (currentUserData) {
        console.log('Email:', currentUserData.email);
        console.log('Username:', currentUserData.username);
        console.log('Interests:', currentUserData.intereses);
        console.log('Full data:', currentUserData);
      } else {
        console.log('‚ùå No current user data loaded');
        return;
      }
      
      // Step 2: Test database connection
      console.log('\nüîó STEP 2: Database Connection Test');
      const testResult = await testDatabaseConnection();
      console.log('Test result:', testResult);
      
      // Step 3: Try a test update
      console.log('\nüß™ STEP 3: Test Update');
      try {
        const result = await updateUserField('intereses', 'programacion');
        console.log('Update result:', result);
      } catch (error) {
        console.error('Update error:', error);
      }
      
      console.log('\n‚úÖ Debug complete - check results above');
    };

    // Load guest user with GUEST_2025 code for console access
    window.loadGuest2025 = function() {
      return loadGuestUser2025();
    };

    // Test club saving for guest user
    window.testGuestClubSave = async function(clubValue = 'programacion') {
      console.log('üß™ Testing guest club save with:', clubValue);
      
      if (!currentUserData) {
        console.log('‚ùå No user data, loading guest first...');
        loadGuestUser2025();
      }
      
      console.log('üë§ Current user:', currentUserData);
      console.log('üéØ Testing club save...');
      
      const result = await updateUserField('intereses', clubValue);
      console.log('üìã Save result:', result);
      
      console.log('üìä Updated user data:', currentUserData);
      console.log('üñ•Ô∏è Display element text:', document.getElementById('intereses-display').textContent);
      
      return result;
    };

    // Test database with any email
    window.testDBWithEmail = async function(email) {
      console.log('üß™ Testing database with email:', email);
      const testUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email=eq.${encodeURIComponent(email)}`;
      console.log('üîó URL:', testUrl);
      
      try {
        const response = await fetch(testUrl, {
          method: 'GET',
          headers: {
            'apikey': SUPABASE_API_KEY,
            'Authorization': `Bearer ${SUPABASE_API_KEY}`,
            'Content-Type': 'application/json'
          }
        });
        
        console.log('Response status:', response.status);
        if (response.ok) {
          const data = await response.json();
          console.log('Found users:', data.length);
          console.log('User data:', data);
          return data;
        } else {
          const errorText = await response.text();
          console.error('Error response:', errorText);
          return null;
        }
      } catch (error) {
        console.error('Network error:', error);
        return null;
      }
    };

    // Load user data on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadUserData();
    });

    // Simple logging function
    
    // Quick test function for club saving
    async function testClubSave() {
      console.log('üß™ Testing club save...');
      if (!currentUserData || !currentUserData.email) {
        console.error('‚ùå No user data for testing');
        return;
      }
      
      const testClub = 'ajedrez';
      console.log('üß™ Testing with club value:', testClub);
      
      const result = await updateUserField('intereses', testClub);
      
      if (result) {
        console.log('‚úÖ Club test successful!');
        showMessage('‚úÖ Test de club exitoso!', 'success');
      } else {
        console.log('‚ùå Club test failed!');
        showMessage('‚ùå Test de club fall√≥', 'error');
      }
    }

    // Debug user type and data source
    function debugUserType() {
      console.log('üîç === USER TYPE ANALYSIS ===');
      
      const sessionData = localStorage.getItem('currentUser');
      console.log('üì± Session data exists:', !!sessionData);
      
      if (sessionData) {
        const parsedSession = JSON.parse(sessionData);
        console.log('üì± Session user:', parsedSession);
        console.log('üì± Session rol:', parsedSession.rol);
        console.log('üì± Session interests:', parsedSession.intereses);
      }
      
      console.log('üíæ Current user data exists:', !!currentUserData);
      
      if (currentUserData) {
        console.log('üíæ Database user:', currentUserData);
        console.log('üíæ Database interests:', currentUserData.intereses);
        console.log('üíæ Database interests type:', typeof currentUserData.intereses);
        console.log('üíæ User email:', currentUserData.email);
      }
      
      console.log('üîÑ Data source: ', currentUserData ? 'Database' : 'Session');
      console.log('=== END ANALYSIS ===');
      
      showMessage('üîç An√°lisis completado - revisar consola', 'info');
    }

    // Load guest user with GUEST_2025 code
    function loadGuestUser2025() {
      console.log('üëª Loading Guest User GUEST_2025...');
      
      const guestData = {
        username: 'Usuario Invitado',
        email: 'guest@galaxiamagna.edu',
        telefono: '',
        genero: 'n',
        intereses: 'programacion',
        fecha_nacimiento: '2000-01-01',
        fecha_inscripcion: new Date().toISOString().split('T')[0],
        rol: 'invitado',
        codigo_usuario: 'GUEST_2025',
        creditos_obtenidos: 'Sin cr√©ditos registrados',
        estado: 'activo'  // Not displayed but included for completeness
      };
      
      // Set as current user
      currentUserData = guestData;
      
      // Update localStorage
      localStorage.setItem('currentUser', JSON.stringify({
        username: guestData.username,
        email: guestData.email,
        rol: guestData.rol,
        codigo: guestData.codigo_usuario,
        intereses: guestData.intereses,
        creditos_obtenidos: guestData.creditos_obtenidos
      }));
      
      // Display the data
      displayUserData(currentUserData);
      
      console.log('‚úÖ Guest User GUEST_2025 loaded successfully');
      showMessage('üëª Usuario Invitado GUEST_2025 cargado - cambios solo en memoria', 'info');
      
      return guestData;
    }

    // Simulate guest mode to test interests functionality
    function simulateGuestMode() {
      console.log('üëª SIMULATING GUEST MODE...');
      
      // Save current state
      const originalUserData = currentUserData;
      
      // Use the new guest loader
      loadGuestUser2025();
      
      console.log('üëª Guest mode simulated. Try editing interests now!');
      
      // Auto-restore after 30 seconds
      setTimeout(() => {
        console.log('üîÑ Restoring original user data...');
        currentUserData = originalUserData;
        loadUserData();
        showMessage('üîÑ Usuario original restaurado', 'info');
      }, 30000);
    }

    // Comprehensive database issue diagnosis
    async function debugDatabaseIssue() {
      console.log('üö® === COMPREHENSIVE DATABASE DIAGNOSIS ===');
      
      if (!currentUserData || !currentUserData.email) {
        console.error('‚ùå No user data for diagnosis');
        showMessage('‚ùå No hay datos de usuario para diagnosticar', 'error');
        return;
      }
      
      const userEmail = currentUserData.email;
      console.log('üìß Testing with user email:', userEmail);
      
      // Step 1: Test basic database connection
      console.log('\nüîç STEP 1: Testing basic database connection...');
      try {
        const basicResponse = await fetch('https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/', {
          method: 'GET',
          headers: {
            'apikey': SUPABASE_API_KEY,
            'Authorization': `Bearer ${SUPABASE_API_KEY}`,
          }
        });
        console.log('‚úÖ Basic connection status:', basicResponse.status);
      } catch (error) {
        console.error('‚ùå Basic connection failed:', error);
        showMessage('‚ùå Fallo en conexi√≥n b√°sica', 'error');
        return;
      }
      
      // Step 2: Test user lookup
      console.log('\nüîç STEP 2: Testing user lookup...');
      const searchUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email=eq.${encodeURIComponent(userEmail)}`;
      console.log('üîó Search URL:', searchUrl);
      
      try {
        const userResponse = await fetch(searchUrl, {
          method: 'GET',
          headers: {
            'apikey': SUPABASE_API_KEY,
            'Authorization': `Bearer ${SUPABASE_API_KEY}`,
            'Accept': 'application/json'
          }
        });
        
        console.log('‚úÖ User lookup status:', userResponse.status);
        
        if (userResponse.ok) {
          const userData = await userResponse.json();
          console.log('üìä Found user data:', userData);
          console.log('üîç Current interests in DB:', userData[0]?.intereses);
          console.log('üîç Interests type in DB:', typeof userData[0]?.intereses);
        } else {
          console.error('‚ùå User lookup failed');
          const errorText = await userResponse.text();
          console.error('‚ùå Error:', errorText);
        }
      } catch (error) {
        console.error('‚ùå User lookup error:', error);
      }
      
      // Step 3: Test different update formats
      console.log('\nüîç STEP 3: Testing different update formats...');
      const updateUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email=eq.${encodeURIComponent(userEmail)}`;
      console.log('üîó Update URL:', updateUrl);
      
      // Test 1: String format
      console.log('\nüß™ TEST 1: String format update...');
      try {
        const stringResponse = await fetch(updateUrl, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_API_KEY,
            'Authorization': `Bearer ${SUPABASE_API_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({ intereses: 'programacion,dise√±o' })
        });
        
        console.log('üìä String format result:', stringResponse.status);
        if (!stringResponse.ok) {
          const errorText = await stringResponse.text();
          console.error('‚ùå String format error:', errorText);
        } else {
          console.log('‚úÖ String format SUCCESS!');
        }
      } catch (error) {
        console.error('‚ùå String format exception:', error);
      }
      
      // Test 2: Array format
      console.log('\nüß™ TEST 2: Array format update...');
      try {
        const arrayResponse = await fetch(updateUrl, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_API_KEY,
            'Authorization': `Bearer ${SUPABASE_API_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({ intereses: ['programacion', 'dise√±o'] })
        });
        
        console.log('üìä Array format result:', arrayResponse.status);
        if (!arrayResponse.ok) {
          const errorText = await arrayResponse.text();
          console.error('‚ùå Array format error:', errorText);
        } else {
          console.log('‚úÖ Array format SUCCESS!');
        }
      } catch (error) {
        console.error('‚ùå Array format exception:', error);
      }
      
      // Test 3: Different field name
      console.log('\nüß™ TEST 3: Testing alternative field names...');
      const alternativeFields = ['interests', 'interest', 'intereses_usuario'];
      
      for (const fieldName of alternativeFields) {
        try {
          const testData = {};
          testData[fieldName] = 'test';
          
          const altResponse = await fetch(updateUrl, {
            method: 'PATCH',
            headers: {
              'apikey': SUPABASE_API_KEY,
              'Authorization': `Bearer ${SUPABASE_API_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=minimal'
            },
            body: JSON.stringify(testData)
          });
          
          console.log(`üìä Field '${fieldName}' result:`, altResponse.status);
          if (altResponse.ok) {
            console.log(`‚úÖ Field '${fieldName}' works!`);
          }
        } catch (error) {
          console.error(`‚ùå Field '${fieldName}' error:`, error);
        }
      }
      
      console.log('\nüö® === DIAGNOSIS COMPLETE ===');
      showMessage('üîç Diagn√≥stico completado - revisar consola para detalles', 'info');
    }

    // Load user data from localStorage and database
    async function loadUserData() {
      try {
        // Get user from localStorage
        const userSession = localStorage.getItem('currentUser');
        if (!userSession) {
          showMessage('No hay sesi√≥n activa. Redirigiendo al inicio...', 'error');
          setTimeout(() => window.location.href = 'index.html', 2000);
          return;
        }

        const sessionUser = JSON.parse(userSession);
        console.log('Session user:', sessionUser);
        
        // BULLETPROOF SYSTEM: Always ensure profile works, even with database issues
        showMessage('Cargando perfil...', 'info');

        // Try database first, but don't let it break everything
        let databaseWorked = false;
        try {
          const searchUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email=eq.${encodeURIComponent(sessionUser.email)}`;
          
          console.log('üîó Attempting database connection...');
          
          const response = await fetch(searchUrl, {
            method: 'GET',
            headers: {
              'apikey': SUPABASE_API_KEY,
              'Authorization': `Bearer ${SUPABASE_API_KEY}`,
              'Accept': 'application/json'
            },
            timeout: 5000 // 5 second timeout
          });

          console.log('‚úÖ Database responded with status:', response.status);

          console.log('‚úÖ Database responded with status:', response.status);

          if (response.ok) {
            const users = await response.json();
            console.log('‚úÖ Database users found:', users);
            
            if (users && users.length > 0) {
              currentUserData = users[0];
              console.log('‚úÖ USER LOADED FROM DATABASE:', currentUserData);
              console.log('üìÖ Date fields in loaded data:', {
                fecha_nacimiento: currentUserData.fecha_nacimiento,
                fecha_inscripcion: currentUserData.fecha_inscripcion
              });
              console.log('üîç Interests in loaded data:', currentUserData.intereses);
              
              displayUserData(currentUserData);
              showMessage('‚úÖ Perfil cargado desde base de datos', 'success');
              databaseWorked = true;
            } else {
              console.log('‚ö†Ô∏è No users found in database response');
            }
          } else {
            console.log('‚ö†Ô∏è Database request failed:', response.status);
          }
          
        } catch (dbError) {
          console.error('‚ùå Database connection failed:', dbError);
          console.log('üîÑ Will use session data instead...');
        }
        
        // ALWAYS ENSURE PROFILE WORKS - Use session data if database failed
        if (!databaseWorked) {
          console.log('üîÑ Using session data as fallback...');
          currentUserData = {
            username: sessionUser.username || 'Usuario',
            email: sessionUser.email || 'No especificado',
            telefono: sessionUser.telefono || '',
            genero: sessionUser.genero || 'n',
            intereses: sessionUser.intereses || '',
            rol: sessionUser.rol || 'estudiante',
            codigo_usuario: sessionUser.codigo || 'N/A',
            fecha_nacimiento: sessionUser.fecha_nacimiento || '1990-01-01',
            fecha_inscripcion: sessionUser.fecha_inscripcion || new Date().toISOString().split('T')[0]
          };
          
          displayUserData(currentUserData);
          
          if (sessionUser.rol === 'invitado') {
            showMessage('‚úÖ Perfil de invitado cargado (edici√≥n limitada)', 'info');
          } else {
            showMessage('‚úÖ Perfil cargado desde sesi√≥n (base de datos no disponible)', 'warning');
          }
        }

      } catch (error) {
        console.error('Error loading user data:', error);
        showMessage('‚ö†Ô∏è Error general, cargando datos b√°sicos', 'warning');
        
        // Ensure we always have some data to work with
        const sessionUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        if (sessionUser.email) {
          currentUserData = {
            username: sessionUser.username || 'Usuario',
            email: sessionUser.email || 'No especificado',
            telefono: sessionUser.telefono || '',
            genero: sessionUser.genero || 'n',
            intereses: sessionUser.intereses || '',
            rol: sessionUser.rol || 'estudiante',
            codigo_usuario: sessionUser.codigo || 'N/A',
            fecha_nacimiento: sessionUser.fecha_nacimiento || '1990-01-01',
            fecha_inscripcion: sessionUser.fecha_inscripcion || new Date().toISOString().split('T')[0]
          };
          displayUserData(currentUserData);
        }
      }
    }

    // COMPREHENSIVE DEBUG FUNCTION - Call this to test everything
    window.debugProfile = function() {
      console.log('üîß === COMPREHENSIVE PROFILE DEBUG ===');
      console.log('üìã currentUserData:', currentUserData);
      
      if (currentUserData) {
        console.log('üîç Specific fields:');
        console.log('   intereses:', currentUserData.intereses, typeof currentUserData.intereses);
        console.log('   fecha_nacimiento:', currentUserData.fecha_nacimiento);
        console.log('   fecha_inscripcion:', currentUserData.fecha_inscripcion);
        
        // Force refresh display
        console.log('üîÑ Force refreshing display...');
        displayUserData(currentUserData);
      } else {
        console.log('‚ùå No currentUserData available');
        console.log('üîÑ Attempting to reload from session...');
        loadUserFromDatabase();
      }
    };
    
    // FORCE LOAD FUNCTION - Call this if nothing is loading
    window.forceReload = function() {
      console.log('üîÑ === FORCE RELOAD ===');
      localStorage.clear();
      window.location.reload();
    };

    // Display user data in the profile
    function displayUserData(user) {
      console.log('üîç DISPLAYING USER DATA:', user);
      
      // Header info
      document.getElementById('user-display-name').textContent = user.username || 'Usuario';
      document.getElementById('user-role').textContent = `Rol: ${user.rol || 'No especificado'}`;
      document.getElementById('user-code').textContent = `C√≥digo: ${user.codigo_usuario || 'No asignado'}`;

      // Profile fields
      document.getElementById('name-display').textContent = user.username || 'No especificado';
      document.getElementById('email-display').textContent = user.email || 'No especificado';
      document.getElementById('telefono-display').textContent = user.telefono || 'No especificado';
      
      // Gender display
      const genderMap = {
        'm': 'Masculino',
        'f': 'Femenino', 
        'o': 'Otro',
        'n': 'Prefiero no decir'
      };
      document.getElementById('genero-display').textContent = genderMap[user.genero] || 'No especificado';
      
      // Simple club display - handle both string and array from database
      const clubMap = {
        'ajedrez': 'Club de Ajedrez',
        'arte': 'Club de Arte', 
        'deportes': 'Club de Deportes',
        'idiomas': 'Club de Idiomas',
        'matematica': 'Club de Matem√°tica',
        'musica': 'Club de M√∫sica',
        'programacion': 'Club de Programaci√≥n',
        'starwars': 'Club Star Wars',
        'otro': 'Otro club',
        'ninguno': 'No est√° interesado'
      };
      
      let clubValue = user.intereses;
      // If it's an array, take the first element
      if (Array.isArray(clubValue) && clubValue.length > 0) {
        clubValue = clubValue[0];
      }
      
      document.getElementById('intereses-display').textContent = clubMap[clubValue] || 'No especificado';

      // Read-only fields - dates
      console.log('ÔøΩ Processing dates...');
      console.log('üîç fecha_nacimiento:', user.fecha_nacimiento);
      console.log('üîç fecha_inscripcion:', user.fecha_inscripcion);
      
      // Birth date
      if (user.fecha_nacimiento) {
        const formattedBirthDate = formatDate(user.fecha_nacimiento);
        document.getElementById('fecha-nacimiento-display').textContent = formattedBirthDate;
        console.log('‚úÖ Birth date displayed:', formattedBirthDate);
      } else {
        document.getElementById('fecha-nacimiento-display').textContent = 'No especificado';
      }
      
      // Registration date
      if (user.fecha_inscripcion) {
        const formattedRegDate = formatDate(user.fecha_inscripcion);
        document.getElementById('fecha-inscripcion-display').textContent = formattedRegDate;
        console.log('‚úÖ Registration date displayed:', formattedRegDate);
      } else {
        document.getElementById('fecha-inscripcion-display').textContent = 'No especificado';
      }

      // Credits obtained (new field)
      console.log('üèÜ Processing credits:', user.creditos_obtenidos);
      if (user.creditos_obtenidos && user.creditos_obtenidos.trim() !== '') {
        document.getElementById('creditos-obtenidos-display').textContent = user.creditos_obtenidos;
        console.log('‚úÖ Credits displayed:', user.creditos_obtenidos);
      } else {
        document.getElementById('creditos-obtenidos-display').textContent = 'No especificado';
      }

      // Note: 'estado' field is intentionally NOT displayed as per requirements

      // Update avatar based on gender
      updateAvatar(user.genero);
      
      // Show/hide admin panel based on user role
      const adminPanel = document.getElementById('admin-panel');
      if (user.rol === 'administrador') {
        console.log('üëë Administrator detected - showing admin panel');
        adminPanel.style.display = 'block';
      } else {
        console.log('üë§ Non-admin user - hiding admin panel');
        adminPanel.style.display = 'none';
      }
      
      console.log('‚úÖ All user data displayed');
    }

    // Display session data as fallback when database fails
    function displaySessionData(sessionUser) {
      console.log('Displaying session data as fallback:', sessionUser);
      
      // Create temporary user data structure for editing
      currentUserData = {
        username: sessionUser.username || 'Usuario',
        email: sessionUser.email || '',
        telefono: '',
        genero: 'n',
        intereses: '',
        fecha_nacimiento: '',
        fecha_inscripcion: new Date().toISOString().split('T')[0],
        rol: sessionUser.rol || 'estudiante',
        codigo_usuario: sessionUser.codigo || `USER_${Date.now()}`,
        creditos_obtenidos: '',
        estado: 'activo'  // Not displayed but included for completeness
      };
      
      // Header info
      document.getElementById('user-display-name').textContent = sessionUser.username || 'Usuario';
      document.getElementById('user-role').textContent = `Rol: ${sessionUser.rol || 'No especificado'}`;
      document.getElementById('user-code').textContent = `C√≥digo: ${sessionUser.codigo || 'No asignado'}`;

      // Profile fields - show editable session data
      document.getElementById('name-display').textContent = sessionUser.username || 'No especificado';
      document.getElementById('email-display').textContent = sessionUser.email || 'No especificado';
      document.getElementById('telefono-display').textContent = 'Agregar tel√©fono';
      document.getElementById('genero-display').textContent = 'Seleccionar g√©nero';
      document.getElementById('intereses-display').textContent = 'Agregar intereses';
      document.getElementById('fecha-nacimiento-display').textContent = 'Agregar fecha de nacimiento';
      document.getElementById('fecha-inscripcion-display').textContent = new Date().toLocaleDateString('es-ES');
      document.getElementById('creditos-obtenidos-display').textContent = 'Sin cr√©ditos registrados';

      // Keep edit icons visible for editing
      const editIcons = document.querySelectorAll('.edit-icon');
      editIcons.forEach(icon => {
        icon.style.display = 'inline';
        icon.style.color = '#22c55e'; // Green to indicate they can add data
      });

      // Update avatar to default
      updateAvatar('n');
      
      // Show/hide admin panel based on session user role
      const adminPanel = document.getElementById('admin-panel');
      if (sessionUser.rol === 'administrador') {
        console.log('üëë Session Administrator detected - showing admin panel');
        adminPanel.style.display = 'block';
      } else {
        console.log('üë§ Session non-admin user - hiding admin panel');
        adminPanel.style.display = 'none';
      }
      
      showMessage('üìù Datos de sesi√≥n - Puedes editar y agregar informaci√≥n. Los cambios se guardar√°n cuando crees tu usuario en la base de datos.', 'info');
    }

    // Create user in database directly from profile page
    async function createUserInDatabase() {
      try {
        const userSession = localStorage.getItem('currentUser');
        if (!userSession) {
          showMessage('No hay sesi√≥n activa para crear usuario.', 'error');
          return;
        }

        const sessionUser = JSON.parse(userSession);
        
        showMessage('Creando usuario en la base de datos...', 'info');

        // Use current edited data if available, otherwise use defaults
        const userData = {
          username: currentUserData?.username || sessionUser.username || 'Usuario',
          email: currentUserData?.email || sessionUser.email || 'sin-email@example.com',
          password: 'temporal123', // Temporary password
          telefono: currentUserData?.telefono || '+506-0000-0000',
          fecha_nacimiento: currentUserData?.fecha_nacimiento || '1990-01-01',
          rol: sessionUser.rol || 'estudiante',
          fecha_inscripcion: currentUserData?.fecha_inscripcion || new Date().toISOString().split('T')[0],
          codigo_usuario: currentUserData?.codigo_usuario || sessionUser.codigo || `USER_${Date.now()}`,
          genero: currentUserData?.genero || 'n',
          intereses: currentUserData?.intereses || 'programacion'
        };

        console.log('Creating user with current data:', userData);

        const response = await fetch('https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios', {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_API_KEY,
            'Authorization': `Bearer ${SUPABASE_API_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(userData)
        });

        if (response.ok) {
          const result = await response.json();
          console.log('User created successfully:', result);
          
          // Update session with the new code
          sessionUser.codigo = userData.codigo_usuario;
          localStorage.setItem('currentUser', JSON.stringify(sessionUser));
          
          showMessage('‚úÖ Usuario creado exitosamente con todos tus cambios. Recargando perfil...', 'success');
          
          // Reload user data
          setTimeout(() => {
            loadUserData();
          }, 1500);
          
        } else {
          const errorText = await response.text();
          console.error('Error creating user:', errorText);
          
          if (response.status === 409 || errorText.includes('duplicate')) {
            showMessage('‚ö†Ô∏è El usuario ya existe. Intentando buscar nuevamente...', 'warning');
            setTimeout(() => {
              loadUserData();
            }, 1000);
          } else {
            showMessage(`‚ùå Error al crear usuario: ${response.status} - ${errorText}`, 'error');
          }
        }
      } catch (error) {
        console.error('Error creating user:', error);
        showMessage('Error de conexi√≥n al crear usuario: ' + error.message, 'error');
      }
    }

    // Show guest profile with limited data
    function showGuestProfile(sessionUser) {
      document.getElementById('user-display-name').textContent = sessionUser.username;
      document.getElementById('user-role').textContent = `Rol: ${sessionUser.rol}`;
      document.getElementById('user-code').textContent = `C√≥digo: ${sessionUser.codigo}`;
      
      // Hide edit icons for guest
      const editIcons = document.querySelectorAll('.edit-icon');
      editIcons.forEach(icon => icon.style.display = 'none');
      
      // Show guest message
      showMessage('Perfil de invitado - Solo vista. Para editar, reg√≠strate como usuario.', 'info');
    }

    // Edit field function
    function editField(fieldName) {
      console.log('üîß editField called with:', fieldName);
      console.log('üîß currentUserData exists:', !!currentUserData);
      
      if (!currentUserData) {
        showMessage('‚ùå No se pueden editar datos sin informaci√≥n del usuario. Por favor, inicia sesi√≥n con un usuario registrado.', 'error');
        console.log('‚ùå Cannot edit: currentUserData is null');
        return;
      }

      // Store original value
      const displayElement = document.getElementById(`${fieldName}-display`);
      const editElement = document.getElementById(`${fieldName}-edit`);
      const buttonsElement = document.getElementById(`${fieldName}-buttons`);

      console.log('üîß Elements found:', {
        display: !!displayElement,
        edit: !!editElement,
        buttons: !!buttonsElement,
        fieldName: fieldName
      });

      if (!displayElement || !editElement || !buttonsElement) {
        showMessage('‚ùå Error: No se encontraron los elementos de edici√≥n para ' + fieldName, 'error');
        console.log('‚ùå Missing elements for field:', fieldName);
        console.log('‚ùå Display element:', displayElement);
        console.log('‚ùå Edit element:', editElement);
        console.log('‚ùå Buttons element:', buttonsElement);
        return;
      }

      // Map frontend field names to database field names
      const fieldMapping = {
        'name': 'username',
        'telefono': 'telefono',
        'email': 'email',
        'genero': 'genero',
        'intereses': 'intereses'
      };
      
      const dbFieldName = fieldMapping[fieldName] || fieldName;

      if (fieldName === 'intereses') {
        // Handle simple select like gender - extract value from array if needed
        const selectElement = document.getElementById('intereses-input');
        let currentValue = currentUserData[dbFieldName] || '';
        
        // If database stored as array, get first element
        if (Array.isArray(currentValue) && currentValue.length > 0) {
          currentValue = currentValue[0];
        }
        
        selectElement.value = currentValue;
        originalValues[fieldName] = currentValue;
      } else if (fieldName === 'genero') {
        // Handle gender select
        editElement.value = currentUserData[dbFieldName] || 'n';
        originalValues[fieldName] = currentUserData[dbFieldName] || 'n';
      } else {
        // Handle text inputs
        editElement.value = currentUserData[dbFieldName] || '';
        originalValues[fieldName] = currentUserData[dbFieldName] || '';
      }

      console.log(`üîß SHOWING EDIT MODE for ${fieldName}...`);
      console.log(`üîß Display element:`, displayElement);
      console.log(`üîß Edit element:`, editElement);
      console.log(`üîß Buttons element:`, buttonsElement);

      // Show edit mode
      displayElement.style.display = 'none';
      editElement.style.display = 'block';
      buttonsElement.style.display = 'block';
      
      console.log(`‚úÖ EDIT MODE ACTIVATED for ${fieldName}`);
      console.log(`‚úÖ Edit element visible:`, editElement.style.display);
      console.log(`‚úÖ Buttons visible:`, buttonsElement.style.display);
    }

    // Cancel edit
    function cancelEdit(fieldName) {
      const displayElement = document.getElementById(`${fieldName}-display`);
      const editElement = document.getElementById(`${fieldName}-edit`);
      const buttonsElement = document.getElementById(`${fieldName}-buttons`);

      // Hide edit mode
      displayElement.style.display = 'block';
      editElement.style.display = 'none';
      buttonsElement.style.display = 'none';
    }

    // Save field
    async function saveField(fieldName) {
      try {
        let newValue;
        const editElement = document.getElementById(`${fieldName}-edit`);

        // Map frontend field names to database field names
        const fieldMapping = {
          'name': 'username',
          'telefono': 'telefono',
          'email': 'email',
          'genero': 'genero',
          'intereses': 'intereses'
        };
        
        const dbFieldName = fieldMapping[fieldName] || fieldName;

        if (fieldName === 'intereses') {
          // Handle simple select like gender
          const selectElement = document.getElementById('intereses-input');
          newValue = selectElement.value;
          console.log('üîç CLUB DEBUG:');
          console.log('   Select element found:', !!selectElement);
          console.log('   Selected value:', newValue);
          console.log('   All options:', selectElement ? Array.from(selectElement.options).map(opt => opt.value) : 'N/A');
        } else {
          newValue = editElement.value;
        }

        console.log(`üîÑ SAVING: ${fieldName} (DB: ${dbFieldName}) = "${newValue}"`);

        if (!currentUserData || !currentUserData.email) {
          showMessage('‚ùå Error: No hay datos de usuario para actualizar', 'error');
          return;
        }

        // SIMPLE DATABASE UPDATE - SAME AS GENERO
        showMessage(`Guardando ${fieldName}...`, 'info');
        
        const updateSuccess = await updateUserField(dbFieldName, newValue);
        
        if (updateSuccess) {
          // Update local data
          currentUserData[dbFieldName] = newValue;
          
          // Update display immediately
          if (fieldName === 'genero') {
            const genderMap = { 'm': 'Masculino', 'f': 'Femenino', 'o': 'Otro', 'n': 'Prefiero no decir' };
            document.getElementById(`${fieldName}-display`).textContent = genderMap[newValue] || 'Seleccionar g√©nero';
            updateAvatar(newValue);
          } else if (fieldName === 'intereses') {
            // Simple club display like gender
            const clubMap = {
              'ajedrez': 'Club de Ajedrez',
              'arte': 'Club de Arte', 
              'deportes': 'Club de Deportes',
              'idiomas': 'Club de Idiomas',
              'matematica': 'Club de Matem√°tica',
              'musica': 'Club de M√∫sica',
              'programacion': 'Club de Programaci√≥n',
              'starwars': 'Club Star Wars',
              'otro': 'Otro club',
              'ninguno': 'No est√° interesado'
            };
            const displayText = clubMap[newValue] || 'No especificado';
            document.getElementById(`${fieldName}-display`).textContent = displayText;
            console.log('‚úÖ INTERESTS: Display updated to:', displayText);
          } else {
            const displayText = newValue || (fieldName === 'telefono' ? 'Agregar tel√©fono' : 'No especificado');
            document.getElementById(`${fieldName}-display`).textContent = displayText;
          }

          // Update header if name changed
          if (fieldName === 'name') {
            document.getElementById('user-display-name').textContent = newValue || 'Usuario';
          }

          cancelEdit(fieldName);
          showMessage(`‚úÖ ${fieldName} actualizado correctamente!`, 'success');
          
        } else {
          showMessage(`‚ùå Error al guardar ${fieldName}. Revisa la consola para detalles.`, 'error');
        }

      } catch (error) {
        console.error('‚ùå Error saving field:', error);
        showMessage('‚ùå Error cr√≠tico al guardar: ' + error.message, 'error');
      }
    }

    // Check if email exists for another user
    async function checkEmailExists(email, currentEmail) {
      if (email === currentEmail) return false; // Same email, no conflict
      
      try {
        const searchUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email=eq.${encodeURIComponent(email)}`;
        
        const response = await fetch(searchUrl, {
          method: 'GET',
          headers: {
            'apikey': SUPABASE_API_KEY,
            'Authorization': `Bearer ${SUPABASE_API_KEY}`,
            'Accept': 'application/json'
          }
        });

        if (response.ok) {
          const users = await response.json();
          return users && users.length > 0;
        }
        return false;
      } catch (error) {
        console.error('Error checking email:', error);
        return false;
      }
    }

    // Check if user exists in database
    async function checkUserExistsInDatabase(email) {
      try {
        const searchUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email=eq.${encodeURIComponent(email)}`;
        
        const response = await fetch(searchUrl, {
          method: 'GET',
          headers: {
            'apikey': SUPABASE_API_KEY,
            'Authorization': `Bearer ${SUPABASE_API_KEY}`,
            'Accept': 'application/json'
          }
        });

        if (response.ok) {
          const users = await response.json();
          return users && users.length > 0;
        }
        return false;
      } catch (error) {
        console.error('Error checking user existence:', error);
        return false;
      }
    }

    // Enhanced guest detection function
    function isGuestUser(userData) {
      if (!userData) return false;
      
      // Check for guest indicators
      const isGuestEmail = userData.email && (
        userData.email === 'guest@galaxiamagna.edu' ||
        userData.email === 'guest@test.com' ||
        userData.email.includes('guest@')
      );
      
      const isGuestRole = userData.rol === 'invitado';
      
      const isGuestCode = userData.codigo_usuario && (
        userData.codigo_usuario.includes('GUEST') ||
        userData.codigo_usuario === 'GUEST_2025' ||
        userData.codigo_usuario === 'GUEST_001'
      );
      
      return isGuestEmail || isGuestRole || isGuestCode;
    }

    // Test database connection function
    async function testDatabaseConnection() {
      console.log('üß™ TESTING DATABASE CONNECTION...');
      console.log('üìß Testing with email:', currentUserData.email);
      
      // Enhanced guest mode detection
      if (isGuestUser(currentUserData)) {
        console.log('üëª GUEST MODE DETECTED: Allowing operation without database validation');
        console.log('üë§ Guest details:', {
          username: currentUserData.username,
          email: currentUserData.email,
          rol: currentUserData.rol,
          codigo: currentUserData.codigo_usuario
        });
        return { isGuest: true, userData: currentUserData };
      }
      
      const testUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email=eq.${encodeURIComponent(currentUserData.email)}`;
      console.log('üîó Test URL:', testUrl);
      
      try {
        const response = await fetch(testUrl, {
          method: 'GET',
          headers: {
            'apikey': SUPABASE_API_KEY,
            'Authorization': `Bearer ${SUPABASE_API_KEY}`,
            'Content-Type': 'application/json'
          }
        });
        
        console.log('üì° Response status:', response.status);
        
        if (response.ok) {
          const data = await response.json();
          console.log('‚úÖ DB CONNECTION TEST: SUCCESS');
          console.log('üìä Query returned:', data.length, 'users');
          
          if (data && data.length > 0) {
            console.log('üë§ User found in database:', data[0]);
            return data[0];
          } else {
            console.log('‚ùì User not found in database - might be a new user or guest');
            return null;
          }
        } else {
          console.error('‚ùå DB CONNECTION TEST: HTTP ERROR');
          console.error('Status:', response.status);
          const errorText = await response.text();
          console.error('Response:', errorText);
          return null;
        }
      } catch (error) {
        console.error('‚ùå DB CONNECTION TEST: NETWORK ERROR');
        console.error('Error details:', error);
        return null;
      }
    }

    // Update user field in database
    async function updateUserField(fieldName, newValue) {
      try {
        console.log('üîÑ UPDATE REQUEST:', fieldName, '=', newValue);
        console.log('üìß Current user email:', currentUserData.email);
        
        // First test database connection
        const testResult = await testDatabaseConnection();
        
        // Handle guest mode - update in memory only
        if (testResult && testResult.isGuest) {
          console.log('üëª GUEST MODE: Updating data in memory only (no database save)');
          
          // Update the current user data in memory
          if (fieldName === 'intereses') {
            currentUserData[fieldName] = newValue;
            console.log('üß† Memory update: interests =', newValue);
          } else {
            currentUserData[fieldName] = newValue;
            console.log('üß† Memory update:', fieldName, '=', newValue);
          }
          
          // Update the display immediately
          displayUserData(currentUserData);
          
          // Show success message for guest
          showMessage(`üëª Invitado: ${fieldName} actualizado a "${newValue}" (cambios solo en memoria)`, 'success');
          
          // Also update localStorage to persist during session
          try {
            const sessionData = JSON.parse(localStorage.getItem('currentUser') || '{}');
            sessionData[fieldName] = newValue;
            localStorage.setItem('currentUser', JSON.stringify(sessionData));
            console.log('üíæ Updated localStorage for guest session');
          } catch (e) {
            console.log('‚ö†Ô∏è Could not update localStorage:', e);
          }
          
          return true;
        }
        
        // If user not found in database but not in guest mode
        if (!testResult) {
          console.log('‚ùì User not found in database');
          console.log('üéØ This might be a new user or the email might not match');
          console.log('üìã Available options:');
          console.log('   1. Continue with update attempt (might create new record)');
          console.log('   2. Show error to user');
          
          // For now, let's try to continue but warn the user
          showMessage('‚ö†Ô∏è Usuario no encontrado en base de datos - intentando actualizar...', 'warning');
        } else {
          console.log('‚úÖ User verified in database, proceeding with update');
        }
        
        // Properly declare and initialize updateData object
        const updateData = {};
        
        // Special handling for interests - database expects array format
        if (fieldName === 'intereses') {
          console.log('üîç CLUB UPDATE: Converting to array format');
          // Convert single club selection to array format for database
          updateData[fieldName] = newValue ? [newValue] : [];
          console.log('   Converted to array:', updateData[fieldName]);
        } else {
          updateData[fieldName] = newValue;
        }

        const updateUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email=eq.${encodeURIComponent(currentUserData.email)}`;
        
        console.log('üîó Update URL:', updateUrl);
        console.log('üì§ Update data:', JSON.stringify(updateData, null, 2));
        
        const response = await fetch(updateUrl, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_API_KEY,
            'Authorization': `Bearer ${SUPABASE_API_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify(updateData)
        });

        console.log('üì° Update response status:', response.status);
        console.log('üì° Update response headers:', Object.fromEntries(response.headers.entries()));
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('‚ùå Update failed with status:', response.status);
          console.error('‚ùå Error response:', errorText);
          
          // Special retry for interests field - try as array instead of string
          if (fieldName === 'intereses' && response.status === 400) {
            console.log('üîÑ RETRY: Attempting interests update as array format...');
            try {
              const arrayUpdateData = {};
              arrayUpdateData[fieldName] = newValue ? newValue.split(',') : [];
              
              const retryResponse = await fetch(updateUrl, {
                method: 'PATCH',
                headers: {
                  'apikey': SUPABASE_API_KEY,
                  'Authorization': `Bearer ${SUPABASE_API_KEY}`,
                  'Content-Type': 'application/json',
                  'Prefer': 'return=minimal'
                },
                body: JSON.stringify(arrayUpdateData)
              });
              
              if (retryResponse.ok) {
                console.log('‚úÖ RETRY SUCCESS: Interests updated as array');
                return true;
              } else {
                console.log('‚ùå RETRY FAILED: Array format also failed');
              }
            } catch (retryError) {
              console.error('‚ùå RETRY ERROR:', retryError);
            }
          }
          
          // Show detailed error to user
          showMessage(`‚ùå Error de base de datos (${response.status}): ${errorText}`, 'error');
          return false;
        } else {
          console.log('Update successful!');
          return true;
        }

      } catch (error) {
        console.error('Network/fetch error updating field:', error);
        showMessage(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
        return false;
      }
    }

    // Update avatar based on gender
    function updateAvatar(gender) {
      const avatar = document.getElementById('user-avatar');
      const avatarMap = {
        'm': 'images/Male.png',
        'f': 'images/Female.png',
        'o': 'images/Other.png',
        'n': 'images/incognito.png'
      };
      
      if (avatarMap[gender]) {
        avatar.src = avatarMap[gender];
      }
    }

    // Format date for display with better error handling
    function formatDate(dateString) {
      console.log('üìÖ Formatting date:', dateString, typeof dateString);
      
      if (!dateString || dateString === null || dateString === '' || dateString === 'null') {
        console.log('üìÖ No valid date string provided');
        return 'No especificado';
      }
      
      try {
        // Handle different date formats
        let date;
        if (dateString.includes('T')) {
          // ISO format with time
          date = new Date(dateString);
        } else if (dateString.includes('-')) {
          // Date format YYYY-MM-DD
          date = new Date(dateString + 'T00:00:00');
        } else {
          // Try as-is
          date = new Date(dateString);
        }
        
        // Check if date is valid
        if (isNaN(date.getTime())) {
          console.error('üìÖ Invalid date:', dateString);
          return 'Fecha inv√°lida';
        }
        
        const formatted = date.toLocaleDateString('es-ES', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        
        console.log('üìÖ Formatted result:', formatted);
        return formatted;
        
      } catch (error) {
        console.error('üìÖ Error formatting date:', error);
        return 'Error en fecha';
      }
    }

    // Show message function
    function showMessage(message, type) {
      const messageArea = document.getElementById('message-area');
      messageArea.textContent = message;
      messageArea.style.display = 'block';
      
      // Set color based on type
      switch(type) {
        case 'success':
          messageArea.style.backgroundColor = '#22c55e';
          messageArea.style.color = 'white';
          break;
        case 'error':
          messageArea.style.backgroundColor = '#ef4444';
          messageArea.style.color = 'white';
          break;
        case 'info':
          messageArea.style.backgroundColor = '#3b82f6';
          messageArea.style.color = 'white';
          break;
        case 'warning':
          messageArea.style.backgroundColor = '#f59e0b';
          messageArea.style.color = 'white';
          break;
        default:
          messageArea.style.backgroundColor = '#6b7280';
          messageArea.style.color = 'white';
      }

      // Auto-hide success messages
      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          messageArea.style.display = 'none';
        }, 3000);
      }
    }

    // Debug functions
    async function testDatabaseConnection() {
      try {
        const response = await fetch('https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?limit=1', {
          method: 'GET',
          headers: {
            'apikey': SUPABASE_API_KEY,
            'Authorization': `Bearer ${SUPABASE_API_KEY}`,
            'Accept': 'application/json'
          }
        });
        
        if (response.ok) {
          showMessage('‚úÖ Database connection OK!', 'success');
        } else {
          showMessage(`‚ùå DB connection failed: ${response.status}`, 'error');
        }
      } catch (error) {
        showMessage(`‚ùå DB connection error: ${error.message}`, 'error');
      }
    }

    function showCurrentUserData() {
      console.log('=== CURRENT USER DATA ===');
      console.log('currentUserData:', currentUserData);
      console.log('Session data:', localStorage.getItem('currentUser'));
      console.log('========================');
      showMessage('Check console for current user data', 'info');
    }

    async function testTelefonoUpdate() {
      if (!currentUserData || !currentUserData.email) {
        showMessage('‚ùå No user data loaded', 'error');
        return;
      }
      
      const testPhone = `+506-${Math.floor(Math.random() * 9000) + 1000}-${Math.floor(Math.random() * 9000) + 1000}`;
      console.log('Testing telefono update with:', testPhone);
      
      const success = await updateUserField('telefono', testPhone);
      
      if (success) {
        document.getElementById('telefono-display').textContent = testPhone;
        currentUserData.telefono = testPhone;
        showMessage('‚úÖ Telefono test update successful!', 'success');
      } else {
        showMessage('‚ùå Telefono test update failed!', 'error');
      }
    }

    // Fix missing database fields
    async function fixMissingFields() {
      if (!currentUserData || !currentUserData.email) {
        showMessage('‚ùå No user data loaded', 'error');
        return;
      }

      console.log('üîß Checking and fixing missing fields...');
      showMessage('Verificando y corrigiendo campos faltantes...', 'info');

      const fixes = {};
      let needsUpdate = false;

      // Check and fix interests
      if (!currentUserData.intereses || currentUserData.intereses === null || currentUserData.intereses === '' || currentUserData.intereses === 'null') {
        fixes.intereses = 'programacion';
        needsUpdate = true;
        console.log('üîß Will fix missing interests');
      }

      // Check and fix birth date
      if (!currentUserData.fecha_nacimiento || currentUserData.fecha_nacimiento === null || currentUserData.fecha_nacimiento === '' || currentUserData.fecha_nacimiento === 'null') {
        fixes.fecha_nacimiento = '1990-01-01';
        needsUpdate = true;
        console.log('üîß Will fix missing birth date');
      }

      // Check and fix registration date
      if (!currentUserData.fecha_inscripcion || currentUserData.fecha_inscripcion === null || currentUserData.fecha_inscripcion === '' || currentUserData.fecha_inscripcion === 'null') {
        fixes.fecha_inscripcion = new Date().toISOString().split('T')[0];
        needsUpdate = true;
        console.log('üîß Will fix missing registration date');
      }

      if (needsUpdate) {
        console.log('üîß Applying fixes:', fixes);
        
        const updateUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email=eq.${encodeURIComponent(currentUserData.email)}`;
        
        try {
          const response = await fetch(updateUrl, {
            method: 'PATCH',
            headers: {
              'apikey': SUPABASE_API_KEY,
              'Authorization': `Bearer ${SUPABASE_API_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=minimal'
            },
            body: JSON.stringify(fixes)
          });

          if (response.ok) {
            console.log('‚úÖ Fields fixed successfully');
            showMessage('‚úÖ Campos corregidos. Recargando perfil...', 'success');
            
            // Update local data
            Object.assign(currentUserData, fixes);
            
            // Refresh display
            setTimeout(() => {
              loadUserData();
            }, 1000);
            
          } else {
            const errorText = await response.text();
            console.error('‚ùå Error fixing fields:', errorText);
            showMessage(`‚ùå Error al corregir campos: ${response.status}`, 'error');
          }
        } catch (error) {
          console.error('‚ùå Network error fixing fields:', error);
          showMessage(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
        }
      } else {
        console.log('‚úÖ All fields have data');
        showMessage('‚úÖ Todos los campos tienen datos v√°lidos', 'success');
      }
    }
  </script>
</body>
</html>
