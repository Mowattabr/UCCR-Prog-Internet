<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Perfil - Galaxia Magna Academy</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>

  <!-- HEADER -->
  <header style="display: flex; align-items: center; justify-content: center; gap: 20px; padding: 20px;">
    <img src="images/GAM_transparent.png" alt="Galaxia Magna Academy Logo" style="width: 80px; height: 80px; object-fit: contain;">
    <div style="text-align: center;">
      <h1 style="color: #C0C0C0; margin-bottom: 5px; margin-top: 0;">Mi Perfil</h1>
      <h2 style="font-style: italic; font-weight: normal; font-size: 1.5em; margin-top: 0; color: #C0C0C0; margin-bottom: 0;">Galaxia Magna Academy</h2>
    </div>
    <img src="images/GAM_transparent.png" alt="GMA Logo" style="width: 80px; height: 80px; object-fit: contain;">
  </header>

  <main>
    <!-- Navigation -->
    <nav style="margin: 20px auto; max-width: 800px;">
      <ul style="display: flex; justify-content: center; gap: 20px; list-style: none; padding: 0;">
        <li><a href="index.html" style="color: #f18b32; text-decoration: none;">‚Üê Volver al Inicio</a></li>
        <li><a href="registro.html" style="color: #f18b32; text-decoration: none;">Formulario de Registro</a></li>
      </ul>
    </nav>

    <!-- Message Area -->
    <div id="message-area" style="display: none; max-width: 800px; margin: 20px auto; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold;"></div>

    <!-- User Profile Section -->
    <section style="max-width: 800px; margin: 40px auto; padding: 40px 20px; background: #23232b; border-radius: 12px; box-shadow: 0 4px 24px #0008; color: #fff;">
      
      <!-- Profile Header -->
      <div style="text-align: center; margin-bottom: 30px;">
        <div id="avatar-container" style="margin-bottom: 20px;">
          <img id="user-avatar" src="images/Male.png" alt="Avatar" style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid #f18b32; object-fit: cover;">
        </div>
        <h2 id="user-display-name" style="color: #f18b32; margin-bottom: 10px;">Cargando...</h2>
        <p id="user-role" style="color: #c9c9c9; margin-bottom: 0;">Rol: Cargando...</p>
        <p id="user-code" style="color: #c9c9c9; font-size: 0.9em;">C√≥digo: Cargando...</p>
      </div>

      <!-- Profile Information -->
      <div class="profile-info">
        
        <!-- Name Field -->
        <div class="profile-field" style="margin-bottom: 25px; padding: 20px; background: #2d2d35; border-radius: 8px; position: relative;">
          <label style="color: #f18b32; font-weight: bold; display: block; margin-bottom: 8px;">
            <i class="fas fa-user" style="margin-right: 8px;"></i>Nombre Completo
          </label>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <span id="name-display" style="color: #fff; font-size: 1.1em;">Cargando...</span>
            <i class="fas fa-pen edit-icon" onclick="editField('name')" style="color: #f18b32; cursor: pointer; font-size: 1.2em;" title="Editar nombre"></i>
          </div>
          <input type="text" id="name-edit" style="display: none; width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #4a4a55; border-radius: 4px; background: #1a1a1f; color: #fff;">
          <div style="display: none; margin-top: 10px;" id="name-buttons">
            <button onclick="saveField('name')" style="background: #22c55e; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">Guardar</button>
            <button onclick="cancelEdit('name')" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Cancelar</button>
          </div>
        </div>

        <!-- Email Field -->
        <div class="profile-field" style="margin-bottom: 25px; padding: 20px; background: #2d2d35; border-radius: 8px; position: relative;">
          <label style="color: #f18b32; font-weight: bold; display: block; margin-bottom: 8px;">
            <i class="fas fa-envelope" style="margin-right: 8px;"></i>Email
          </label>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <span id="email-display" style="color: #fff; font-size: 1.1em;">Cargando...</span>
            <i class="fas fa-pen edit-icon" onclick="editField('email')" style="color: #f18b32; cursor: pointer; font-size: 1.2em;" title="Editar email"></i>
          </div>
          <input type="email" id="email-edit" style="display: none; width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #4a4a55; border-radius: 4px; background: #1a1a1f; color: #fff;">
          <div style="display: none; margin-top: 10px;" id="email-buttons">
            <button onclick="saveField('email')" style="background: #22c55e; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">Guardar</button>
            <button onclick="cancelEdit('email')" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Cancelar</button>
          </div>
        </div>

        <!-- Phone Field -->
        <div class="profile-field" style="margin-bottom: 25px; padding: 20px; background: #2d2d35; border-radius: 8px; position: relative;">
          <label style="color: #f18b32; font-weight: bold; display: block; margin-bottom: 8px;">
            <i class="fas fa-phone" style="margin-right: 8px;"></i>Tel√©fono
          </label>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <span id="telefono-display" style="color: #fff; font-size: 1.1em;">Cargando...</span>
            <i class="fas fa-pen edit-icon" onclick="editField('telefono')" style="color: #f18b32; cursor: pointer; font-size: 1.2em;" title="Editar tel√©fono"></i>
          </div>
          <input type="tel" id="telefono-edit" style="display: none; width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #4a4a55; border-radius: 4px; background: #1a1a1f; color: #fff;">
          <div style="display: none; margin-top: 10px;" id="telefono-buttons">
            <button onclick="saveField('telefono')" style="background: #22c55e; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">Guardar</button>
            <button onclick="cancelEdit('telefono')" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Cancelar</button>
          </div>
        </div>

        <!-- Gender Field -->
        <div class="profile-field" style="margin-bottom: 25px; padding: 20px; background: #2d2d35; border-radius: 8px; position: relative;">
          <label style="color: #f18b32; font-weight: bold; display: block; margin-bottom: 8px;">
            <i class="fas fa-venus-mars" style="margin-right: 8px;"></i>G√©nero
          </label>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <span id="genero-display" style="color: #fff; font-size: 1.1em;">Cargando...</span>
            <i class="fas fa-pen edit-icon" onclick="editField('genero')" style="color: #f18b32; cursor: pointer; font-size: 1.2em;" title="Editar g√©nero"></i>
          </div>
          <select id="genero-edit" style="display: none; width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #4a4a55; border-radius: 4px; background: #1a1a1f; color: #fff;">
            <option value="m">Masculino</option>
            <option value="f">Femenino</option>
            <option value="o">Otro</option>
            <option value="n">Prefiero no decir</option>
          </select>
          <div style="display: none; margin-top: 10px;" id="genero-buttons">
            <button onclick="saveField('genero')" style="background: #22c55e; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">Guardar</button>
            <button onclick="cancelEdit('genero')" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Cancelar</button>
          </div>
        </div>

        <!-- Interests Field -->
        <div class="profile-field" style="margin-bottom: 25px; padding: 20px; background: #2d2d35; border-radius: 8px; position: relative;">
          <label style="color: #f18b32; font-weight: bold; display: block; margin-bottom: 8px;">
            <i class="fas fa-heart" style="margin-right: 8px;"></i>Intereses
          </label>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <span id="intereses-display" style="color: #fff; font-size: 1.1em;">Cargando...</span>
            <i class="fas fa-pen edit-icon" onclick="editField('intereses')" style="color: #f18b32; cursor: pointer; font-size: 1.2em;" title="Editar intereses"></i>
          </div>
          <div id="intereses-edit" style="display: none; margin-top: 15px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
              <label style="color: #fff; display: flex; align-items: center;">
                <input type="checkbox" value="programacion" style="margin-right: 8px;"> Programaci√≥n
              </label>
              <label style="color: #fff; display: flex; align-items: center;">
                <input type="checkbox" value="dise√±o" style="margin-right: 8px;"> Dise√±o
              </label>
              <label style="color: #fff; display: flex; align-items: center;">
                <input type="checkbox" value="marketing" style="margin-right: 8px;"> Marketing
              </label>
              <label style="color: #fff; display: flex; align-items: center;">
                <input type="checkbox" value="ciencia" style="margin-right: 8px;"> Ciencia de Datos
              </label>
              <label style="color: #fff; display: flex; align-items: center;">
                <input type="checkbox" value="basketball" style="margin-right: 8px;"> Basketball
              </label>
              <label style="color: #fff; display: flex; align-items: center;">
                <input type="checkbox" value="star wars" style="margin-right: 8px;"> Star Wars
              </label>
            </div>
          </div>
          <div style="display: none; margin-top: 10px;" id="intereses-buttons">
            <button onclick="saveField('intereses')" style="background: #22c55e; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">Guardar</button>
            <button onclick="cancelEdit('intereses')" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Cancelar</button>
          </div>
        </div>

        <!-- Read-only fields -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
          
          <!-- Birth Date -->
          <div style="padding: 15px; background: #1a1a1f; border-radius: 8px; border-left: 4px solid #f18b32;">
            <label style="color: #f18b32; font-weight: bold; display: block; margin-bottom: 5px;">
              <i class="fas fa-calendar" style="margin-right: 8px;"></i>Fecha de Nacimiento
            </label>
            <span id="fecha-nacimiento-display" style="color: #c9c9c9;">Cargando...</span>
          </div>

          <!-- Registration Date -->
          <div style="padding: 15px; background: #1a1a1f; border-radius: 8px; border-left: 4px solid #f18b32;">
            <label style="color: #f18b32; font-weight: bold; display: block; margin-bottom: 5px;">
              <i class="fas fa-clock" style="margin-right: 8px;"></i>Fecha de Inscripci√≥n
            </label>
            <span id="fecha-inscripcion-display" style="color: #c9c9c9;">Cargando...</span>
          </div>
          
        </div>

      </div>

    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let currentUserData = null;
    let originalValues = {};

    // Load user data on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadUserData();
    });

    // Load user data from localStorage and database
    async function loadUserData() {
      try {
        // Get user from localStorage
        const userSession = localStorage.getItem('currentUser');
        if (!userSession) {
          showMessage('No hay sesi√≥n activa. Redirigiendo al inicio...', 'error');
          setTimeout(() => window.location.href = 'index.html', 2000);
          return;
        }

        const sessionUser = JSON.parse(userSession);
        console.log('Session user:', sessionUser);
        
        // ALWAYS try to load from database first - forget session complications
        showMessage('Cargando datos desde la base de datos...', 'info');

        // FIXED: Direct database search by email with correct Supabase syntax
        const searchUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email=eq.${encodeURIComponent(sessionUser.email)}`;
        
        console.log('Searching database with URL:', searchUrl);
        console.log('Looking for user with email:', sessionUser.email);
        
        const response = await fetch(searchUrl, {
          method: 'GET',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Accept': 'application/json'
          }
        });

        console.log('Database response status:', response.status);

        if (response.ok) {
          const users = await response.json();
          console.log('Database users found:', users);
          
          if (users && users.length > 0) {
            currentUserData = users[0];
            console.log('‚úÖ USER LOADED FROM DATABASE:', currentUserData);
            
            displayUserData(currentUserData);
            showMessage('‚úÖ Perfil cargado correctamente. Todos los campos son editables.', 'success');
            return;
          }
        }
        
        // If not found in database, show error with create option
        console.error('‚ùå User not found in database');
        showMessage('‚ùå Usuario no encontrado en la base de datos. Debes crearlo primero.', 'error');
        
        // Show create user option
        const messageArea = document.getElementById('message-area');
        messageArea.innerHTML += `
          <div style="margin-top: 15px; text-align: center;">
            <button onclick="createUserInDatabase()" style="background: #f18b32; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
              ‚ûï Crear Usuario en Base de Datos
            </button>
          </div>
        `;

      } catch (error) {
        console.error('Error loading user data:', error);
        showMessage('Error de conexi√≥n: ' + error.message, 'error');
      }
    }

    // Display user data in the profile
    function displayUserData(user) {
      console.log('üîç DISPLAYING USER DATA:', user);
      
      // Header info
      document.getElementById('user-display-name').textContent = user.username || 'Usuario';
      document.getElementById('user-role').textContent = `Rol: ${user.rol || 'No especificado'}`;
      document.getElementById('user-code').textContent = `C√≥digo: ${user.codigo_usuario || 'No asignado'}`;

      // Profile fields
      document.getElementById('name-display').textContent = user.username || 'No especificado';
      document.getElementById('email-display').textContent = user.email || 'No especificado';
      document.getElementById('telefono-display').textContent = user.telefono || 'No especificado';
      
      // Gender display
      const genderMap = {
        'm': 'Masculino',
        'f': 'Femenino', 
        'o': 'Otro',
        'n': 'Prefiero no decir'
      };
      document.getElementById('genero-display').textContent = genderMap[user.genero] || 'No especificado';
      
      // Interests display - with enhanced debugging and fallback
      console.log('üîç Raw intereses data:', user.intereses);
      console.log('üîç Type of intereses:', typeof user.intereses);
      console.log('üîç Intereses === null:', user.intereses === null);
      console.log('üîç Intereses === undefined:', user.intereses === undefined);
      console.log('üîç Intereses length:', user.intereses ? user.intereses.length : 'N/A');
      
      if (user.intereses && user.intereses !== null && user.intereses !== '' && user.intereses !== 'null') {
        try {
          const interesesText = user.intereses.split(',').join(', ');
          document.getElementById('intereses-display').textContent = interesesText;
          console.log('‚úÖ Interests displayed:', interesesText);
        } catch (e) {
          console.error('Error formatting interests:', e);
          document.getElementById('intereses-display').textContent = user.intereses.toString();
        }
      } else {
        document.getElementById('intereses-display').textContent = 'No especificado';
        console.log('‚ÑπÔ∏è No interests data, showing default');
      }

      // Read-only fields - with enhanced debugging and validation
      console.log('üîç Raw fecha_nacimiento:', user.fecha_nacimiento);
      console.log('üîç Type of fecha_nacimiento:', typeof user.fecha_nacimiento);
      console.log('üîç Raw fecha_inscripcion:', user.fecha_inscripcion);
      console.log('üîç Type of fecha_inscripcion:', typeof user.fecha_inscripcion);
      
      // Birth date with better validation
      if (user.fecha_nacimiento && user.fecha_nacimiento !== null && user.fecha_nacimiento !== '' && user.fecha_nacimiento !== 'null') {
        try {
          const formattedDate = formatDate(user.fecha_nacimiento);
          document.getElementById('fecha-nacimiento-display').textContent = formattedDate;
          console.log('‚úÖ Birth date displayed:', formattedDate);
        } catch (e) {
          console.error('Error formatting birth date:', e);
          document.getElementById('fecha-nacimiento-display').textContent = 'Fecha inv√°lida';
        }
      } else {
        document.getElementById('fecha-nacimiento-display').textContent = 'No especificado';
        console.log('‚ÑπÔ∏è No birth date data, showing default');
      }
      
      // Registration date with better validation
      if (user.fecha_inscripcion && user.fecha_inscripcion !== null && user.fecha_inscripcion !== '' && user.fecha_inscripcion !== 'null') {
        try {
          const formattedDate = formatDate(user.fecha_inscripcion);
          document.getElementById('fecha-inscripcion-display').textContent = formattedDate;
          console.log('‚úÖ Registration date displayed:', formattedDate);
        } catch (e) {
          console.error('Error formatting registration date:', e);
          document.getElementById('fecha-inscripcion-display').textContent = 'Fecha inv√°lida';
        }
      } else {
        document.getElementById('fecha-inscripcion-display').textContent = 'No especificado';
        console.log('‚ÑπÔ∏è No registration date data, showing default');
      }

      // Update avatar based on gender
      updateAvatar(user.genero);
      
      console.log('‚úÖ All user data displayed');
    }

    // Display session data as fallback when database fails
    function displaySessionData(sessionUser) {
      console.log('Displaying session data as fallback:', sessionUser);
      
      // Create temporary user data structure for editing
      currentUserData = {
        username: sessionUser.username || 'Usuario',
        email: sessionUser.email || '',
        telefono: '',
        genero: 'n',
        intereses: '',
        fecha_nacimiento: '',
        fecha_inscripcion: new Date().toISOString().split('T')[0],
        rol: sessionUser.rol || 'estudiante',
        codigo_usuario: sessionUser.codigo || `USER_${Date.now()}`
      };
      
      // Header info
      document.getElementById('user-display-name').textContent = sessionUser.username || 'Usuario';
      document.getElementById('user-role').textContent = `Rol: ${sessionUser.rol || 'No especificado'}`;
      document.getElementById('user-code').textContent = `C√≥digo: ${sessionUser.codigo || 'No asignado'}`;

      // Profile fields - show editable session data
      document.getElementById('name-display').textContent = sessionUser.username || 'No especificado';
      document.getElementById('email-display').textContent = sessionUser.email || 'No especificado';
      document.getElementById('telefono-display').textContent = 'Agregar tel√©fono';
      document.getElementById('genero-display').textContent = 'Seleccionar g√©nero';
      document.getElementById('intereses-display').textContent = 'Agregar intereses';
      document.getElementById('fecha-nacimiento-display').textContent = 'Agregar fecha de nacimiento';
      document.getElementById('fecha-inscripcion-display').textContent = new Date().toLocaleDateString('es-ES');

      // Keep edit icons visible for editing
      const editIcons = document.querySelectorAll('.edit-icon');
      editIcons.forEach(icon => {
        icon.style.display = 'inline';
        icon.style.color = '#22c55e'; // Green to indicate they can add data
      });

      // Update avatar to default
      updateAvatar('n');
      
      showMessage('üìù Datos de sesi√≥n - Puedes editar y agregar informaci√≥n. Los cambios se guardar√°n cuando crees tu usuario en la base de datos.', 'info');
    }

    // Create user in database directly from profile page
    async function createUserInDatabase() {
      try {
        const userSession = localStorage.getItem('currentUser');
        if (!userSession) {
          showMessage('No hay sesi√≥n activa para crear usuario.', 'error');
          return;
        }

        const sessionUser = JSON.parse(userSession);
        
        showMessage('Creando usuario en la base de datos...', 'info');

        // Use current edited data if available, otherwise use defaults
        const userData = {
          username: currentUserData?.username || sessionUser.username || 'Usuario',
          email: currentUserData?.email || sessionUser.email || 'sin-email@example.com',
          password: 'temporal123', // Temporary password
          telefono: currentUserData?.telefono || '+506-0000-0000',
          fecha_nacimiento: currentUserData?.fecha_nacimiento || '1990-01-01',
          rol: sessionUser.rol || 'estudiante',
          fecha_inscripcion: currentUserData?.fecha_inscripcion || new Date().toISOString().split('T')[0],
          codigo_usuario: currentUserData?.codigo_usuario || sessionUser.codigo || `USER_${Date.now()}`,
          genero: currentUserData?.genero || 'n',
          intereses: currentUserData?.intereses || 'programacion'
        };

        console.log('Creating user with current data:', userData);

        const response = await fetch('https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios', {
          method: 'POST',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(userData)
        });

        if (response.ok) {
          const result = await response.json();
          console.log('User created successfully:', result);
          
          // Update session with the new code
          sessionUser.codigo = userData.codigo_usuario;
          localStorage.setItem('currentUser', JSON.stringify(sessionUser));
          
          showMessage('‚úÖ Usuario creado exitosamente con todos tus cambios. Recargando perfil...', 'success');
          
          // Reload user data
          setTimeout(() => {
            loadUserData();
          }, 1500);
          
        } else {
          const errorText = await response.text();
          console.error('Error creating user:', errorText);
          
          if (response.status === 409 || errorText.includes('duplicate')) {
            showMessage('‚ö†Ô∏è El usuario ya existe. Intentando buscar nuevamente...', 'warning');
            setTimeout(() => {
              loadUserData();
            }, 1000);
          } else {
            showMessage(`‚ùå Error al crear usuario: ${response.status} - ${errorText}`, 'error');
          }
        }
      } catch (error) {
        console.error('Error creating user:', error);
        showMessage('Error de conexi√≥n al crear usuario: ' + error.message, 'error');
      }
    }

    // Show guest profile with limited data
    function showGuestProfile(sessionUser) {
      document.getElementById('user-display-name').textContent = sessionUser.username;
      document.getElementById('user-role').textContent = `Rol: ${sessionUser.rol}`;
      document.getElementById('user-code').textContent = `C√≥digo: ${sessionUser.codigo}`;
      
      // Hide edit icons for guest
      const editIcons = document.querySelectorAll('.edit-icon');
      editIcons.forEach(icon => icon.style.display = 'none');
      
      // Show guest message
      showMessage('Perfil de invitado - Solo vista. Para editar, reg√≠strate como usuario.', 'info');
    }

    // Edit field function
    function editField(fieldName) {
      if (!currentUserData) {
        showMessage('No se pueden editar datos sin informaci√≥n del usuario.', 'error');
        return;
      }

      // Store original value
      const displayElement = document.getElementById(`${fieldName}-display`);
      const editElement = document.getElementById(`${fieldName}-edit`);
      const buttonsElement = document.getElementById(`${fieldName}-buttons`);

      // Map frontend field names to database field names
      const fieldMapping = {
        'name': 'username',
        'telefono': 'telefono',
        'email': 'email',
        'genero': 'genero',
        'intereses': 'intereses'
      };
      
      const dbFieldName = fieldMapping[fieldName] || fieldName;

      if (fieldName === 'intereses') {
        // Handle interests checkboxes
        const currentInterests = currentUserData[dbFieldName] ? currentUserData[dbFieldName].split(',') : [];
        const checkboxes = editElement.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
          checkbox.checked = currentInterests.includes(checkbox.value);
        });
        originalValues[fieldName] = currentUserData[dbFieldName] || '';
      } else if (fieldName === 'genero') {
        // Handle gender select
        editElement.value = currentUserData[dbFieldName] || 'n';
        originalValues[fieldName] = currentUserData[dbFieldName] || 'n';
      } else {
        // Handle text inputs
        editElement.value = currentUserData[dbFieldName] || '';
        originalValues[fieldName] = currentUserData[dbFieldName] || '';
      }

      console.log(`Editing field: ${fieldName} (DB: ${dbFieldName}), Current value:`, currentUserData[dbFieldName]);

      // Show edit mode
      displayElement.style.display = 'none';
      editElement.style.display = 'block';
      buttonsElement.style.display = 'block';
    }

    // Cancel edit
    function cancelEdit(fieldName) {
      const displayElement = document.getElementById(`${fieldName}-display`);
      const editElement = document.getElementById(`${fieldName}-edit`);
      const buttonsElement = document.getElementById(`${fieldName}-buttons`);

      // Hide edit mode
      displayElement.style.display = 'block';
      editElement.style.display = 'none';
      buttonsElement.style.display = 'none';
    }

    // Save field
    async function saveField(fieldName) {
      try {
        let newValue;
        const editElement = document.getElementById(`${fieldName}-edit`);

        // Map frontend field names to database field names
        const fieldMapping = {
          'name': 'username',
          'telefono': 'telefono',
          'email': 'email',
          'genero': 'genero',
          'intereses': 'intereses'
        };
        
        const dbFieldName = fieldMapping[fieldName] || fieldName;

        if (fieldName === 'intereses') {
          // Handle interests checkboxes
          const checkedBoxes = editElement.querySelectorAll('input[type="checkbox"]:checked');
          newValue = Array.from(checkedBoxes).map(cb => cb.value).join(',');
        } else {
          newValue = editElement.value;
        }

        console.log(`üîÑ SAVING: ${fieldName} (DB: ${dbFieldName}) = "${newValue}"`);

        if (!currentUserData || !currentUserData.email) {
          showMessage('‚ùå Error: No hay datos de usuario para actualizar', 'error');
          return;
        }

        // DIRECT DATABASE UPDATE - NO COMPLEX LOGIC
        showMessage(`Guardando ${fieldName}...`, 'info');
        
        const updateSuccess = await updateUserField(dbFieldName, newValue);
        
        if (updateSuccess) {
          // Update local data
          currentUserData[dbFieldName] = newValue;
          
          // Update display immediately
          if (fieldName === 'genero') {
            const genderMap = { 'm': 'Masculino', 'f': 'Femenino', 'o': 'Otro', 'n': 'Prefiero no decir' };
            document.getElementById(`${fieldName}-display`).textContent = genderMap[newValue] || 'Seleccionar g√©nero';
            updateAvatar(newValue);
          } else if (fieldName === 'intereses') {
            const displayText = newValue ? newValue.split(',').join(', ') : 'Agregar intereses';
            document.getElementById(`${fieldName}-display`).textContent = displayText;
          } else {
            const displayText = newValue || (fieldName === 'telefono' ? 'Agregar tel√©fono' : 'No especificado');
            document.getElementById(`${fieldName}-display`).textContent = displayText;
          }

          // Update header if name changed
          if (fieldName === 'name') {
            document.getElementById('user-display-name').textContent = newValue || 'Usuario';
          }

          cancelEdit(fieldName);
          showMessage(`‚úÖ ${fieldName} actualizado correctamente!`, 'success');
          
        } else {
          showMessage(`‚ùå Error al guardar ${fieldName}. Revisa la consola para detalles.`, 'error');
        }

      } catch (error) {
        console.error('‚ùå Error saving field:', error);
        showMessage('‚ùå Error cr√≠tico al guardar: ' + error.message, 'error');
      }
    }

    // Check if email exists for another user
    async function checkEmailExists(email, currentEmail) {
      if (email === currentEmail) return false; // Same email, no conflict
      
      try {
        const searchUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email=eq.${encodeURIComponent(email)}`;
        
        const response = await fetch(searchUrl, {
          method: 'GET',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Accept': 'application/json'
          }
        });

        if (response.ok) {
          const users = await response.json();
          return users && users.length > 0;
        }
        return false;
      } catch (error) {
        console.error('Error checking email:', error);
        return false;
      }
    }

    // Check if user exists in database
    async function checkUserExistsInDatabase(email) {
      try {
        const searchUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email=eq.${encodeURIComponent(email)}`;
        
        const response = await fetch(searchUrl, {
          method: 'GET',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Accept': 'application/json'
          }
        });

        if (response.ok) {
          const users = await response.json();
          return users && users.length > 0;
        }
        return false;
      } catch (error) {
        console.error('Error checking user existence:', error);
        return false;
      }
    }

    // Update user field in database
    async function updateUserField(fieldName, newValue) {
      try {
        const updateData = {};
        updateData[fieldName] = newValue;

        console.log('Updating database field:', fieldName, 'with value:', newValue);
        console.log('Update data:', updateData);
        console.log('User email for update:', currentUserData.email);

        const updateUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email=eq.${encodeURIComponent(currentUserData.email)}`;
        
        console.log('Update URL:', updateUrl);
        
        const response = await fetch(updateUrl, {
          method: 'PATCH',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify(updateData)
        });

        console.log('Update response status:', response.status);
        console.log('Update response headers:', response.headers);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Update failed with status:', response.status);
          console.error('Error response:', errorText);
          
          // Show detailed error to user
          showMessage(`‚ùå Error de base de datos (${response.status}): ${errorText}`, 'error');
          return false;
        } else {
          console.log('Update successful!');
          return true;
        }

      } catch (error) {
        console.error('Network/fetch error updating field:', error);
        showMessage(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
        return false;
      }
    }

    // Update avatar based on gender
    function updateAvatar(gender) {
      const avatar = document.getElementById('user-avatar');
      const avatarMap = {
        'm': 'images/Male.png',
        'f': 'images/Female.png',
        'o': 'images/Other.png',
        'n': 'images/incognito.png'
      };
      
      if (avatarMap[gender]) {
        avatar.src = avatarMap[gender];
      }
    }

    // Format date for display with better error handling
    function formatDate(dateString) {
      console.log('üìÖ Formatting date:', dateString, typeof dateString);
      
      if (!dateString || dateString === null || dateString === '' || dateString === 'null') {
        console.log('üìÖ No valid date string provided');
        return 'No especificado';
      }
      
      try {
        // Handle different date formats
        let date;
        if (dateString.includes('T')) {
          // ISO format with time
          date = new Date(dateString);
        } else if (dateString.includes('-')) {
          // Date format YYYY-MM-DD
          date = new Date(dateString + 'T00:00:00');
        } else {
          // Try as-is
          date = new Date(dateString);
        }
        
        // Check if date is valid
        if (isNaN(date.getTime())) {
          console.error('üìÖ Invalid date:', dateString);
          return 'Fecha inv√°lida';
        }
        
        const formatted = date.toLocaleDateString('es-ES', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        
        console.log('üìÖ Formatted result:', formatted);
        return formatted;
        
      } catch (error) {
        console.error('üìÖ Error formatting date:', error);
        return 'Error en fecha';
      }
    }

    // Show message function
    function showMessage(message, type) {
      const messageArea = document.getElementById('message-area');
      messageArea.textContent = message;
      messageArea.style.display = 'block';
      
      // Set color based on type
      switch(type) {
        case 'success':
          messageArea.style.backgroundColor = '#22c55e';
          messageArea.style.color = 'white';
          break;
        case 'error':
          messageArea.style.backgroundColor = '#ef4444';
          messageArea.style.color = 'white';
          break;
        case 'info':
          messageArea.style.backgroundColor = '#3b82f6';
          messageArea.style.color = 'white';
          break;
        case 'warning':
          messageArea.style.backgroundColor = '#f59e0b';
          messageArea.style.color = 'white';
          break;
        default:
          messageArea.style.backgroundColor = '#6b7280';
          messageArea.style.color = 'white';
      }

      // Auto-hide success messages
      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          messageArea.style.display = 'none';
        }, 3000);
      }
    }

    // Debug functions
    async function testDatabaseConnection() {
      try {
        const response = await fetch('https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?limit=1', {
          method: 'GET',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Accept': 'application/json'
          }
        });
        
        if (response.ok) {
          showMessage('‚úÖ Database connection OK!', 'success');
        } else {
          showMessage(`‚ùå DB connection failed: ${response.status}`, 'error');
        }
      } catch (error) {
        showMessage(`‚ùå DB connection error: ${error.message}`, 'error');
      }
    }

    function showCurrentUserData() {
      console.log('=== CURRENT USER DATA ===');
      console.log('currentUserData:', currentUserData);
      console.log('Session data:', localStorage.getItem('currentUser'));
      console.log('========================');
      showMessage('Check console for current user data', 'info');
    }

    async function testTelefonoUpdate() {
      if (!currentUserData || !currentUserData.email) {
        showMessage('‚ùå No user data loaded', 'error');
        return;
      }
      
      const testPhone = `+506-${Math.floor(Math.random() * 9000) + 1000}-${Math.floor(Math.random() * 9000) + 1000}`;
      console.log('Testing telefono update with:', testPhone);
      
      const success = await updateUserField('telefono', testPhone);
      
      if (success) {
        document.getElementById('telefono-display').textContent = testPhone;
        currentUserData.telefono = testPhone;
        showMessage('‚úÖ Telefono test update successful!', 'success');
      } else {
        showMessage('‚ùå Telefono test update failed!', 'error');
      }
    }

    // Fix missing database fields
    async function fixMissingFields() {
      if (!currentUserData || !currentUserData.email) {
        showMessage('‚ùå No user data loaded', 'error');
        return;
      }

      console.log('üîß Checking and fixing missing fields...');
      showMessage('Verificando y corrigiendo campos faltantes...', 'info');

      const fixes = {};
      let needsUpdate = false;

      // Check and fix interests
      if (!currentUserData.intereses || currentUserData.intereses === null || currentUserData.intereses === '' || currentUserData.intereses === 'null') {
        fixes.intereses = 'programacion';
        needsUpdate = true;
        console.log('üîß Will fix missing interests');
      }

      // Check and fix birth date
      if (!currentUserData.fecha_nacimiento || currentUserData.fecha_nacimiento === null || currentUserData.fecha_nacimiento === '' || currentUserData.fecha_nacimiento === 'null') {
        fixes.fecha_nacimiento = '1990-01-01';
        needsUpdate = true;
        console.log('üîß Will fix missing birth date');
      }

      // Check and fix registration date
      if (!currentUserData.fecha_inscripcion || currentUserData.fecha_inscripcion === null || currentUserData.fecha_inscripcion === '' || currentUserData.fecha_inscripcion === 'null') {
        fixes.fecha_inscripcion = new Date().toISOString().split('T')[0];
        needsUpdate = true;
        console.log('üîß Will fix missing registration date');
      }

      if (needsUpdate) {
        console.log('üîß Applying fixes:', fixes);
        
        const updateUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email=eq.${encodeURIComponent(currentUserData.email)}`;
        
        try {
          const response = await fetch(updateUrl, {
            method: 'PATCH',
            headers: {
              'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
              'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
              'Content-Type': 'application/json',
              'Prefer': 'return=minimal'
            },
            body: JSON.stringify(fixes)
          });

          if (response.ok) {
            console.log('‚úÖ Fields fixed successfully');
            showMessage('‚úÖ Campos corregidos. Recargando perfil...', 'success');
            
            // Update local data
            Object.assign(currentUserData, fixes);
            
            // Refresh display
            setTimeout(() => {
              loadUserData();
            }, 1000);
            
          } else {
            const errorText = await response.text();
            console.error('‚ùå Error fixing fields:', errorText);
            showMessage(`‚ùå Error al corregir campos: ${response.status}`, 'error');
          }
        } catch (error) {
          console.error('‚ùå Network error fixing fields:', error);
          showMessage(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
        }
      } else {
        console.log('‚úÖ All fields have data');
        showMessage('‚úÖ Todos los campos tienen datos v√°lidos', 'success');
      }
    }
  </script>
</body>
</html>
