<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Usuario - Galaxia Magna Academy</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

  <!--
    HEADER (Encabezado):
    Aqu√≠ va el t√≠tulo principal de la p√°gina. Sirve para que el usuario sepa d√≥nde est√° y da identidad al sitio.
    Puedes poner el nombre de la plataforma, el logo o ambos.
  -->
  <header>
    <img src="images/GAM_transparent.png" alt="Galaxia Magna Academy Logo" style="width: 80px; height: 80px; object-fit: contain;">
    <div class="header-text">
      <h1>Galaxia Magna Academy</h1>
      <h2>Sapientia per Stellam</h2>
    </div>
    <img src="images/GAM_transparent.png" alt="GMA Logo" style="width: 80px; height: 80px; object-fit: contain;">
  </header>

  <main>
        
        if (response.ok) {
          const result = await response.json();
          console.log('Registration successful, server response:', result);
          
          // Ocultar mensaje de carga
          registroMsg.style.display = 'none';
          
          // Verificar si fue exitoso
          if (result && result.length > 0) {
            console.log('User created successfully:', result[0]);
            // Mostrar popup de √©xito con informaci√≥n del usuario
            try {
              mostrarPopupExito(result[0], registroData);
            } catch (popupError) {
              console.error('Error showing popup:', popupError);
              // Fallback: mostrar alerta b√°sica
              alert(`‚úÖ Usuario registrado exitosamente!\n\nC√≥digo: ${result[0].codigo_usuario}\nNombre: ${registroData.username}\nEmail: ${registroData.email}`);
            }
            
            // Limpiar formulario inmediatamente
            form.reset();
            document.getElementById('codigo-estudiante').value = '';
            rolValidado = false;
            document.getElementById('password-rol-container').style.display = 'none';
            
            // Restablecer fecha de inscripci√≥n
            const fechaInscripcion = document.getElementById('fecha-inscripcion');
            const hoy = new Date().toISOString().split('T')[0];
            fechaInscripcion.value = hoy;
          } else {
            // Ocultar mensaje de carga
            registroMsg.style.display = 'none';
            alert('‚ö†Ô∏è Respuesta inesperada del servidor');
          }
          
        } else {
          // Error HTTP
          registroMsg.style.display = 'none'; // Ocultar mensaje de carga
          const errorText = await response.text();
          console.error('HTTP Error:', response.status, errorText);
          
          // Provide specific error messages based on status code
          if (response.status === 409) {
            alert('‚ùå Error: Este email ya est√° registrado en el sistema. Use un email diferente.');
          } else if (response.status === 400) {
            if (errorText.includes('duplicate') || errorText.includes('unique')) {
              alert('‚ùå Error: Ya existe un usuario con este email o c√≥digo. Verifique los datos.');
            } else {
              alert('‚ùå Error de datos: ' + errorText);
            }
          } else if (response.status === 422) {
            alert('‚ùå Error: Datos inv√°lidos. Verifique que todos los campos est√©n correctos.');
          } else {
            alert('‚ùå Error del servidor (' + response.status + '): ' + errorText);
          }
        }
        
      } catch (error) {
        console.error('Error:', error);
        
        // Ocultar mensaje de carga
        registroMsg.style.display = 'none';
        
        // Mostrar alerta de error
        alert('‚ùå Error al registrar usuario. Intente nuevamente.\n\nError: ' + error.message);
      }
    }
    
    // Auto-generar c√≥digo cuando la p√°gina carga si ya hay datos
    document.addEventListener('DOMContentLoaded', function() {
      // Establecer fecha actual como fecha de inscripci√≥n por defecto
      const fechaInscripcion = document.getElementById('fecha-inscripcion');
      const hoy = new Date().toISOString().split('T')[0];
      fechaInscripcion.value = hoy;
      
      // Agregar validaci√≥n al formulario
      const form = document.querySelector('form');
      if (form) {
        form.addEventListener('submit', validarFormulario);
      }
      
      // Configurar validaci√≥n inicial del rol
      manejarCambioRol();
      
      // Generar c√≥digo inicial si hay rol seleccionado
      generarCodigoEstudiante();
    });
    
    // Variables globales para el popup
    let currentUserCode = '';
    let currentUserData = {};
    
    // Funci√≥n para mostrar el popup de √©xito
    function mostrarPopupExito(usuarioCreado, datosFormulario) {
      console.log('mostrarPopupExito called with:', usuarioCreado, datosFormulario);
      
      try {
        // Guardar informaci√≥n para las funciones de guardado
        currentUserCode = usuarioCreado.codigo_usuario;
        currentUserData = {
          nombre: datosFormulario.username,
          email: datosFormulario.email,
          rol: datosFormulario.rol,
          codigo: usuarioCreado.codigo_usuario
        };
        
        // Llenar la informaci√≥n en el popup
        document.getElementById('popup-username-value').textContent = datosFormulario.username;
        document.getElementById('popup-email-value').textContent = datosFormulario.email;
        document.getElementById('popup-rol-value').textContent = capitalizeFirstLetter(datosFormulario.rol);
        document.getElementById('popup-code-value').textContent = usuarioCreado.codigo_usuario;
        
        // Mostrar el popup con efecto de fade
        const popup = document.getElementById('success-popup');
        if (!popup) {
          console.error('Popup element not found!');
          return;
        }
        
        popup.style.display = 'flex';
        popup.style.opacity = '0';
        
        // Animaci√≥n de entrada
        setTimeout(() => {
          popup.style.transition = 'opacity 0.3s ease-in-out';
          popup.style.opacity = '1';
        }, 50);
        
        // Reproducir sonido de √©xito si est√° disponible
        try {
          playLightsaberSound();
        } catch (e) {
          console.log('Sonido no disponible');
        }
        
        console.log('Popup shown successfully');
      } catch (error) {
        console.error('Error in mostrarPopupExito:', error);
        throw error; // Re-throw to be caught by the calling function
      }
    }
    
    // Funci√≥n para copiar c√≥digo al portapapeles
    function copiarCodigoAlPortapapeles() {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(currentUserCode).then(() => {
          mostrarMensajeTemporalEnBoton('üìã Copiar C√≥digo', '‚úÖ ¬°Copiado!');
        }).catch(err => {
          console.error('Error al copiar:', err);
          fallbackCopiarTexto(currentUserCode);
        });
      } else {
        fallbackCopiarTexto(currentUserCode);
      }
    }
    
    // Funci√≥n fallback para copiar en navegadores antiguos
    function fallbackCopiarTexto(texto) {
      const textArea = document.createElement('textarea');
      textArea.value = texto;
      textArea.style.position = 'fixed';
      textArea.style.opacity = '0';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          mostrarMensajeTemporalEnBoton('üìã Copiar C√≥digo', '‚úÖ ¬°Copiado!');
        } else {
          alert('C√≥digo: ' + texto + '\n\nCopia manualmente este c√≥digo.');
        }
      } catch (err) {
        alert('C√≥digo: ' + texto + '\n\nCopia manualmente este c√≥digo.');
      } finally {
        document.body.removeChild(textArea);
      }
    }
    
    // Funci√≥n para guardar c√≥digo como archivo
    function guardarCodigoArchivo() {
      const contenido = `GALAXIA MAGNA ACADEMY - INFORMACI√ìN DE USUARIO
========================================

Nombre: ${currentUserData.nombre}
Email: ${currentUserData.email}
Rol: ${capitalizeFirstLetter(currentUserData.rol)}
C√≥digo de Usuario: ${currentUserData.codigo}
Fecha de Registro: ${new Date().toLocaleDateString('es-ES')}

========================================
IMPORTANTE: Guarda este c√≥digo para iniciar sesi√≥n
========================================`;

      const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `GMA_Usuario_${currentUserData.codigo}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      mostrarMensajeTemporalEnBoton('üíæ Guardar como Archivo', '‚úÖ ¬°Guardado!');
    }
    
    // Funci√≥n para mostrar mensaje temporal en bot√≥n
    function mostrarMensajeTemporalEnBoton(textoOriginal, textoTemporal) {
      const botones = document.querySelectorAll('#success-popup button');
      botones.forEach(boton => {
        if (boton.textContent.includes(textoOriginal.split(' ')[1])) {
          const textoAnterior = boton.textContent;
          boton.textContent = textoTemporal;
          boton.style.background = '#22c55e';
          setTimeout(() => {
            boton.textContent = textoAnterior;
            boton.style.background = '';
          }, 2000);
        }
      });
    }
    
    // Funci√≥n para cerrar popup y volver al inicio
    function cerrarPopupYVolverInicio() {
      const popup = document.getElementById('success-popup');
      popup.style.transition = 'opacity 0.3s ease-in-out';
      popup.style.opacity = '0';
      
      setTimeout(() => {
        popup.style.display = 'none';
        // Redirigir al inicio
        window.location.href = 'index.html';
      }, 300);
    }
    
    // Funci√≥n auxiliar para capitalizar primera letra
    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }
    
    // Cerrar popup si se hace clic fuera de √©l
    document.addEventListener('click', function(e) {
      const popup = document.getElementById('success-popup');
      if (e.target === popup) {
        cerrarPopupYVolverInicio();
      }
    });
    
    // Cerrar popup con tecla Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const popup = document.getElementById('success-popup');
        const clubPopup = document.getElementById('club-info-popup');
        if (popup.style.display === 'flex') {
          cerrarPopupYVolverInicio();
        }
        if (clubPopup && clubPopup.style.display === 'flex') {
          cerrarPopupClubInfo();
        }
      }
    });

    // Funci√≥n para mostrar popup de informaci√≥n de clubes
    function mostrarPopupClubInfo() {
      const popup = document.getElementById('club-info-popup');
      popup.style.display = 'flex';
      popup.style.opacity = '0';
      setTimeout(() => {
        popup.style.transition = 'opacity 0.3s ease-in-out';
        popup.style.opacity = '1';
      }, 50);
    }

    // Funci√≥n para cerrar popup de informaci√≥n de clubes
    function cerrarPopupClubInfo() {
      const popup = document.getElementById('club-info-popup');
      popup.style.transition = 'opacity 0.3s ease-in-out';
      popup.style.opacity = '0';
      setTimeout(() => {
        popup.style.display = 'none';
      }, 300);
    }

    // Agregar event listener para el icono de informaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
      const infoIcon = document.getElementById('info-club');
      if (infoIcon) {
        infoIcon.addEventListener('click', mostrarPopupClubInfo);
      }

      // Cerrar popup de clubes si se hace clic fuera
      document.addEventListener('click', function(e) {
        const clubPopup = document.getElementById('club-info-popup');
        if (e.target === clubPopup) {
          cerrarPopupClubInfo();
        }
      });
    });
  </script>
</body>
</html>
