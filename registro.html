<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Usuario - Galaxia Magna Academy</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

  <!--
    HEADER (Encabezado):
    Aqu√≠ va el t√≠tulo principal de la p√°gina. Sirve para que el usuario sepa d√≥nde est√° y da identidad al sitio.
    Puedes poner el nombre de la plataforma, el logo o ambos.
  -->
  <header style="display: flex; align-items: center; justify-content: center; gap: 20px; padding: 20px;">
    <img src="images/GAM_transparent.png" alt="Galaxia Magna Academy Logo" style="width: 80px; height: 80px; object-fit: contain;">
    <div style="text-align: center;">
      <h1 style="color: #C0C0C0; margin-bottom: 5px; margin-top: 0;">Galaxia Magna Academy</h1>
      <h2 style="font-style: italic; font-weight: normal; font-size: 1.8em; margin-top: 0; color: #C0C0C0; margin-bottom: 0;">Sapientia per Stellam</h2>
    </div>
    <img src="images/GAM_transparent.png" alt="GMA Logo" style="width: 80px; height: 80px; object-fit: contain;">
  </header>

  <main>
    <!-- Success Popup Modal -->
    <div id="success-popup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
      <div style="background: #23232b; border-radius: 16px; padding: 40px; max-width: 500px; margin: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); border: 2px solid #f18b32; text-align: center;">
        <div style="margin-bottom: 20px;">
          <i style="font-size: 36px; color: #f18b32;">‚úÖ</i>
        </div>
        <h3 style="color: #f18b32; margin-bottom: 16px; font-size: 1.4em;">¬°Usuario Registrado Exitosamente!</h3>
        <p style="color: #c9c9c9; margin-bottom: 8px; font-size: 1.0em;" id="popup-username">Usuario: <span id="popup-username-value"></span></p>
        <p style="color: #c9c9c9; margin-bottom: 8px; font-size: 1.0em;" id="popup-email">Email: <span id="popup-email-value"></span></p>
        <p style="color: #c9c9c9; margin-bottom: 20px; font-size: 1.0em;" id="popup-rol">Rol: <span id="popup-rol-value"></span></p>
        
        <div style="background: #2d2d35; border-radius: 8px; padding: 20px; margin: 20px 0; border: 1px solid #4a4a55;">
          <p style="color: #f18b32; margin-bottom: 8px; font-weight: bold; font-size: 1.0em;">C√≥digo de Usuario:</p>
          <p style="color: #c9c9c9; font-size: 1.2em; font-weight: bold; font-family: monospace; margin-bottom: 12px;" id="popup-code-value"></p>
          <p style="color: #a1a1aa; font-size: 0.9em; margin-bottom: 12px;">‚ö†Ô∏è Por favor, guarda este c√≥digo. Lo necesitar√°s para iniciar sesi√≥n.</p>
          <button onclick="copiarCodigoAlPortapapeles()" style="background: #4a5568; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; margin-right: 10px;">
            üìã Copiar C√≥digo
          </button>
          <button onclick="guardarCodigoArchivo()" style="background: #2d3748; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
            üíæ Guardar como Archivo
          </button>
        </div>
        
        <div style="margin-top: 24px;">
          <button onclick="cerrarPopupYVolverInicio()" style="background: #f18b32; color: white; border: none; padding: 12px 32px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.0em;">
            Entendido, ir al Inicio
          </button>
        </div>
      </div>
    </div>

    <!-- Club Information Popup Modal -->
    <div id="club-info-popup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
      <div style="background: #23232b; border-radius: 16px; padding: 40px; max-width: 600px; margin: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); border: 2px solid #f18b32; text-align: left;">
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
          <i style="font-size: 24px; color: #f18b32; margin-right: 12px;">‚ÑπÔ∏è</i>
          <h3 style="color: #f18b32; margin: 0; font-size: 1.3em;">Informaci√≥n sobre los Clubes</h3>
        </div>
        
        <div style="color: #c9c9c9; line-height: 1.6; font-size: 1.0em; margin-bottom: 24px;">
          <p style="margin-bottom: 14px;">
            Unirse a un club universitario es una oportunidad
            para conocer personas con intereses similares,
            desarrollar nuevas habilidades
            y enriquecer la experiencia acad√©mica
            con actividades fuera de las clases.
          </p>
          
          <p style="margin-bottom: 14px;">
            Aunque es totalmente opcional,
            participar en un club puede abrir puertas
            a amistades duraderas
            y a un crecimiento personal que complementa tu formaci√≥n.
          </p>
          
          <p style="margin-bottom: 0; color: #f18b32; font-weight: bold;">
            Adem√°s, ganar√°s puntos extra
            que te ayudar√°n a cumplir m√°s f√°cilmente
            los requisitos para la graduaci√≥n.
          </p>
        </div>
        
        <div style="text-align: center;">
          <button onclick="cerrarPopupClubInfo()" style="background: #f18b32; color: white; border: none; padding: 12px 32px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.1em;">
            Entendido
          </button>
        </div>
      </div>
    </div>

    <section>
      <!--
        FORMULARIO DE REGISTRO:
        P√°gina dedicada al registro de nuevos usuarios.
        Accesible solo para administradores.
      -->

      <!-- Navigation -->
      <nav style="margin-bottom: 20px;">
        <ul>
          <li><a href="index.html">‚Üê Volver al Inicio</a></li>
          <li><a href="#ayuda">Ayuda</a></li>
        </ul>
      </nav>

      <!-- Mensaje de registro -->
      <div id="registro-msg" style="display:none; font-weight:bold; margin-bottom:16px;"></div>
      
      <h2 style="color: #f18b32; text-align: center; margin-bottom: 30px;">Registro de Nuevo Usuario</h2>
      <p style="text-align: center; color: #C0C0C0; margin-bottom: 30px;">Panel de administraci√≥n para registro de usuarios</p>

      <form id="registro-form" method="post">

        <!--
          Cada grupo de campos tiene su propio div para que el label quede arriba del input.
          Esto mejora la legibilidad y la experiencia de usuario.
        -->

        <fieldset>
          <legend>Registro de usuario</legend>
          
          <!-- Row y Col: Sistema de columnas para organizar el contenido en filas y columnas -->
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <!-- Form-label: Etiqueta que describe el campo de entrada -->
                <label for="username" class="form-label">Nombre de Usuario:</label>
                <!-- Form-control: Estilo para campos de entrada como text, email, password -->
                <input class="form-control" type="text" id="username" name="username" required>
              </div>
              <div class="mb-3">
                <label for="email" class="form-label">Correo Electr√≥nico:</label>
                <input class="form-control" type="email" id="email" name="email" required oninput="document.getElementById('email-error').style.display='none'">
                <span id="email-error" style="color: #ff6b6b; display: none;">El correo debe contener un @</span>
              </div>
              <div class="mb-3">
                <label for="telefono" class="form-label">Tel√©fono de Contacto:</label>
                <input class="form-control" type="tel" id="telefono" name="telefono" placeholder="Ej: 8888-8888">
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="mb-3">
                <label for="password" class="form-label">Contrase√±a:</label>
                <input class="form-control" type="password" id="password" name="password" required>
              </div>
              <div class="mb-3">
                <label for="confirm-password" class="form-label">Confirmar Contrase√±a:</label>
                <input class="form-control" type="password" id="confirm-password" name="confirm-password" required>
              </div>
              <div class="mb-3">
                <label for="fecha-nacimiento" class="form-label">Fecha de Nacimiento:</label>
                <input class="form-control" type="date" id="fecha-nacimiento" name="fecha-nacimiento" required>
              </div>
            </div>
          </div>

          <!-- Segunda fila: Rol, Fecha de Inscripci√≥n y C√≥digo -->
          <div class="row mt-3">
            <div class="col-md-4">
              <div class="mb-3">
                <label for="rol" class="form-label">Rol:</label>
                <select class="form-select" id="rol" name="rol" required onchange="manejarCambioRol()">
                  <option value="">Seleccione un rol</option>
                  <option value="estudiante">Estudiante</option>
                  <option value="profesor">Profesor</option>
                  <option value="administrador">Administrador</option>
                </select>
              </div>
              <!-- Campo de contrase√±a para roles especiales -->
              <div class="mb-3" id="password-rol-container" style="display: none;">
                <label for="password-rol" class="form-label">Contrase√±a del rol:</label>
                <input class="form-control" type="password" id="password-rol" name="password-rol" placeholder="Ingrese la contrase√±a del rol">
                <small class="form-text text-muted" id="password-rol-hint"></small>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="fecha-inscripcion" class="form-label">Fecha de Inscripci√≥n:</label>
                <input class="form-control" type="date" id="fecha-inscripcion" name="fecha-inscripcion" required onchange="generarCodigoEstudiante()">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="codigo-estudiante" class="form-label">C√≥digo de Usuario:</label>
                <input class="form-control" type="text" id="codigo-estudiante" name="codigo-estudiante" readonly placeholder="Se genera autom√°ticamente" style="background-color: #f8f9fa;">
                <small class="form-text text-muted">Formato: AAAA_MM_ROL_0001</small>
              </div>
            </div>
          </div>

          <!--
            G√âNERO:
            Usa radio buttons para que el usuario solo pueda elegir una opci√≥n.
            Los labels est√°n en l√≠nea para que se vean ordenados.
          -->
          <fieldset class="mt-4">
            <legend>G√©nero</legend>
            <!-- Form-check: Contenedor para radio buttons y checkboxes -->
            <div class="form-check">
              <!-- Form-check-input: Radio buttons para seleccionar una opci√≥n -->
              <input class="form-check-input" type="radio" value="m" name="gender" id="g-m">
              <!-- Form-check-label: Etiqueta para radio buttons y checkboxes -->
              <label class="form-check-label" for="g-m">Masculino</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" value="f" name="gender" id="g-f">
              <label class="form-check-label" for="g-f">Femenino</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" value="o" name="gender" id="g-o">
              <label class="form-check-label" for="g-o">Otro</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" value="n" name="gender" id="g-n">
              <label class="form-check-label" for="g-n">Prefiero no decirlo</label>
            </div>
          </fieldset>

          <!--
            AVATAR DE G√âNERO:
            Muestra una imagen que cambia seg√∫n la selecci√≥n de g√©nero.
            Adem√°s, si pasas el mouse sobre el avatar, gira 360¬∞ (ver CSS para la animaci√≥n).
          -->
          <fieldset>
            <legend style="visibility: hidden; height: 0; margin: 0; padding: 0;"></legend>
            <div style="display: flex;">
              <div id="avatar-genero"
                class="img_box">
                <img id="img-avatar-genero"
                  src="images/GMA.png"
                  alt="Avatar G√©nero"
                  >
              </div>
            </div>
          </fieldset>

          <!--
            INTERESES:
            Usa checkboxes para que el usuario pueda elegir varios intereses.
            Al seleccionar un inter√©s, la imagen correspondiente se ilumina (ver JS y CSS).
            Si seleccionas Star Wars, aparece un mensaje especial que se desvanece (ver JS y CSS).
          -->
          <fieldset class="mt-4">
            <legend>Selecciona un club para unirte:</legend>
            <div class="mb-3">
              <label for="intereses" class="form-label">
                Elige tu club preferido:
                <i id="info-club" style="margin-left: 8px; color: #f18b32; cursor: pointer; font-size: 1.1em; border: 1px solid #f18b32; border-radius: 50%; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; font-style: normal; font-weight: bold;" title="Informaci√≥n sobre los clubes">i</i>
              </label>
              <select class="form-select" id="intereses" name="intereses" required onchange="manejarSeleccionClub()">
                <option value="ajedrez">Club de Ajedrez</option>
                <option value="arte">Club de Arte</option>
                <option value="deportes">Club de Deportes</option>
                <option value="idiomas">Club de Idiomas</option>
                <option value="matematica">Club de Matem√°tica</option>
                <option value="musica">Club de M√∫sica</option>
                <option value="programacion">Club de Programaci√≥n</option>
                <option value="starwars">Club Star Wars</option>
                <option value="otro">Otro club</option>
                <option value="ninguno">No estoy interesado</option>
              </select>
            </div>
            <!-- Mensaje especial de la fuerza para Star Wars -->
            <div id="fuerza-msg" style="display: none; text-align: center; margin-top: 15px; opacity: 0; transition: opacity 2s;">
              <div style="color: #f18b32; font-weight: bold; margin-bottom: 8px;">
                ‚ú® May the Force be with you! ‚ú®
              </div>
              <div style="color: #ffff00; font-weight: bold; font-style: italic;">
                The force is strong with this one.
              </div>
            </div>
          </fieldset>

          <!-- Mensaje especial de la fuerza prominente -->
          <div id="fuerza-msg-principal" style="text-align: center; margin: 20px 0; height: 40px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 2s;">
            <div style="color: #ffff00; font-weight: bold; font-style: italic; font-size: 1.4em; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); font-family: Arial, sans-serif;">
              The force is strong with this one.
            </div>
          </div>

          <!-- Botones de acci√≥n -->
          <div class="d-grid gap-2 d-md-flex justify-content-md-center" style="margin-top: 30px;">
            <button class="btn btn-primary me-md-2" type="submit">Registrar Usuario</button>
            <a href="index.html" class="btn btn-secondary">Cancelar</a>
          </div>
        </fieldset>
      </form>
    </section>

    <!-- P√°gina de Ayuda como subp√°gina -->
    <section id="ayuda" style="display:none; padding:40px 20px; max-width:600px; margin:40px auto; background:#23232b; border-radius:12px; box-shadow:0 4px 24px #0008; color:#fff;">
      <h2 style="color:#f18b32; margin-bottom:18px;">Ayuda</h2>
      <p>Esta es la <b>p√°gina de registro de usuarios</b> para administradores de la Galaxia Magna Academy.</p>
      <p>Aqu√≠ puedes registrar nuevos usuarios en el sistema proporcionando sus datos b√°sicos.</p>
      <p>Si tienes dudas o necesitas ayuda, puedes contactar a <b>Allan VillaLobos</b>.</p>
      <button id="cerrar-ayuda" style="margin-top:24px; padding:10px 30px; border-radius:8px; background:#2563eb; color:#fff; border:none; font-weight:bold; cursor:pointer;">Cerrar</button>
    </section>
  </main>

  <footer>
  </footer>

  <!--
    Caja informativa:
    Este bloque invita a los usuarios a aprender m√°s de HTML. El enlace lleva a W3Schools, un sitio recomendado para principiantes.
    TIP: Usa recursos externos para complementar tu aprendizaje.
  -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="script.js"></script>
  
  <script>
    // Contrase√±as para roles especiales
    const ROL_PASSWORDS = {
      'profesor': 'profesor',
      'administrador': 'admin'
    };
    
    // Variable para controlar si el rol est√° validado
    let rolValidado = false;
    
    // Funci√≥n para manejar cambios en el selector de rol
    function manejarCambioRol() {
      const rol = document.getElementById('rol').value;
      const passwordContainer = document.getElementById('password-rol-container');
      const passwordInput = document.getElementById('password-rol');
      const passwordHint = document.getElementById('password-rol-hint');
      
      // Resetear validaci√≥n
      rolValidado = false;
      
      if (rol === 'profesor' || rol === 'administrador') {
        // Mostrar campo de contrase√±a para roles especiales
        passwordContainer.style.display = 'block';
        passwordInput.required = true;
        passwordInput.value = '';
        
        // Configurar hint seg√∫n el rol
        if (rol === 'profesor') {
          passwordHint.textContent = 'Contrase√±a requerida para rol Profesor';
        } else if (rol === 'administrador') {
          passwordHint.textContent = 'Contrase√±a requerida para rol Administrador';
        }
        
        // Agregar validaci√≥n en tiempo real
        passwordInput.addEventListener('input', validarPasswordRol);
        
      } else {
        // Ocultar campo de contrase√±a para estudiante
        passwordContainer.style.display = 'none';
        passwordInput.required = false;
        passwordInput.value = '';
        rolValidado = true; // Estudiante no necesita validaci√≥n especial
      }
      
      // Generar c√≥digo solo si el rol est√° validado
      if (rolValidado || rol === 'estudiante') {
        generarCodigoEstudiante();
      } else {
        document.getElementById('codigo-estudiante').value = '';
      }
    }
    
    // Funci√≥n para validar la contrase√±a del rol
    function validarPasswordRol() {
      const rol = document.getElementById('rol').value;
      const passwordInput = document.getElementById('password-rol');
      const password = passwordInput.value;
      
      if (ROL_PASSWORDS[rol] && password === ROL_PASSWORDS[rol]) {
        // Contrase√±a correcta
        passwordInput.style.borderColor = '#28a745';
        passwordInput.style.backgroundColor = '#d4edda';
        rolValidado = true;
        generarCodigoEstudiante();
      } else if (password.length > 0) {
        // Contrase√±a incorrecta
        passwordInput.style.borderColor = '#dc3545';
        passwordInput.style.backgroundColor = '#f8d7da';
        rolValidado = false;
        document.getElementById('codigo-estudiante').value = '';
      } else {
        // Campo vac√≠o
        passwordInput.style.borderColor = '';
        passwordInput.style.backgroundColor = '';
        rolValidado = false;
        document.getElementById('codigo-estudiante').value = '';
      }
    }
    
    // Funci√≥n para generar c√≥digo √∫nico de estudiante (modificada)
    function generarCodigoEstudiante() {
      const fechaInscripcion = document.getElementById('fecha-inscripcion').value;
      const rol = document.getElementById('rol').value;
      const codigoInput = document.getElementById('codigo-estudiante');
      
      // Verificar si el rol necesita validaci√≥n y si est√° validado
      if ((rol === 'profesor' || rol === 'administrador') && !rolValidado) {
        codigoInput.value = '';
        return;
      }
      
      if (fechaInscripcion && rol) {
        const fecha = new Date(fechaInscripcion);
        const a√±o = fecha.getFullYear();
        const mes = String(fecha.getMonth() + 1).padStart(2, '0');
        
        // Definir prefijo seg√∫n el rol
        let prefijo;
        switch (rol) {
          case 'estudiante':
            prefijo = 'A';
            break;
          case 'profesor':
            prefijo = 'P';
            break;
          case 'administrador':
            prefijo = 'ADM';
            break;
          default:
            prefijo = 'A';
        }
        
        // Generar n√∫mero secuencial (simulado)
        const numeroSecuencial = String(Math.floor(Math.random() * 9999) + 1).padStart(4, '0');
        
        // Formato: AAAA_MM_ROL_0001
        const codigo = `${a√±o}_${mes}_${prefijo}_${numeroSecuencial}`;
        codigoInput.value = codigo;
      } else {
        codigoInput.value = '';
      }
    }
    
    // Funci√≥n para manejar la selecci√≥n de club
    function manejarSeleccionClub() {
      const club = document.getElementById('intereses').value;
      const fuerzaMsg = document.getElementById('fuerza-msg');
      const fuerzaMsgPrincipal = document.getElementById('fuerza-msg-principal');
      
      if (club === 'starwars') {
        // Reproducir sonido de lightsaber
        playLightsaberSound();
        
        // Mostrar mensaje de la fuerza en el √°rea de clubs
        fuerzaMsg.style.display = 'block';
        fuerzaMsg.style.opacity = '1';
        
        // Mostrar mensaje principal amarillo prominente (solo cambiar opacity)
        fuerzaMsgPrincipal.style.opacity = '1';
        
        // Fade out despu√©s de 4 segundos
        setTimeout(function() {
          fuerzaMsg.style.opacity = '0';
          fuerzaMsgPrincipal.style.opacity = '0';
          setTimeout(function() {
            fuerzaMsg.style.display = 'none';
          }, 2000);
        }, 4000);
      } else {
        // Ocultar mensajes si no es Star Wars
        fuerzaMsg.style.display = 'none';
        fuerzaMsg.style.opacity = '0';
        fuerzaMsgPrincipal.style.opacity = '0';
      }
    }

    // Funci√≥n para reproducir sonido de lightsaber cuando se selecciona Star Wars
    function playLightsaberSound() {
      const audio = new Audio('misc/lightsaber-ignition-6816.mp3');
      audio.volume = 0.5; // Volumen al 50%
      audio.play().catch(function(error) {
        console.log('Error al reproducir el sonido:', error);
      });
    }

    // Funci√≥n para validar formulario antes de enviar
    function validarFormulario(event) {
      event.preventDefault(); // Prevenir env√≠o por defecto
      
      // Validar campos b√°sicos
      const username = document.getElementById('username').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      const fechaNacimiento = document.getElementById('fecha-nacimiento').value;
      const rol = document.getElementById('rol').value;
      const fechaInscripcion = document.getElementById('fecha-inscripcion').value;
      const genero = document.querySelector('input[name="gender"]:checked');
      const club = document.getElementById('intereses').value;
      
      // Validaciones b√°sicas
      if (!username) {
        alert('‚ùå El nombre de usuario es obligatorio');
        document.getElementById('username').focus();
        return false;
      }
      
      if (!email || !email.includes('@')) {
        alert('‚ùå Ingrese un email v√°lido');
        document.getElementById('email').focus();
        return false;
      }
      
      if (!password) {
        alert('‚ùå La contrase√±a es obligatoria');
        document.getElementById('password').focus();
        return false;
      }
      
      if (password.length < 4) {
        alert('‚ùå La contrase√±a debe tener al menos 4 caracteres');
        document.getElementById('password').focus();
        return false;
      }
      
      if (password !== confirmPassword) {
        alert('‚ùå Las contrase√±as no coinciden');
        document.getElementById('confirm-password').focus();
        return false;
      }
      
      if (!fechaNacimiento) {
        alert('‚ùå La fecha de nacimiento es obligatoria');
        document.getElementById('fecha-nacimiento').focus();
        return false;
      }
      
      if (!rol) {
        alert('‚ùå Debe seleccionar un rol');
        document.getElementById('rol').focus();
        return false;
      }
      
      if (!fechaInscripcion) {
        alert('‚ùå La fecha de inscripci√≥n es obligatoria');
        document.getElementById('fecha-inscripcion').focus();
        return false;
      }
      
      if (!genero) {
        alert('‚ùå Debe seleccionar un g√©nero');
        return false;
      }
      
      if (!club) {
        alert('‚ùå Debe seleccionar un club');
        document.getElementById('intereses').focus();
        return false;
      }
      
      // Verificar si es un rol especial y si est√° validado
      if ((rol === 'profesor' || rol === 'administrador') && !rolValidado) {
        alert('‚ùå Debe ingresar la contrase√±a correcta para el rol ' + rol);
        document.getElementById('password-rol').focus();
        return false;
      }
      
      // Verificar que el c√≥digo de estudiante est√© generado
      const codigo = document.getElementById('codigo-estudiante').value;
      if (!codigo) {
        alert('‚ùå Error: No se ha generado el c√≥digo. Verifique todos los campos.');
        return false;
      }
      
      // Si todas las validaciones pasan, enviar los datos
      enviarDatosRegistro();
      return true;
    }

    // Funci√≥n para enviar datos del registro a Vercel/Supabase
    async function enviarDatosRegistro() {
      const form = document.getElementById('registro-form');
      
      // Recopilar club seleccionado
      const clubSeleccionado = document.getElementById('intereses').value;
      
      // Crear objeto JSON con todos los datos requeridos
      const registroData = {
        username: document.getElementById('username').value,
        email: document.getElementById('email').value,
        password: document.getElementById('password').value,
        telefono: document.getElementById('telefono').value,
        fecha_nacimiento: document.getElementById('fecha-nacimiento').value,
        rol: document.getElementById('rol').value,
        fecha_inscripcion: document.getElementById('fecha-inscripcion').value,
        codigo_usuario: document.getElementById('codigo-estudiante').value,
        genero: document.querySelector('input[name="gender"]:checked')?.value || '',
        // Convert intereses to array format for database compatibility
        intereses: clubSeleccionado ? [clubSeleccionado] : [],
        // Add default values for new database fields
        creditos_obtenidos: '',  // Default empty string
        estado: 'activo',        // Default active status
        creado_en: new Date().toISOString()  // Current timestamp, cannot be altered by user
      };
      
      // Mostrar mensaje de carga
      const registroMsg = document.getElementById('registro-msg');
      registroMsg.style.display = 'block';
      registroMsg.style.color = '#17a2b8';
      registroMsg.textContent = 'Registrando usuario...';
      
      try {
        // Enviar JSON directamente a Supabase (bypass Vercel for now)
        const response = await fetch('https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios', {
          method: 'POST',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(registroData)
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('Registration successful, server response:', result);
          
          // Ocultar mensaje de carga
          registroMsg.style.display = 'none';
          
          // Verificar si fue exitoso
          if (result && result.length > 0) {
            console.log('User created successfully:', result[0]);
            // Mostrar popup de √©xito con informaci√≥n del usuario
            try {
              mostrarPopupExito(result[0], registroData);
            } catch (popupError) {
              console.error('Error showing popup:', popupError);
              // Fallback: mostrar alerta b√°sica
              alert(`‚úÖ Usuario registrado exitosamente!\n\nC√≥digo: ${result[0].codigo_usuario}\nNombre: ${registroData.username}\nEmail: ${registroData.email}`);
            }
            
            // Limpiar formulario inmediatamente
            form.reset();
            document.getElementById('codigo-estudiante').value = '';
            rolValidado = false;
            document.getElementById('password-rol-container').style.display = 'none';
            
            // Restablecer fecha de inscripci√≥n
            const fechaInscripcion = document.getElementById('fecha-inscripcion');
            const hoy = new Date().toISOString().split('T')[0];
            fechaInscripcion.value = hoy;
          } else {
            // Ocultar mensaje de carga
            registroMsg.style.display = 'none';
            alert('‚ö†Ô∏è Respuesta inesperada del servidor');
          }
          
        } else {
          // Error HTTP
          registroMsg.style.display = 'none'; // Ocultar mensaje de carga
          const errorText = await response.text();
          console.error('HTTP Error:', response.status, errorText);
          
          // Provide specific error messages based on status code
          if (response.status === 409) {
            alert('‚ùå Error: Este email ya est√° registrado en el sistema. Use un email diferente.');
          } else if (response.status === 400) {
            if (errorText.includes('duplicate') || errorText.includes('unique')) {
              alert('‚ùå Error: Ya existe un usuario con este email o c√≥digo. Verifique los datos.');
            } else {
              alert('‚ùå Error de datos: ' + errorText);
            }
          } else if (response.status === 422) {
            alert('‚ùå Error: Datos inv√°lidos. Verifique que todos los campos est√©n correctos.');
          } else {
            alert('‚ùå Error del servidor (' + response.status + '): ' + errorText);
          }
        }
        
      } catch (error) {
        console.error('Error:', error);
        
        // Ocultar mensaje de carga
        registroMsg.style.display = 'none';
        
        // Mostrar alerta de error
        alert('‚ùå Error al registrar usuario. Intente nuevamente.\n\nError: ' + error.message);
      }
    }
    
    // Auto-generar c√≥digo cuando la p√°gina carga si ya hay datos
    document.addEventListener('DOMContentLoaded', function() {
      // Establecer fecha actual como fecha de inscripci√≥n por defecto
      const fechaInscripcion = document.getElementById('fecha-inscripcion');
      const hoy = new Date().toISOString().split('T')[0];
      fechaInscripcion.value = hoy;
      
      // Agregar validaci√≥n al formulario
      const form = document.querySelector('form');
      if (form) {
        form.addEventListener('submit', validarFormulario);
      }
      
      // Configurar validaci√≥n inicial del rol
      manejarCambioRol();
      
      // Generar c√≥digo inicial si hay rol seleccionado
      generarCodigoEstudiante();
    });
    
    // Variables globales para el popup
    let currentUserCode = '';
    let currentUserData = {};
    
    // Funci√≥n para mostrar el popup de √©xito
    function mostrarPopupExito(usuarioCreado, datosFormulario) {
      console.log('mostrarPopupExito called with:', usuarioCreado, datosFormulario);
      
      try {
        // Guardar informaci√≥n para las funciones de guardado
        currentUserCode = usuarioCreado.codigo_usuario;
        currentUserData = {
          nombre: datosFormulario.username,
          email: datosFormulario.email,
          rol: datosFormulario.rol,
          codigo: usuarioCreado.codigo_usuario
        };
        
        // Llenar la informaci√≥n en el popup
        document.getElementById('popup-username-value').textContent = datosFormulario.username;
        document.getElementById('popup-email-value').textContent = datosFormulario.email;
        document.getElementById('popup-rol-value').textContent = capitalizeFirstLetter(datosFormulario.rol);
        document.getElementById('popup-code-value').textContent = usuarioCreado.codigo_usuario;
        
        // Mostrar el popup con efecto de fade
        const popup = document.getElementById('success-popup');
        if (!popup) {
          console.error('Popup element not found!');
          return;
        }
        
        popup.style.display = 'flex';
        popup.style.opacity = '0';
        
        // Animaci√≥n de entrada
        setTimeout(() => {
          popup.style.transition = 'opacity 0.3s ease-in-out';
          popup.style.opacity = '1';
        }, 50);
        
        // Reproducir sonido de √©xito si est√° disponible
        try {
          playLightsaberSound();
        } catch (e) {
          console.log('Sonido no disponible');
        }
        
        console.log('Popup shown successfully');
      } catch (error) {
        console.error('Error in mostrarPopupExito:', error);
        throw error; // Re-throw to be caught by the calling function
      }
    }
    
    // Funci√≥n para copiar c√≥digo al portapapeles
    function copiarCodigoAlPortapapeles() {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(currentUserCode).then(() => {
          mostrarMensajeTemporalEnBoton('üìã Copiar C√≥digo', '‚úÖ ¬°Copiado!');
        }).catch(err => {
          console.error('Error al copiar:', err);
          fallbackCopiarTexto(currentUserCode);
        });
      } else {
        fallbackCopiarTexto(currentUserCode);
      }
    }
    
    // Funci√≥n fallback para copiar en navegadores antiguos
    function fallbackCopiarTexto(texto) {
      const textArea = document.createElement('textarea');
      textArea.value = texto;
      textArea.style.position = 'fixed';
      textArea.style.opacity = '0';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          mostrarMensajeTemporalEnBoton('üìã Copiar C√≥digo', '‚úÖ ¬°Copiado!');
        } else {
          alert('C√≥digo: ' + texto + '\n\nCopia manualmente este c√≥digo.');
        }
      } catch (err) {
        alert('C√≥digo: ' + texto + '\n\nCopia manualmente este c√≥digo.');
      } finally {
        document.body.removeChild(textArea);
      }
    }
    
    // Funci√≥n para guardar c√≥digo como archivo
    function guardarCodigoArchivo() {
      const contenido = `GALAXIA MAGNA ACADEMY - INFORMACI√ìN DE USUARIO
========================================

Nombre: ${currentUserData.nombre}
Email: ${currentUserData.email}
Rol: ${capitalizeFirstLetter(currentUserData.rol)}
C√≥digo de Usuario: ${currentUserData.codigo}
Fecha de Registro: ${new Date().toLocaleDateString('es-ES')}

========================================
IMPORTANTE: Guarda este c√≥digo para iniciar sesi√≥n
========================================`;

      const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `GMA_Usuario_${currentUserData.codigo}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      mostrarMensajeTemporalEnBoton('üíæ Guardar como Archivo', '‚úÖ ¬°Guardado!');
    }
    
    // Funci√≥n para mostrar mensaje temporal en bot√≥n
    function mostrarMensajeTemporalEnBoton(textoOriginal, textoTemporal) {
      const botones = document.querySelectorAll('#success-popup button');
      botones.forEach(boton => {
        if (boton.textContent.includes(textoOriginal.split(' ')[1])) {
          const textoAnterior = boton.textContent;
          boton.textContent = textoTemporal;
          boton.style.background = '#22c55e';
          setTimeout(() => {
            boton.textContent = textoAnterior;
            boton.style.background = '';
          }, 2000);
        }
      });
    }
    
    // Funci√≥n para cerrar popup y volver al inicio
    function cerrarPopupYVolverInicio() {
      const popup = document.getElementById('success-popup');
      popup.style.transition = 'opacity 0.3s ease-in-out';
      popup.style.opacity = '0';
      
      setTimeout(() => {
        popup.style.display = 'none';
        // Redirigir al inicio
        window.location.href = 'index.html';
      }, 300);
    }
    
    // Funci√≥n auxiliar para capitalizar primera letra
    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }
    
    // Cerrar popup si se hace clic fuera de √©l
    document.addEventListener('click', function(e) {
      const popup = document.getElementById('success-popup');
      if (e.target === popup) {
        cerrarPopupYVolverInicio();
      }
    });
    
    // Cerrar popup con tecla Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const popup = document.getElementById('success-popup');
        const clubPopup = document.getElementById('club-info-popup');
        if (popup.style.display === 'flex') {
          cerrarPopupYVolverInicio();
        }
        if (clubPopup && clubPopup.style.display === 'flex') {
          cerrarPopupClubInfo();
        }
      }
    });

    // Funci√≥n para mostrar popup de informaci√≥n de clubes
    function mostrarPopupClubInfo() {
      const popup = document.getElementById('club-info-popup');
      popup.style.display = 'flex';
      popup.style.opacity = '0';
      setTimeout(() => {
        popup.style.transition = 'opacity 0.3s ease-in-out';
        popup.style.opacity = '1';
      }, 50);
    }

    // Funci√≥n para cerrar popup de informaci√≥n de clubes
    function cerrarPopupClubInfo() {
      const popup = document.getElementById('club-info-popup');
      popup.style.transition = 'opacity 0.3s ease-in-out';
      popup.style.opacity = '0';
      setTimeout(() => {
        popup.style.display = 'none';
      }, 300);
    }

    // Agregar event listener para el icono de informaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
      const infoIcon = document.getElementById('info-club');
      if (infoIcon) {
        infoIcon.addEventListener('click', mostrarPopupClubInfo);
      }

      // Cerrar popup de clubes si se hace clic fuera
      document.addEventListener('click', function(e) {
        const clubPopup = document.getElementById('club-info-popup');
        if (e.target === clubPopup) {
          cerrarPopupClubInfo();
        }
      });
    });
  </script>
</body>
</html>
