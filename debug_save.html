<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîß DEBUG SAVE OPERATION</title>
  <style>
    body { background: #1a1a1f; color: #fff; padding: 20px; font-family: Arial, sans-serif; }
    .container { max-width: 800px; margin: 0 auto; background: #23232b; padding: 30px; border-radius: 10px; }
    button { background: #22c55e; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 10px 5px; }
    button:hover { background: #16a34a; }
    .error { background: #ef4444; }
    .warning { background: #f59e0b; }
    .info { background: #3b82f6; }
    input, select { width: 100%; padding: 8px; margin: 10px 0; background: #1a1a1f; color: white; border: 1px solid #4a4a55; border-radius: 4px; }
    .result { padding: 15px; margin: 10px 0; border-radius: 5px; background: #2d2d35; }
    .log { font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="color: #f18b32; text-align: center;">üîß DEBUG SAVE OPERATION</h1>
    <p style="text-align: center; color: #999;">Debug why saving telefono/genero fails</p>
    
    <div class="result">
      <h3>Step 1: User Search</h3>
      <input type="email" id="user-email" placeholder="Enter email" value="allan.villalobos.calderon@gmail.com">
      <button onclick="searchUser()">üîç Search User</button>
      <div id="search-result"></div>
    </div>

    <div class="result">
      <h3>Step 2: Test Update</h3>
      <select id="test-field">
        <option value="telefono">Telefono</option>
        <option value="genero">Genero</option>
        <option value="username">Username</option>
      </select>
      <input type="text" id="test-value" placeholder="Enter new value">
      <button onclick="testUpdate()">üíæ Test Update</button>
      <div id="update-result"></div>
    </div>

    <div class="result">
      <h3>Step 3: Verify Update</h3>
      <button onclick="verifyUpdate()">‚úÖ Re-search User to Verify</button>
      <div id="verify-result"></div>
    </div>

    <div class="result">
      <h3>Debug Log</h3>
      <div id="debug-log" class="log"></div>
    </div>
  </div>

  <script>
    let currentUser = null;

    function log(message) {
      const debugLog = document.getElementById('debug-log');
      const timestamp = new Date().toLocaleTimeString();
      debugLog.textContent += `[${timestamp}] ${message}\n`;
      debugLog.scrollTop = debugLog.scrollHeight;
      console.log(message);
    }

    async function searchUser() {
      const email = document.getElementById('user-email').value;
      const resultDiv = document.getElementById('search-result');
      
      try {
        log(`üîç Searching for user: ${email}`);
        
        const searchUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email.eq.${encodeURIComponent(email)}`;
        log(`Search URL: ${searchUrl}`);
        
        const response = await fetch(searchUrl, {
          method: 'GET',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Accept': 'application/json'
          }
        });
        
        log(`Search response status: ${response.status}`);
        
        if (response.ok) {
          const users = await response.json();
          log(`Found ${users.length} users`);
          
          if (users && users.length > 0) {
            currentUser = users[0];
            log(`User found: ${JSON.stringify(currentUser, null, 2)}`);
            
            resultDiv.innerHTML = `
              <div style="color: #22c55e; margin: 10px 0;">
                ‚úÖ User found!<br>
                <strong>ID:</strong> ${currentUser.id || 'No ID'}<br>
                <strong>Username:</strong> ${currentUser.username}<br>
                <strong>Email:</strong> ${currentUser.email}<br>
                <strong>Telefono:</strong> ${currentUser.telefono || 'Not set'}<br>
                <strong>Genero:</strong> ${currentUser.genero || 'Not set'}
              </div>
            `;
          } else {
            resultDiv.innerHTML = `<div style="color: #ef4444;">‚ùå No user found</div>`;
            log('No user found');
          }
        } else {
          const errorText = await response.text();
          log(`Search error: ${response.status} - ${errorText}`);
          resultDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Search failed: ${response.status}</div>`;
        }
        
      } catch (error) {
        log(`Search exception: ${error.message}`);
        resultDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Error: ${error.message}</div>`;
      }
    }

    async function testUpdate() {
      if (!currentUser) {
        alert('Please search for user first!');
        return;
      }
      
      const field = document.getElementById('test-field').value;
      const value = document.getElementById('test-value').value;
      const resultDiv = document.getElementById('update-result');
      
      try {
        log(`üíæ Updating ${field} to "${value}" for user ${currentUser.email}`);
        
        const updateData = {};
        updateData[field] = value;
        
        log(`Update data: ${JSON.stringify(updateData)}`);
        
        // FIXED: Use proper Supabase update syntax with WHERE clause
        const updateUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email=eq.${encodeURIComponent(currentUser.email)}`;
        log(`Update URL: ${updateUrl}`);
        
        const response = await fetch(updateUrl, {
          method: 'PATCH',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify(updateData)
        });
        
        log(`Update response status: ${response.status}`);
        log(`Update response headers: ${JSON.stringify([...response.headers.entries()])}`);
        
        if (response.ok) {
          log('‚úÖ Update successful!');
          resultDiv.innerHTML = `<div style="color: #22c55e;">‚úÖ Update successful!</div>`;
        } else {
          const errorText = await response.text();
          log(`Update error: ${response.status} - ${errorText}`);
          resultDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Update failed: ${response.status}<br>${errorText}</div>`;
        }
        
      } catch (error) {
        log(`Update exception: ${error.message}`);
        resultDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Error: ${error.message}</div>`;
      }
    }

    async function verifyUpdate() {
      if (!currentUser) {
        alert('Please search for user first!');
        return;
      }
      
      const resultDiv = document.getElementById('verify-result');
      
      try {
        log(`‚úÖ Verifying update for user: ${currentUser.email}`);
        
        const searchUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email.eq.${encodeURIComponent(currentUser.email)}`;
        
        const response = await fetch(searchUrl, {
          method: 'GET',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const users = await response.json();
          
          if (users && users.length > 0) {
            const updatedUser = users[0];
            log(`Updated user data: ${JSON.stringify(updatedUser, null, 2)}`);
            
            resultDiv.innerHTML = `
              <div style="color: #22c55e; margin: 10px 0;">
                ‚úÖ Current user data:<br>
                <strong>Username:</strong> ${updatedUser.username}<br>
                <strong>Email:</strong> ${updatedUser.email}<br>
                <strong>Telefono:</strong> ${updatedUser.telefono || 'Not set'}<br>
                <strong>Genero:</strong> ${updatedUser.genero || 'Not set'}
              </div>
            `;
          }
        }
        
      } catch (error) {
        log(`Verify exception: ${error.message}`);
        resultDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Error: ${error.message}</div>`;
      }
    }

    // Auto-search on page load
    window.onload = function() {
      log('üöÄ Debug tool loaded');
    };
  </script>
</body>
</html>
