<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üöÄ UNIVERSAL PROFILE - Works for ANY User</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #1a1a1f; color: #fff; padding: 20px; font-family: Arial, sans-serif; }
    .container { max-width: 900px; margin: 0 auto; background: #23232b; padding: 30px; border-radius: 10px; }
    .field { margin: 20px 0; padding: 15px; background: #2d2d35; border-radius: 8px; }
    .btn-edit { background: #f18b32; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    .btn-save { background: #22c55e; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px; }
    .btn-cancel { background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
    input, select { width: 100%; padding: 8px; margin: 10px 0; background: #1a1a1f; color: white; border: 1px solid #4a4a55; border-radius: 4px; }
    .alert { padding: 15px; margin: 10px 0; border-radius: 5px; }
    .alert-success { background: #22c55e; color: white; }
    .alert-error { background: #ef4444; color: white; }
    .alert-info { background: #3b82f6; color: white; }
    .avatar { width: 100px; height: 100px; border-radius: 50%; border: 3px solid #f18b32; margin: 0 auto 20px; display: block; }
    .edit-section { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div style="text-align: center; margin-bottom: 30px;">
      <h1 style="color: #f18b32;">üöÄ UNIVERSAL PROFILE</h1>
      <p style="color: #999;">Works for ANY user - Login with any account and edit everything!</p>
      <img id="user-avatar" src="images/Male.png" alt="Avatar" class="avatar">
    </div>
    
    <div id="status"></div>

    <!-- Auto-login with session -->
    <div class="field">
      <h4>Current Session</h4>
      <div id="session-info">Loading session...</div>
      <button class="btn-save" onclick="loadCurrentUser()" style="margin-top: 10px;">üîÑ Reload User Data</button>
    </div>

    <!-- Profile Fields -->
    <div class="field">
      <h4><strong>Name</strong></h4>
      <div id="name-display">Loading...</div>
      <button class="btn-edit" onclick="editField('name')">Edit</button>
      <div id="name-edit" class="edit-section">
        <input type="text" id="name-input" placeholder="Enter your full name">
        <button class="btn-save" onclick="saveField('name', 'username')">Save</button>
        <button class="btn-cancel" onclick="cancelEdit('name')">Cancel</button>
      </div>
    </div>

    <div class="field">
      <h4><strong>Email</strong></h4>
      <div id="email-display">Loading...</div>
      <button class="btn-edit" onclick="editField('email')">Edit</button>
      <div id="email-edit" class="edit-section">
        <input type="email" id="email-input" placeholder="Enter your email">
        <button class="btn-save" onclick="saveField('email', 'email')">Save</button>
        <button class="btn-cancel" onclick="cancelEdit('email')">Cancel</button>
      </div>
    </div>

    <div class="field">
      <h4><strong>Phone</strong></h4>
      <div id="telefono-display">Loading...</div>
      <button class="btn-edit" onclick="editField('telefono')">Edit</button>
      <div id="telefono-edit" class="edit-section">
        <input type="tel" id="telefono-input" placeholder="+506-1234-5678">
        <button class="btn-save" onclick="saveField('telefono', 'telefono')">Save</button>
        <button class="btn-cancel" onclick="cancelEdit('telefono')">Cancel</button>
      </div>
    </div>

    <div class="field">
      <h4><strong>Gender</strong></h4>
      <div id="genero-display">Loading...</div>
      <button class="btn-edit" onclick="editField('genero')">Edit</button>
      <div id="genero-edit" class="edit-section">
        <select id="genero-input">
          <option value="m">Masculino</option>
          <option value="f">Femenino</option>
          <option value="o">Otro</option>
          <option value="n">Prefiero no decir</option>
        </select>
        <button class="btn-save" onclick="saveField('genero', 'genero')">Save</button>
        <button class="btn-cancel" onclick="cancelEdit('genero')">Cancel</button>
      </div>
    </div>

    <div class="field">
      <h4><strong>Role</strong></h4>
      <div id="rol-display">Loading...</div>
      <button class="btn-edit" onclick="editField('rol')">Edit</button>
      <div id="rol-edit" class="edit-section">
        <select id="rol-input">
          <option value="estudiante">Estudiante</option>
          <option value="profesor">Profesor</option>
          <option value="administrador">Administrador</option>
          <option value="invitado">Invitado</option>
        </select>
        <button class="btn-save" onclick="saveField('rol', 'rol')">Save</button>
        <button class="btn-cancel" onclick="cancelEdit('rol')">Cancel</button>
      </div>
    </div>

    <div style="margin-top: 30px; text-align: center;">
      <a href="index.html" style="color: #f18b32; margin-right: 20px;">‚Üê Back to Login</a>
      <a href="profile.html" style="color: #f18b32;">Go to Main Profile</a>
    </div>
  </div>

  <script>
    let currentUser = null;

    function showStatus(message, type = 'info') {
      const status = document.getElementById('status');
      const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-error' : 'alert-info';
      status.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
      
      if (type === 'success') {
        setTimeout(() => status.innerHTML = '', 3000);
      }
    }

    // Load current user from session on page load
    window.onload = function() {
      loadCurrentUser();
    };

    async function loadCurrentUser() {
      try {
        // Get session data
        const sessionData = localStorage.getItem('currentUser');
        if (!sessionData) {
          showStatus('‚ùå No active session. Please login first.', 'error');
          document.getElementById('session-info').innerHTML = '<span style="color: #ef4444;">No session found</span>';
          return;
        }

        const sessionUser = JSON.parse(sessionData);
        document.getElementById('session-info').innerHTML = `
          <strong>Logged in as:</strong> ${sessionUser.username || 'Unknown'}<br>
          <strong>Email:</strong> ${sessionUser.email || 'Unknown'}<br>
          <strong>Role:</strong> ${sessionUser.rol || 'Unknown'}
        `;

        showStatus('üîÑ Loading user data from database...', 'info');

        // Search for user in database
        const email = sessionUser.email;
        const searchUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email=eq.${encodeURIComponent(email)}`;
        
        const response = await fetch(searchUrl, {
          method: 'GET',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const users = await response.json();
          
          if (users && users.length > 0) {
            currentUser = users[0];
            console.log('‚úÖ User loaded from database:', currentUser);
            
            displayUserData();
            showStatus('‚úÖ User data loaded successfully! You can edit any field.', 'success');
            
          } else {
            showStatus('‚ùå User not found in database. All fields will be editable with default values.', 'error');
            // Create basic user structure for editing
            currentUser = {
              username: sessionUser.username || 'New User',
              email: sessionUser.email || 'new@email.com',
              telefono: '',
              genero: 'n',
              rol: sessionUser.rol || 'estudiante'
            };
            displayUserData();
          }
        } else {
          showStatus('‚ùå Database error: ' + response.status, 'error');
        }
        
      } catch (error) {
        showStatus('‚ùå Connection error: ' + error.message, 'error');
      }
    }

    function displayUserData() {
      if (!currentUser) return;
      
      document.getElementById('name-display').textContent = currentUser.username || 'Not set';
      document.getElementById('email-display').textContent = currentUser.email || 'Not set';
      document.getElementById('telefono-display').textContent = currentUser.telefono || 'Not set';
      document.getElementById('rol-display').textContent = currentUser.rol || 'Not set';
      
      const genderMap = { 'm': 'Masculino', 'f': 'Femenino', 'o': 'Otro', 'n': 'Prefiero no decir' };
      document.getElementById('genero-display').textContent = genderMap[currentUser.genero] || 'Not set';
      
      // Update avatar
      const avatarMap = { 'm': 'images/Male.png', 'f': 'images/Female.png', 'o': 'images/Other.png', 'n': 'images/incognito.png' };
      if (avatarMap[currentUser.genero]) {
        document.getElementById('user-avatar').src = avatarMap[currentUser.genero];
      }
    }

    function editField(fieldName) {
      // Hide display, show edit
      document.getElementById(`${fieldName}-display`).style.display = 'none';
      document.getElementById(`${fieldName}-edit`).style.display = 'block';
      
      // Set current value
      const input = document.getElementById(`${fieldName}-input`);
      if (fieldName === 'genero' || fieldName === 'rol') {
        input.value = currentUser[fieldName === 'name' ? 'username' : fieldName] || (fieldName === 'genero' ? 'n' : 'estudiante');
      } else {
        input.value = currentUser[fieldName === 'name' ? 'username' : fieldName] || '';
      }
    }

    function cancelEdit(fieldName) {
      document.getElementById(`${fieldName}-display`).style.display = 'block';
      document.getElementById(`${fieldName}-edit`).style.display = 'none';
    }

    async function saveField(fieldName, dbFieldName) {
      const input = document.getElementById(`${fieldName}-input`);
      const newValue = input.value;
      
      if (!currentUser || !currentUser.email) {
        showStatus('‚ùå No user data to update', 'error');
        return;
      }
      
      showStatus(`üîÑ Saving ${fieldName}...`, 'info');
      
      try {
        const updateData = {};
        updateData[dbFieldName] = newValue;
        
        console.log('Updating:', updateData, 'for user:', currentUser.email);
        
        const updateUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email=eq.${encodeURIComponent(currentUser.email)}`;
        
        const response = await fetch(updateUrl, {
          method: 'PATCH',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify(updateData)
        });
        
        console.log('Update response status:', response.status);
        
        if (response.ok) {
          // Update local data
          currentUser[dbFieldName] = newValue;
          
          showStatus(`‚úÖ ${fieldName} saved successfully!`, 'success');
          cancelEdit(fieldName);
          displayUserData(); // Refresh display
          
        } else {
          const errorText = await response.text();
          console.error('Update failed:', response.status, errorText);
          showStatus(`‚ùå Failed to save ${fieldName}: ${response.status}`, 'error');
        }
        
      } catch (error) {
        console.error('Save error:', error);
        showStatus(`‚ùå Error saving ${fieldName}: ${error.message}`, 'error');
      }
    }
  </script>
</body>
</html>
