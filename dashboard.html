<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Galaxia Magna Academy</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
  <div style="position: absolute; top: 20px; right: 30px; z-index: 1000;">
    <a href="profile.html" style="color:#f18b32; text-decoration:underline; background:none; padding:0;" id="btnProfileTop">Perfil</a>
    <br>
    <a href="#" id="logout-link" style="color:#f18b32; text-decoration:underline; background:none; padding:0;">Cerrar sesión</a>

  </div>
  <header>
    <img src="images/GAM_transparent.png" alt="Galaxia Magna Academy Logo" style="width: 80px; height: 80px; object-fit: contain;">
    <div class="header-text">
      <h1>Galaxia Magna Academy</h1>
      <h2>Sapientia per Stellam</h2>
      <div id="dashboard-links" style="margin-top:18px; text-align:center;">
        <nav id="admin-nav" style="display:none;">
          <ul style="display:inline-flex; gap:18px; list-style:none; margin:0; padding:0;">
            <li id="admin-link-students"><a href="admin_tools_students.html" style="color:#2563eb; text-decoration:underline; background:none; padding:0;"><i class="fas fa-users" style="margin-right:6px;color:#f18b32;"></i>Estudiantes</a></li>
            <li id="admin-link-professors"><a href="admin_tools_professors.html" style="color:#2563eb; text-decoration:underline; background:none; padding:0;"><i class="fas fa-chalkboard-teacher" style="margin-right:6px;color:#f18b32;"></i>Profesores</a></li>
            <li id="admin-link-admins"><a href="admin_tools_admins.html" style="color:#2563eb; text-decoration:underline; background:none; padding:0;"><i class="fas fa-user-shield" style="margin-right:6px;color:#f18b32;"></i>Administradores</a></li>
            <li id="admin-link-inactivos"><a href="admin_tools_inactive_users.html" style="color:#f18b32; text-decoration:underline; background:none; padding:0;"><i class="fas fa-user-slash" style="margin-right:6px;color:#2563eb;"></i>Inactivos</a></li>
          </ul>
        </nav>
        <nav id="admin-nav-courses" style="display:none; margin-top:10px;">
          <ul style="display:inline-flex; gap:18px; list-style:none; margin:0; padding:0;">
            <li id="admin-link-courses"><a href="admin_tool_courses.html" style="color:#2563eb; text-decoration:underline; background:none; padding:0;"><i class="fas fa-book" style="margin-right:6px;color:#2563eb;"></i>Cursos</a></li>
            <li id="admin-link-online-training"><a href="admin_tools_online_training.html" style="color:#2563eb; text-decoration:underline; background:none; padding:0;"><i class="fas fa-laptop" style="margin-right:6px;color:#2563eb;"></i>Capacitaciones Online</a></li>
          </ul>
        </nav>
      </div>
    </div>
    <img src="images/GAM_transparent.png" alt="GMA Logo" style="width: 80px; height: 80px; object-fit: contain;">
  </header>
  <main>
    <section style="max-width: 400px; margin: 40px auto; background: #23232b; border-radius: 10px; padding: 24px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); border: 1px solid #f18b32;">
      <div class="profile-info">
        <!-- Name Field -->
        <div class="profile-field" style="margin-bottom: 12px; padding: 10px; background: #2d2d35; border-radius: 6px; position: relative;">
          <label style="color: #f18b32; font-weight: bold; display: block; margin-bottom: 4px; font-size: 0.95em;">
            <i class="fas fa-user" style="margin-right: 6px; font-size: 1em;"></i>Usuario
          </label>
          <span id="dashboard-name" style="color: #fff; font-size: 1em;">Cargando...</span>
        </div>
        <!-- Rol Field -->
        <div class="profile-field" style="margin-bottom: 12px; padding: 10px; background: #2d2d35; border-radius: 6px; position: relative;">
          <label style="color: #f18b32; font-weight: bold; display: block; margin-bottom: 4px; font-size: 0.95em;">
            <i class="fas fa-user-tag" style="margin-right: 6px; font-size: 1em;"></i>Rol
          </label>
          <span id="dashboard-rol" style="color: #fff; font-size: 1em;">Cargando...</span>
        </div>
        <!-- Código Field -->
        <div class="profile-field" style="margin-bottom: 0; padding: 10px; background: #2d2d35; border-radius: 6px; position: relative;">
          <label style="color: #f18b32; font-weight: bold; display: block; margin-bottom: 4px; font-size: 0.95em;">
            <i class="fas fa-id-badge" style="margin-right: 6px; font-size: 1em;"></i>Código
          </label>
          <span id="dashboard-codigo" style="color: #fff; font-size: 1em;">Cargando...</span>
        </div>
      </div>
    </section>
    <div id="videos-message" style="margin-top:20px; font-size:1.1em; color:#fff; font-weight:bold;"></div>
  <div style="text-align:center; margin:24px 0 12px 0;">
    <input type="text" id="trainings-search" class="form-control" style="max-width:400px;display:inline-block;" placeholder="Buscar en capacitaciones...">
  </div>
  <div id="trainings-tables"></div>
  </main>
  <footer></footer>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="config.js"></script>
  <script src="scripts.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var user = JSON.parse(localStorage.getItem('uccr_user') || '{}');
      document.getElementById('dashboard-name').textContent = user.username || '(nombre)';
      document.getElementById('dashboard-rol').textContent = user.rol || '(rol)';
      document.getElementById('dashboard-codigo').textContent = user.codigo_usuario || '(código)';
      if (user.rol === 'administrador') {
        document.getElementById('admin-nav').style.display = '';
        document.getElementById('admin-nav-courses').style.display = '';
      }
      // Mensaje de videos según club
      var club = user.intereses;
      var msgDiv = document.getElementById('videos-message');
      var clubNormalized = (club || '').toString().trim().toLowerCase();
      if (!clubNormalized || clubNormalized === 'ninguno' || clubNormalized === 'null') {
        msgDiv.innerHTML = 'Videos que te pueden interesar.<br>Los cursos pueden ser en Español, Inglés o Portugués.';
      } else {
        msgDiv.innerHTML = 'Videos basados en tu club de interés (<span style="color:#FFFF00;">' + club + '</span>) y otros videos. <br> Los cursos pueden ser en Español, Inglés o Portugués.';
      }

      // Mostrar tablas de trainings
      fetch(`${typeof SUPABASE_URL !== 'undefined' ? SUPABASE_URL : ''}/rest/v1/online_trainings`, {
        headers: {
          'apikey': typeof SUPABASE_APIKEY !== 'undefined' ? SUPABASE_APIKEY : '',
          'Authorization': typeof SUPABASE_AUTH !== 'undefined' ? SUPABASE_AUTH : ''
        }
      })
      .then(response => response.ok ? response.json() : [])
      .then(trainings => {
        var clubNorm = clubNormalized;
        var trainingsTablesDiv = document.getElementById('trainings-tables');
        var trainingsSearch = document.getElementById('trainings-search');
        function renderTables(filteredTrainings) {
          trainingsTablesDiv.innerHTML = '';
          // Agrupar por categoría
          let trainingsByCategory = {};
          filteredTrainings.forEach(tr => {
            let cat = (tr.category || '').toLowerCase();
            if (!trainingsByCategory[cat]) trainingsByCategory[cat] = [];
            trainingsByCategory[cat].push(tr);
          });
          let categories = Object.keys(trainingsByCategory);
          let clubCat = clubNorm;
          let hasInterestTable = clubCat && categories.includes(clubCat);
          function makeTable(cat, expanded, bolded) {
            let hStyle = bolded ? "font-weight:bold; color:#f18b32;" : "color:#f18b32;";
            let tableId = `table-${cat}`;
            let isInterest = (clubCat && cat === clubCat);
            let collapseBtn = (!isInterest) ? `<button id='${tableId}-collapse' class='btn btn-sm btn-outline-secondary' style='margin-left:12px;' onclick=\"document.getElementById('${tableId}-wrap').style.display='none'; document.getElementById('${tableId}-expand').style.display='inline-block';\">Ocultar</button>` : '';
            let expandBtn = (!isInterest) ? `<button id='${tableId}-expand' class='btn btn-sm btn-outline-primary' style='display:${expanded ? 'none':'inline-block'};margin-bottom:8px;' onclick=\"document.getElementById('${tableId}-wrap').style.display='block'; this.style.display='none';\">Expandir ${cat.charAt(0).toUpperCase() + cat.slice(1)}</button>` : '';
            let wrapStyle = (expanded || isInterest) ? '' : 'display:none;';
            let html = `<div style='margin-top:32px;'>${expandBtn}<div id='${tableId}-wrap' style='${wrapStyle}'>`;
            html += `<h3 style='${hStyle}'>Videos de ${cat.charAt(0).toUpperCase() + cat.slice(1)} ${collapseBtn}</h3>`;
            html += `<table class='table table-striped table-dark' style='min-width:700px; width:auto;'><thead><tr><th>ID</th><th>Categoría</th><th>Título</th><th>Idioma</th><th>Enlace</th></tr></thead><tbody>`;
            trainingsByCategory[cat].forEach(tr => {
              html += `<tr><td>${tr.id}</td><td>${tr.category}</td><td>${tr.title}</td><td>${tr.language}</td><td><a href='${tr.link}' target='_blank'>${tr.link}</a></td></tr>`;
            });
            html += '</tbody></table></div></div>';
            return html;
          }
          if (hasInterestTable) {
            trainingsTablesDiv.innerHTML += makeTable(clubCat, true, true);
            categories.filter(c => c !== clubCat).forEach(cat => {
              trainingsTablesDiv.innerHTML += makeTable(cat, false, false);
            });
          } else {
            categories.forEach(cat => {
              trainingsTablesDiv.innerHTML += makeTable(cat, false, false);
            });
          }
        }
        // Initial render
        renderTables(trainings);
        // Add search event
        trainingsSearch.addEventListener('input', function() {
          const filtro = trainingsSearch.value.toLowerCase();
          const filtered = trainings.filter(tr =>
            (!filtro ||
              (tr.id && tr.id.toString().toLowerCase().includes(filtro)) ||
              (tr.category && tr.category.toLowerCase().includes(filtro)) ||
              (tr.title && tr.title.toLowerCase().includes(filtro)) ||
              (tr.language && tr.language.toLowerCase().includes(filtro)) ||
              (tr.link && tr.link.toLowerCase().includes(filtro))
            )
          );
          renderTables(filtered);
        });
      });
    });
    document.getElementById('logout-link').onclick = function() {
      localStorage.removeItem('uccr_user');
      window.location.href = 'index.html';
    };
  </script>
</body>
</html>
