<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administración de Usuarios - Galaxia Magna Academy</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
  <!-- Header -->
  <header>
    <img src="images/GAM_transparent.png" alt="Galaxia Magna Academy Logo" style="width: 80px; height: 80px; object-fit: contain;">
    <div class="header-text">
      <h1>Galaxia Magna Academy</h1>
      <h2>Panel de Administración - Usuarios</h2>
    </div>
    <img src="images/GAM_transparent.png" alt="GMA Logo" style="width: 80px; height: 80px; object-fit: contain;">
  </header>

  <main>
    <!-- Navigation -->
    <nav style="margin-bottom: 20px;">
      <ul>
        <li><a href="profile.html">← Volver al Perfil</a></li>
        <li><a href="admin_cursos.html">Administrar Cursos</a></li>
        <li><a href="registro.html">Registrar Usuario</a></li>
        <li><a href="index.html">Inicio</a></li>
      </ul>
    </nav>

    <!-- Admin Authentication Modal -->
    <div id="admin-auth-modal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
      <div style="background: #23232b; border-radius: 16px; padding: 40px; max-width: 400px; margin: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); border: 2px solid #f18b32; text-align: center;">
        <div style="margin-bottom: 20px;">
          <i class="fas fa-shield-alt" style="font-size: 36px; color: #f18b32;"></i>
        </div>
        <h3 style="color: #f18b32; margin-bottom: 16px; font-size: 1.4em;">Acceso de Administrador</h3>
        <p style="color: #c9c9c9; margin-bottom: 20px;">Ingrese la contraseña de administrador para continuar:</p>
        
        <div style="margin-bottom: 20px;">
          <input type="password" id="admin-password" placeholder="Contraseña de administrador" 
                 style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #4a4a55; background: #2d2d35; color: #c9c9c9; font-size: 1em;">
          <div id="admin-error" style="color: #ff6b6b; margin-top: 8px; display: none;">Contraseña incorrecta</div>
        </div>
        
        <div style="display: flex; gap: 12px; justify-content: center;">
          <button onclick="validateAdminAccess()" style="background: #f18b32; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold;">
            Acceder
          </button>
          <button onclick="goBack()" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content (hidden until admin authenticated) -->
    <div id="main-content" style="display: none;">
      <!-- Message Area -->
      <div id="message-area" style="display: none; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-weight: bold;"></div>

      <!-- Admin Info -->
      <div style="background: #23232b; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 2px solid #f18b32;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <i class="fas fa-users-cog" style="color: #f18b32; font-size: 1.5em;"></i>
          <div>
            <h3 style="color: #f18b32; margin: 0; font-size: 1.2em;">Panel de Administrador</h3>
            <p style="color: #c9c9c9; margin: 0; font-size: 0.9em;">Gestión completa de usuarios del sistema</p>
          </div>
        </div>
      </div>

      <!-- User Statistics -->
      <div class="row mb-3">
        <div class="col-md-3">
          <div style="background: #1a1a1f; border-radius: 6px; padding: 12px; text-align: center; border: 1px solid #333; font-family: 'Consolas', 'Courier New', monospace;">
            <i class="fas fa-users" style="color: #22c55e; font-size: 1.2em; margin-bottom: 5px;"></i>
            <h5 style="color: #22c55e; margin: 0; font-size: 1.3em; font-weight: normal;" id="total-users">0</h5>
            <p style="color: #888; margin: 0; font-size: 0.8em;">Total</p>
          </div>
        </div>
        <div class="col-md-3">
          <div style="background: #1a1a1f; border-radius: 6px; padding: 12px; text-align: center; border: 1px solid #333; font-family: 'Consolas', 'Courier New', monospace;">
            <i class="fas fa-graduation-cap" style="color: #3b82f6; font-size: 1.2em; margin-bottom: 5px;"></i>
            <h5 style="color: #3b82f6; margin: 0; font-size: 1.3em; font-weight: normal;" id="total-students">0</h5>
            <p style="color: #888; margin: 0; font-size: 0.8em;">Estudiantes</p>
          </div>
        </div>
        <div class="col-md-3">
          <div style="background: #1a1a1f; border-radius: 6px; padding: 12px; text-align: center; border: 1px solid #333; font-family: 'Consolas', 'Courier New', monospace;">
            <i class="fas fa-chalkboard-teacher" style="color: #f59e0b; font-size: 1.2em; margin-bottom: 5px;"></i>
            <h5 style="color: #f59e0b; margin: 0; font-size: 1.3em; font-weight: normal;" id="total-professors">0</h5>
            <p style="color: #888; margin: 0; font-size: 0.8em;">Profesores</p>
          </div>
        </div>
        <div class="col-md-3">
          <div style="background: #1a1a1f; border-radius: 6px; padding: 12px; text-align: center; border: 1px solid #333; font-family: 'Consolas', 'Courier New', monospace;">
            <i class="fas fa-user-shield" style="color: #ef4444; font-size: 1.2em; margin-bottom: 5px;"></i>
            <h5 style="color: #ef4444; margin: 0; font-size: 1.3em; font-weight: normal;" id="total-admins">0</h5>
            <p style="color: #888; margin: 0; font-size: 0.8em;">Admins</p>
          </div>
        </div>
      </div>

      <!-- User Filters -->
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="filter-role" class="form-label" style="color: #888; font-size: 0.85em;">Rol:</label>
          <select id="filter-role" class="form-select form-select-sm" onchange="filterUsers()" style="background: #1a1a1f; color: #c9c9c9; border: 1px solid #333; font-family: 'Consolas', 'Courier New', monospace; font-size: 0.85em;">
            <option value="">Todos</option>
            <option value="estudiante">Estudiantes</option>
            <option value="profesor">Profesores</option>
            <option value="administrador">Administradores</option>
            <option value="invitado">Invitados</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="filter-status" class="form-label" style="color: #888; font-size: 0.85em;">Estado:</label>
          <select id="filter-status" class="form-select form-select-sm" onchange="filterUsers()" style="background: #1a1a1f; color: #c9c9c9; border: 1px solid #333; font-family: 'Consolas', 'Courier New', monospace; font-size: 0.85em;">
            <option value="">Todos</option>
            <option value="activo">Activos</option>
            <option value="inactivo">Inactivos</option>
            <option value="suspendido">Suspendidos</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="filter-search" class="form-label" style="color: #888; font-size: 0.85em;">Buscar:</label>
          <input type="text" id="filter-search" class="form-control form-control-sm" placeholder="Nombre, email o código" 
                 onkeyup="filterUsers()" style="background: #1a1a1f; color: #c9c9c9; border: 1px solid #333; font-family: 'Consolas', 'Courier New', monospace; font-size: 0.85em;">
        </div>
        <div class="col-md-2">
          <label class="form-label" style="color: transparent; font-size: 0.85em;">.</label>
          <button onclick="exportUsers()" class="btn btn-sm" style="width: 100%; background: #333; color: #ccc; border: 1px solid #444; font-family: 'Consolas', 'Courier New', monospace; font-size: 0.8em;">
            <i class="fas fa-download"></i> Export
          </button>
        </div>
      </div>

      <!-- Users Table -->
      <div style="background: #2a2a2a; border-radius: 8px; padding: 15px; border: 1px solid #333;">
        <h3 style="color: #f18b32; margin-bottom: 15px; font-size: 1.1em;">
          Lista de Usuarios
        </h3>
        
        <div class="table-responsive">
          <table class="table table-sm" style="color: #fff; font-family: 'Consolas', 'Courier New', monospace; font-size: 0.85em; background-color: #2a2a2a;">
            <thead style="background-color: #2a2a2a;">
              <tr style="border-bottom: 1px solid #555; background-color: #2a2a2a;">
                <th style="color: #fff; border: none; padding: 8px 6px; font-size: 0.8em; font-weight: normal; background-color: #2a2a2a;">Av</th>
                <th style="color: #fff; border: none; padding: 8px 6px; font-size: 0.8em; font-weight: normal; background-color: #2a2a2a;">Nombre</th>
                <th style="color: #fff; border: none; padding: 8px 6px; font-size: 0.8em; font-weight: normal; background-color: #2a2a2a;">Email</th>
                <th style="color: #fff; border: none; padding: 8px 6px; font-size: 0.8em; font-weight: normal; background-color: #2a2a2a;">Código</th>
                <th style="color: #fff; border: none; padding: 8px 6px; font-size: 0.8em; font-weight: normal; background-color: #2a2a2a;">Rol</th>
                <th style="color: #fff; border: none; padding: 8px 6px; font-size: 0.8em; font-weight: normal; background-color: #2a2a2a;">Estado</th>
                <th style="color: #fff; border: none; padding: 8px 6px; font-size: 0.8em; font-weight: normal; background-color: #2a2a2a;">Créditos</th>
                <th style="color: #fff; border: none; padding: 8px 6px; font-size: 0.8em; font-weight: normal; background-color: #2a2a2a;">Club</th>
                <th style="color: #fff; border: none; padding: 8px 6px; font-size: 0.8em; font-weight: normal; background-color: #2a2a2a;">Registro</th>
                <th style="color: #fff; border: none; padding: 8px 6px; font-size: 0.8em; font-weight: normal; background-color: #2a2a2a;">Acciones</th>
              </tr>
            </thead>
            <tbody id="users-table-body" style="background-color: #2a2a2a;">
              <!-- Users will be loaded here -->
            </tbody>
          </table>
        </div>
        
        <div id="no-users-message" style="text-align: center; color: #666; margin: 30px 0; display: none; font-family: 'Consolas', 'Courier New', monospace;">
          <p style="font-size: 0.9em; margin: 0;">No hay usuarios disponibles</p>
        </div>
      </div>
    </div>

    <!-- Edit User Modal -->
    <div id="user-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
      <div style="background: #23232b; border-radius: 16px; padding: 40px; max-width: 700px; margin: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); border: 2px solid #f18b32; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h3 id="modal-title" style="color: #f18b32; margin-bottom: 20px; text-align: center;">Editar Usuario</h3>
        
        <form id="user-form">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="user-username" class="form-label" style="color: #c9c9c9;">Nombre de Usuario:</label>
                <input type="text" id="user-username" class="form-control" required style="background: #2d2d35; color: #c9c9c9; border: 1px solid #4a4a55;">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="user-email" class="form-label" style="color: #c9c9c9;">Email:</label>
                <input type="email" id="user-email" class="form-control" required style="background: #2d2d35; color: #c9c9c9; border: 1px solid #4a4a55;">
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label for="user-role" class="form-label" style="color: #c9c9c9;">Rol:</label>
                <select id="user-role" class="form-select" required style="background: #2d2d35; color: #c9c9c9; border: 1px solid #4a4a55;">
                  <option value="estudiante">Estudiante</option>
                  <option value="profesor">Profesor</option>
                  <option value="administrador">Administrador</option>
                  <option value="invitado">Invitado</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="user-status" class="form-label" style="color: #c9c9c9;">Estado:</label>
                <select id="user-status" class="form-select" required style="background: #2d2d35; color: #c9c9c9; border: 1px solid #4a4a55;">
                  <option value="activo">Activo</option>
                  <option value="inactivo">Inactivo</option>
                  <option value="suspendido">Suspendido</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="user-gender" class="form-label" style="color: #c9c9c9;">Género:</label>
                <select id="user-gender" class="form-select" style="background: #2d2d35; color: #c9c9c9; border: 1px solid #4a4a55;">
                  <option value="m">Masculino</option>
                  <option value="f">Femenino</option>
                  <option value="o">Otro</option>
                  <option value="n">Prefiero no decir</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="user-telefono" class="form-label" style="color: #c9c9c9;">Teléfono:</label>
                <input type="tel" id="user-telefono" class="form-control" style="background: #2d2d35; color: #c9c9c9; border: 1px solid #4a4a55;">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="user-creditos" class="form-label" style="color: #c9c9c9;">Créditos Obtenidos:</label>
                <input type="text" id="user-creditos" class="form-control" style="background: #2d2d35; color: #c9c9c9; border: 1px solid #4a4a55;">
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="user-club" class="form-label" style="color: #c9c9c9;">Club:</label>
                <select id="user-club" class="form-select" style="background: #2d2d35; color: #c9c9c9; border: 1px solid #4a4a55;">
                  <option value="ajedrez">Club de Ajedrez</option>
                  <option value="arte">Club de Arte</option>
                  <option value="deportes">Club de Deportes</option>
                  <option value="idiomas">Club de Idiomas</option>
                  <option value="matematica">Club de Matemática</option>
                  <option value="musica">Club de Música</option>
                  <option value="programacion">Club de Programación</option>
                  <option value="starwars">Club Star Wars</option>
                  <option value="otro">Otro club</option>
                  <option value="ninguno">No está interesado</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="user-birth-date" class="form-label" style="color: #c9c9c9;">Fecha de Nacimiento:</label>
                <input type="date" id="user-birth-date" class="form-control" style="background: #2d2d35; color: #c9c9c9; border: 1px solid #4a4a55;">
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 12px; justify-content: center; margin-top: 30px;">
            <button type="submit" style="background: #22c55e; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold;">
              <i class="fas fa-save"></i> Guardar Cambios
            </button>
            <button type="button" onclick="resetUserPassword()" style="background: #f59e0b; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
              <i class="fas fa-key"></i> Resetear Contraseña
            </button>
            <button type="button" onclick="closeModal()" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
              <i class="fas fa-times"></i> Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    const ADMIN_PASSWORD = 'admin';
    let users = [];
    let editingUserId = null;

    // Admin authentication
    function validateAdminAccess() {
      const password = document.getElementById('admin-password').value;
      const errorDiv = document.getElementById('admin-error');
      
      if (password === ADMIN_PASSWORD) {
        document.getElementById('admin-auth-modal').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        loadUsers();
      } else {
        errorDiv.style.display = 'block';
        document.getElementById('admin-password').value = '';
        document.getElementById('admin-password').focus();
      }
    }

    // Go back to profile
    function goBack() {
      window.location.href = 'profile.html';
    }

    // Load users from database
    async function loadUsers() {
      try {
        showMessage('Cargando usuarios...', 'info');
        
        // Load only active users by default
        const response = await fetch('https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?estado=eq.activo&order=username', {
          method: 'GET',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Accept': 'application/json'
          }
        });

        if (response.ok) {
          users = await response.json();
          displayUsers(users);
          updateStatistics(users);
          showMessage(`${users.length} usuarios cargados exitosamente`, 'success');
        } else {
          throw new Error(`Error HTTP: ${response.status}`);
        }
      } catch (error) {
        console.error('Error loading users:', error);
        showMessage('Error al cargar usuarios: ' + error.message, 'error');
      }
    }

    // Display users in table
    function displayUsers(usersToShow) {
      const tbody = document.getElementById('users-table-body');
      const noUsersMessage = document.getElementById('no-users-message');
      
      if (usersToShow.length === 0) {
        tbody.innerHTML = '';
        noUsersMessage.style.display = 'block';
        return;
      }
      
      noUsersMessage.style.display = 'none';
      
      tbody.innerHTML = usersToShow.map(user => {
        const avatar = getAvatarForGender(user.genero);
        const roleColor = getRoleColor(user.rol);
        const statusColor = getStatusColor(user.estado || 'activo');
        const club = getClubName(user.intereses);
        const registerDate = formatDate(user.creado_en || user.fecha_inscripcion);
        
        return `
          <tr style="border-bottom: 1px solid #444; background-color: #2a2a2a !important;">
            <td style="border: none; padding: 6px 4px; background-color: #2a2a2a;">
              <img src="${avatar}" alt="" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover; opacity: 0.8;">
            </td>
            <td style="border: none; padding: 6px 4px; color: #fff; font-size: 0.85em; background-color: #2a2a2a;">${user.username || '---'}</td>
            <td style="border: none; padding: 6px 4px; color: #fff; font-size: 0.8em; background-color: #2a2a2a;">${user.email || '---'}</td>
            <td style="border: none; padding: 6px 4px; color: #fff; font-size: 0.8em; background-color: #2a2a2a;">${user.codigo_usuario || '---'}</td>
            <td style="border: none; padding: 6px 4px; background-color: #2a2a2a;">
              <span style="background: ${roleColor}; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 0.7em; opacity: 0.9;">
                ${(user.rol || 'estudiante').charAt(0).toUpperCase()}
              </span>
            </td>
            <td style="border: none; padding: 6px 4px; background-color: #2a2a2a;">
              <span style="background: ${statusColor}; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 0.7em; opacity: 0.9;">
                ${(user.estado || 'activo').charAt(0).toUpperCase()}
              </span>
            </td>
            <td style="border: none; padding: 6px 4px; color: #fff; font-size: 0.8em; background-color: #2a2a2a;">${user.creditos_obtenidos || '---'}</td>
            <td style="border: none; padding: 6px 4px; color: #fff; font-size: 0.8em; background-color: #2a2a2a;">${club.length > 12 ? club.substring(0, 12) + '...' : club}</td>
            <td style="border: none; padding: 6px 4px; color: #fff; font-size: 0.75em; background-color: #2a2a2a;">${registerDate}</td>
            <td style="border: none; padding: 6px 4px; background-color: #2a2a2a;">
              <button class="edit-user-btn" data-user-id="${user.id}" style="background: #666; color: #fff; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer; margin-right: 4px; font-size: 0.7em;" title="Editar">
                Editar
              </button>
              <button class="toggle-user-btn" data-user-id="${user.id}" data-username="${user.username || ''}" data-status="${user.estado || 'activo'}" style="background: ${(user.estado === 'activo') ? '#dc2626' : '#059669'}; color: #fff; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer; font-size: 0.7em;" title="${(user.estado === 'activo') ? 'Desactivar' : 'Activar'}">
                ${(user.estado === 'activo') ? 'Desactivar' : 'Activar'}
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Helper functions
    function getAvatarForGender(gender) {
      const avatarMap = {
        'm': 'images/Male.png',
        'f': 'images/Female.png',
        'o': 'images/Other.png',
        'n': 'images/incognito.png'
      };
      return avatarMap[gender] || 'images/incognito.png';
    }

    function getRoleColor(role) {
      const colorMap = {
        'estudiante': '#3b82f6',
        'profesor': '#f59e0b',
        'administrador': '#ef4444',
        'invitado': '#6b7280'
      };
      return colorMap[role] || '#6b7280';
    }

    function getStatusColor(status) {
      const colorMap = {
        'activo': '#22c55e',
        'inactivo': '#6b7280',
        'suspendido': '#ef4444'
      };
      return colorMap[status] || '#6b7280';
    }

    function getClubName(intereses) {
      const clubMap = {
        'ajedrez': 'Ajedrez',
        'arte': 'Arte',
        'deportes': 'Deportes',
        'idiomas': 'Idiomas',
        'matematica': 'Matemática',
        'musica': 'Música',
        'programacion': 'Programación',
        'starwars': 'Star Wars',
        'otro': 'Otro',
        'ninguno': 'Ninguno'
      };
      
      if (Array.isArray(intereses) && intereses.length > 0) {
        return clubMap[intereses[0]] || 'Desconocido';
      }
      return clubMap[intereses] || 'Sin club';
    }

    function formatDate(dateString) {
      if (!dateString) return 'Sin fecha';
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('es-ES');
      } catch (error) {
        return 'Fecha inválida';
      }
    }

    // Update statistics
    function updateStatistics(usersToShow) {
      const totalUsers = usersToShow.length;
      const students = usersToShow.filter(u => u.rol === 'estudiante').length;
      const professors = usersToShow.filter(u => u.rol === 'profesor').length;
      const admins = usersToShow.filter(u => u.rol === 'administrador').length;
      
      document.getElementById('total-users').textContent = totalUsers;
      document.getElementById('total-students').textContent = students;
      document.getElementById('total-professors').textContent = professors;
      document.getElementById('total-admins').textContent = admins;
    }

    // Filter users
    function filterUsers() {
      const roleFilter = document.getElementById('filter-role').value;
      const statusFilter = document.getElementById('filter-status').value;
      const searchFilter = document.getElementById('filter-search').value.toLowerCase();
      
      let filteredUsers = users.filter(user => {
        const matchesRole = !roleFilter || user.rol === roleFilter;
        const matchesStatus = !statusFilter || (user.estado || 'activo') === statusFilter;
        const matchesSearch = !searchFilter || 
          (user.username && user.username.toLowerCase().includes(searchFilter)) ||
          (user.email && user.email.toLowerCase().includes(searchFilter)) ||
          (user.codigo_usuario && user.codigo_usuario.toLowerCase().includes(searchFilter));
        
        return matchesRole && matchesStatus && matchesSearch;
      });
      
      displayUsers(filteredUsers);
      updateStatistics(filteredUsers);
    }

    // Edit user
    function editUser(userId) {
      const user = users.find(u => u.id === userId);
      if (!user) return;
      
      editingUserId = userId;
      
      document.getElementById('user-username').value = user.username || '';
      document.getElementById('user-email').value = user.email || '';
      document.getElementById('user-role').value = user.rol || 'estudiante';
      document.getElementById('user-status').value = user.estado || 'activo';
      document.getElementById('user-gender').value = user.genero || 'n';
      document.getElementById('user-telefono').value = user.telefono || '';
      document.getElementById('user-creditos').value = user.creditos_obtenidos || '';
      document.getElementById('user-birth-date').value = user.fecha_nacimiento || '';
      
      // Handle club selection
      let clubValue = user.intereses;
      if (Array.isArray(clubValue) && clubValue.length > 0) {
        clubValue = clubValue[0];
      }
      document.getElementById('user-club').value = clubValue || 'ninguno';
      
      document.getElementById('user-modal').style.display = 'flex';
    }

    // Toggle user status (activate/deactivate instead of delete)
    async function toggleUserStatus(userId, username, currentStatus) {
      const newStatus = currentStatus === 'activo' ? 'inactivo' : 'activo';
      const action = newStatus === 'activo' ? 'activar' : 'desactivar';
      
      if (!confirm(`¿Está seguro de que desea ${action} el usuario "${username}"?`)) {
        return;
      }
      
      try {
        showMessage(`${action.charAt(0).toUpperCase() + action.slice(1)}ando usuario...`, 'info');
        
        const response = await fetch(`https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?id=eq.${userId}`, {
          method: 'PATCH',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ estado: newStatus })
        });
        
        if (response.ok) {
          showMessage(`Usuario "${username}" ${action}do exitosamente`, 'success');
          loadUsers();
        } else {
          throw new Error(`Error HTTP: ${response.status}`);
        }
      } catch (error) {
        console.error('Error updating user status:', error);
        showMessage('Error al actualizar estado del usuario: ' + error.message, 'error');
      }
    }

    // Reset user password
    async function resetUserPassword() {
      if (!editingUserId) return;
      
      const newPassword = prompt('Ingrese la nueva contraseña para este usuario:');
      if (!newPassword || newPassword.length < 4) {
        alert('La contraseña debe tener al menos 4 caracteres');
        return;
      }
      
      try {
        showMessage('Reseteando contraseña...', 'info');
        
        const response = await fetch(`https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?id=eq.${editingUserId}`, {
          method: 'PATCH',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ password: newPassword })
        });
        
        if (response.ok) {
          showMessage('✅ Contraseña reseteada exitosamente', 'success');
        } else {
          throw new Error(`Error HTTP: ${response.status}`);
        }
      } catch (error) {
        console.error('Error resetting password:', error);
        showMessage('❌ Error al resetear contraseña: ' + error.message, 'error');
      }
    }

    // Close modal
    function closeModal() {
      document.getElementById('user-modal').style.display = 'none';
      editingUserId = null;
    }

    // Export users to CSV
    function exportUsers() {
      if (users.length === 0) {
        showMessage('No hay usuarios para exportar', 'warning');
        return;
      }
      
      const csvContent = "data:text/csv;charset=utf-8," 
        + "Nombre,Email,Código,Rol,Estado,Teléfono,Género,Créditos,Club,Fecha Nacimiento,Fecha Registro\n"
        + users.map(user => {
          const club = getClubName(user.intereses);
          const registerDate = formatDate(user.creado_en || user.fecha_inscripcion);
          const birthDate = formatDate(user.fecha_nacimiento);
          
          return [
            user.username || '',
            user.email || '',
            user.codigo_usuario || '',
            user.rol || '',
            user.estado || 'activo',
            user.telefono || '',
            user.genero || '',
            user.creditos_obtenidos || '',
            club,
            birthDate,
            registerDate
          ].map(field => `"${field}"`).join(',');
        }).join('\n');
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', `usuarios_gma_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showMessage('✅ Archivo CSV exportado exitosamente', 'success');
    }

    // Handle form submission
    document.getElementById('user-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!editingUserId) return;
      
      const userData = {
        username: document.getElementById('user-username').value,
        email: document.getElementById('user-email').value,
        rol: document.getElementById('user-role').value,
        estado: document.getElementById('user-status').value,
        genero: document.getElementById('user-gender').value,
        telefono: document.getElementById('user-telefono').value,
        creditos_obtenidos: document.getElementById('user-creditos').value,
        fecha_nacimiento: document.getElementById('user-birth-date').value,
        intereses: [document.getElementById('user-club').value]
      };
      
      try {
        showMessage('Actualizando usuario...', 'info');
        
        const response = await fetch(`https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?id=eq.${editingUserId}`, {
          method: 'PATCH',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(userData)
        });
        
        if (response.ok) {
          showMessage('✅ Usuario actualizado exitosamente', 'success');
          closeModal();
          loadUsers();
        } else {
          const errorText = await response.text();
          throw new Error(`Error HTTP: ${response.status} - ${errorText}`);
        }
      } catch (error) {
        console.error('Error updating user:', error);
        showMessage('❌ Error al actualizar usuario: ' + error.message, 'error');
      }
    });

    // Show message function
    function showMessage(message, type) {
      const messageArea = document.getElementById('message-area');
      messageArea.textContent = message;
      messageArea.style.display = 'block';
      
      // Set color based on type
      switch(type) {
        case 'success':
          messageArea.style.background = '#065f46';
          messageArea.style.color = '#10b981';
          messageArea.style.border = '1px solid #10b981';
          break;
        case 'error':
          messageArea.style.background = '#7f1d1d';
          messageArea.style.color = '#ef4444';
          messageArea.style.border = '1px solid #ef4444';
          break;
        case 'info':
          messageArea.style.background = '#1e3a8a';
          messageArea.style.color = '#3b82f6';
          messageArea.style.border = '1px solid #3b82f6';
          break;
        case 'warning':
          messageArea.style.background = '#92400e';
          messageArea.style.color = '#f59e0b';
          messageArea.style.border = '1px solid #f59e0b';
          break;
      }

      // Auto-hide success and info messages
      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          messageArea.style.display = 'none';
        }, 3000);
      }
    }

    // Handle Enter key for admin password
    document.getElementById('admin-password').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        validateAdminAccess();
      }
    });

    // Auto-focus password field
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('admin-password').focus();
      
      // Add event listeners for user action buttons
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('edit-user-btn')) {
          const userId = parseInt(e.target.getAttribute('data-user-id'));
          editUser(userId);
        } else if (e.target.classList.contains('toggle-user-btn')) {
          const userId = parseInt(e.target.getAttribute('data-user-id'));
          const username = e.target.getAttribute('data-username');
          const status = e.target.getAttribute('data-status');
          toggleUserStatus(userId, username, status);
        }
      });
    });
  </script>
</body>

</html>
