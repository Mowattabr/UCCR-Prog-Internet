<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug Profile - Galaxia Magna Academy</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #1a1a1f 0%, #2d2d35 100%);
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #23232b;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.3);
    }
    .debug-section {
      background: #2d2d35;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid #f18b32;
    }
    .btn-primary {
      background: #f18b32;
      border-color: #f18b32;
      font-weight: bold;
    }
    .btn-primary:hover {
      background: #e07a21;
      border-color: #e07a21;
    }
    pre {
      background: #1a1a1f;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="text-center mb-4">
      <h1 style="color: #f18b32;">üîç Debug Profile Data</h1>
      <p class="text-muted">Diagnosticar problemas de coincidencia entre sesi√≥n y base de datos</p>
    </div>

    <div class="debug-section">
      <h4 style="color: #f18b32;">üì± Datos de Sesi√≥n (localStorage)</h4>
      <pre id="session-data">Cargando...</pre>
      <button class="btn btn-primary" onclick="loadSessionData()">üîÑ Recargar Sesi√≥n</button>
    </div>

    <div class="debug-section">
      <h4 style="color: #f18b32;">üóÑÔ∏è B√∫squeda en Base de Datos</h4>
      <div id="search-results">
        <p>Haz clic en los botones para buscar en la base de datos:</p>
      </div>
      <div class="mt-3">
        <button class="btn btn-info me-2" onclick="searchByEmail()">üìß Buscar por Email Sesi√≥n</button>
        <button class="btn btn-info me-2" onclick="searchByAllanEmail()">üìß Buscar Allan Email</button>
        <button class="btn btn-info me-2" onclick="searchByAdminRole()">üëë Buscar Administradores</button>
        <button class="btn btn-info me-2" onclick="searchByCode()">üî¢ Buscar por C√≥digo Allan</button>
        <button class="btn btn-success" onclick="searchAll()">üîç Buscar Todo</button>
      </div>
    </div>

    <div class="debug-section">
      <h4 style="color: #f18b32;">üîß Acciones de Reparaci√≥n</h4>
      <button class="btn btn-warning me-2" onclick="fixSession()">üîÑ Corregir Sesi√≥n con Datos de Allan</button>
      <button class="btn btn-success me-2" onclick="window.open('profile.html', '_blank')">üë§ Ir a Perfil</button>
      <button class="btn btn-secondary" onclick="window.open('index.html', '_blank')">üè† Ir al Inicio</button>
    </div>

  </div>

  <script>
    function loadSessionData() {
      const sessionData = localStorage.getItem('currentUser');
      const sessionElement = document.getElementById('session-data');
      
      if (sessionData) {
        try {
          const parsed = JSON.parse(sessionData);
          sessionElement.textContent = JSON.stringify(parsed, null, 2);
        } catch (e) {
          sessionElement.textContent = 'Error parsing session data: ' + sessionData;
        }
      } else {
        sessionElement.textContent = 'No session data found';
      }
    }

    async function searchByEmail() {
      const sessionData = localStorage.getItem('currentUser');
      if (!sessionData) return;
      
      const session = JSON.parse(sessionData);
      const email = session.email;
      
      await performSearch(`email session: ${email}`, 
        `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email.eq.${encodeURIComponent(email)}`);
    }

    async function searchByAllanEmail() {
      await performSearch('Allan email conocido', 
        'https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email.eq.allan.villalobos.calderon@gmail.com');
    }

    async function searchByAdminRole() {
      await performSearch('administradores', 
        'https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?rol.eq.administrador');
    }

    async function searchByCode() {
      await performSearch('c√≥digo Allan', 
        'https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?codigo_usuario.eq.2025_08_ADM_6774');
    }

    async function searchAll() {
      await searchByEmail();
      await searchByAllanEmail();
      await searchByAdminRole(); 
      await searchByCode();
    }

    async function performSearch(description, url) {
      try {
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Accept': 'application/json'
          }
        });

        const results = await response.json();
        
        const resultsDiv = document.getElementById('search-results');
        resultsDiv.innerHTML += `
          <div style="margin: 10px 0; padding: 15px; background: #1a1a1f; border-radius: 5px;">
            <h6 style="color: #f18b32;">B√∫squeda por ${description}:</h6>
            <pre style="margin: 10px 0;">${JSON.stringify(results, null, 2)}</pre>
            <small style="color: #999;">URL: ${url}</small>
          </div>
        `;
      } catch (error) {
        const resultsDiv = document.getElementById('search-results');
        resultsDiv.innerHTML += `
          <div style="margin: 10px 0; padding: 15px; background: #1a1a1f; border-radius: 5px;">
            <h6 style="color: #ef4444;">Error en b√∫squeda por ${description}:</h6>
            <pre style="margin: 10px 0;">${error.message}</pre>
          </div>
        `;
      }
    }

    function fixSession() {
      const allanData = {
        username: 'Allan VillaLobos Calderon',
        email: 'allan.villalobos.calderon@gmail.com',
        rol: 'administrador',
        codigo: '2025_08_ADM_6774'
      };
      
      localStorage.setItem('currentUser', JSON.stringify(allanData));
      alert('‚úÖ Sesi√≥n actualizada con datos de Allan. Recarga el perfil.');
      loadSessionData();
    }

    // Load session data on page load
    document.addEventListener('DOMContentLoaded', loadSessionData);
  </script>
</body>
</html>
