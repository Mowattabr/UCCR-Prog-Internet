<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üöÄ SIMPLE WORKING PROFILE</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #1a1a1f; color: #fff; padding: 20px; }
    .container { max-width: 800px; background: #23232b; padding: 30px; border-radius: 10px; }
    .field { margin: 20px 0; padding: 15px; background: #2d2d35; border-radius: 8px; }
    .btn-edit { background: #f18b32; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    .btn-save { background: #22c55e; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px; }
    .btn-cancel { background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
    input, select { width: 100%; padding: 8px; margin: 10px 0; background: #1a1a1f; color: white; border: 1px solid #4a4a55; border-radius: 4px; }
    .alert { padding: 15px; margin: 10px 0; border-radius: 5px; }
    .alert-success { background: #22c55e; color: white; }
    .alert-error { background: #ef4444; color: white; }
    .alert-info { background: #3b82f6; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="color: #f18b32; text-align: center;">üöÄ SIMPLE WORKING PROFILE</h1>
    <p style="text-align: center; color: #999;">Direct database connection - No complex logic</p>
    
    <div id="status"></div>

    <!-- Quick Login -->
    <div class="field">
      <h4>Step 1: Quick Login</h4>
      <input type="email" id="login-email" placeholder="Email" value="allan.villalobos.calderon@gmail.com">
      <input type="password" id="login-password" placeholder="Password">
      <button class="btn-save" onclick="quickLogin()">üîê Login & Load Data</button>
    </div>

    <!-- User Data -->
    <div class="field" id="user-section" style="display: none;">
      <h4>Your Profile Data</h4>
      
      <!-- Name -->
      <div style="margin: 15px 0;">
        <label><strong>Name:</strong></label>
        <span id="name-display">Loading...</span>
        <button class="btn-edit" onclick="editField('name')">Edit</button>
        <div id="name-edit" style="display: none;">
          <input type="text" id="name-input">
          <button class="btn-save" onclick="saveField('name', 'username')">Save</button>
          <button class="btn-cancel" onclick="cancelEdit('name')">Cancel</button>
        </div>
      </div>

      <!-- Phone -->
      <div style="margin: 15px 0;">
        <label><strong>Phone:</strong></label>
        <span id="telefono-display">Loading...</span>
        <button class="btn-edit" onclick="editField('telefono')">Edit</button>
        <div id="telefono-edit" style="display: none;">
          <input type="tel" id="telefono-input" placeholder="+506-1234-5678">
          <button class="btn-save" onclick="saveField('telefono', 'telefono')">Save</button>
          <button class="btn-cancel" onclick="cancelEdit('telefono')">Cancel</button>
        </div>
      </div>

      <!-- Gender -->
      <div style="margin: 15px 0;">
        <label><strong>Gender:</strong></label>
        <span id="genero-display">Loading...</span>
        <button class="btn-edit" onclick="editField('genero')">Edit</button>
        <div id="genero-edit" style="display: none;">
          <select id="genero-input">
            <option value="m">Masculino</option>
            <option value="f">Femenino</option>
            <option value="o">Otro</option>
            <option value="n">Prefiero no decir</option>
          </select>
          <button class="btn-save" onclick="saveField('genero', 'genero')">Save</button>
          <button class="btn-cancel" onclick="cancelEdit('genero')">Cancel</button>
        </div>
      </div>

      <!-- Email -->
      <div style="margin: 15px 0;">
        <label><strong>Email:</strong></label>
        <span id="email-display">Loading...</span>
        <button class="btn-edit" onclick="editField('email')">Edit</button>
        <div id="email-edit" style="display: none;">
          <input type="email" id="email-input">
          <button class="btn-save" onclick="saveField('email', 'email')">Save</button>
          <button class="btn-cancel" onclick="cancelEdit('email')">Cancel</button>
        </div>
      </div>

    </div>

    <div style="margin-top: 30px; text-align: center;">
      <a href="index.html" style="color: #f18b32;">‚Üê Back to Login</a> |
      <a href="profile.html" style="color: #f18b32;">Go to Full Profile</a>
    </div>
  </div>

  <script>
    let userData = null;

    function showStatus(message, type = 'info') {
      const status = document.getElementById('status');
      const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-error' : 'alert-info';
      status.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
      
      if (type === 'success') {
        setTimeout(() => status.innerHTML = '', 3000);
      }
    }

    async function quickLogin() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      
      if (!email || !password) {
        showStatus('‚ùå Please enter email and password', 'error');
        return;
      }
      
      showStatus('üîÑ Logging in...', 'info');
      
      try {
        // Search user
        const searchUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email.eq.${encodeURIComponent(email)}`;
        
        const response = await fetch(searchUrl, {
          method: 'GET',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const users = await response.json();
          
          if (users && users.length > 0) {
            const user = users[0];
            
            if (user.password === password) {
              userData = user;
              console.log('‚úÖ Loaded user data:', userData);
              
              showStatus('‚úÖ Login successful! Data loaded.', 'success');
              loadUserProfile();
              document.getElementById('user-section').style.display = 'block';
              
            } else {
              showStatus('‚ùå Wrong password', 'error');
            }
          } else {
            showStatus('‚ùå User not found', 'error');
          }
        } else {
          showStatus('‚ùå Database error: ' + response.status, 'error');
        }
        
      } catch (error) {
        showStatus('‚ùå Connection error: ' + error.message, 'error');
      }
    }

    function loadUserProfile() {
      if (!userData) return;
      
      document.getElementById('name-display').textContent = userData.username || 'Not set';
      document.getElementById('telefono-display').textContent = userData.telefono || 'Not set';
      document.getElementById('email-display').textContent = userData.email || 'Not set';
      
      const genderMap = { 'm': 'Masculino', 'f': 'Femenino', 'o': 'Otro', 'n': 'Prefiero no decir' };
      document.getElementById('genero-display').textContent = genderMap[userData.genero] || 'Not set';
    }

    function editField(fieldName) {
      document.getElementById(`${fieldName}-display`).style.display = 'none';
      document.getElementById(`${fieldName}-edit`).style.display = 'block';
      
      // Set current value
      const input = document.getElementById(`${fieldName}-input`);
      if (fieldName === 'name') {
        input.value = userData.username || '';
      } else if (fieldName === 'genero') {
        input.value = userData.genero || 'n';
      } else {
        input.value = userData[fieldName] || '';
      }
    }

    function cancelEdit(fieldName) {
      document.getElementById(`${fieldName}-display`).style.display = 'inline';
      document.getElementById(`${fieldName}-edit`).style.display = 'none';
    }

    async function saveField(fieldName, dbFieldName) {
      const input = document.getElementById(`${fieldName}-input`);
      const newValue = input.value;
      
      showStatus(`üîÑ Saving ${fieldName}...`, 'info');
      
      try {
        const updateData = {};
        updateData[dbFieldName] = newValue;
        
        console.log('Updating:', updateData, 'for user:', userData.email);
        
        const updateUrl = `https://qjtojggjtouvgljlozwr.supabase.co/rest/v1/lista_usuarios?email.eq.${encodeURIComponent(userData.email)}`;
        
        const response = await fetch(updateUrl, {
          method: 'PATCH',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdG9qZ2dqdG91dmdsamxvendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzAwMjAsImV4cCI6MjA3MDEwNjAyMH0.z1ggcCP5SbU3jvAOXmo8yD22fRBctQt7LI71LZTR7YM',
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify(updateData)
        });
        
        console.log('Update response status:', response.status);
        
        if (response.ok) {
          // Update local data
          userData[dbFieldName] = newValue;
          
          showStatus(`‚úÖ ${fieldName} saved successfully!`, 'success');
          cancelEdit(fieldName);
          loadUserProfile(); // Refresh display
          
        } else {
          const errorText = await response.text();
          console.error('Update failed:', response.status, errorText);
          showStatus(`‚ùå Failed to save ${fieldName}: ${response.status}`, 'error');
        }
        
      } catch (error) {
        console.error('Save error:', error);
        showStatus(`‚ùå Error saving ${fieldName}: ${error.message}`, 'error');
      }
    }
  </script>
</body>
</html>
